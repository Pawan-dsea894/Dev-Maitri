var LoanDisbursementScrId = 'LoanDi__LoanDisbursementList__';
var laonStatusList = []
var customerList = [];
var customerListBasedOnStatus = [];
var custData;
var checked;
var kendraId;
var nextMeetingDate;
var meetingDay;
var userRole;
var rejSelReason;
var onStatusSelect = false;
var totPreCloAmt = 0;
var t24Loans = [];
var t24FinalLoans = [];
var totPreCloAmtFinal = 0;
var today = new Date();
var userRole = window.kmBmRole;
var closedLoans = [],
    preCloseLoans = [],
    avaliableLoans = [],
    closedLoansFinal = [],
    avaliableLoansFinal = [],
    closeAcctNo = [],
    precloseType = "";
var availForPreClos = [];
var productMerged = [];
var hideNshow = ['sc_col_685', 'existingLoan2', 'review2', 'status2', 'confirmDisbur2', 'applicationsDiv', 'loanHeader', 'searchDiv'];
var loanRejectionReasons = ['Invalid document', 'Invalid Address', 'No Address Proof', 'Others'];
var custAgeLimit, spouseAgeLimit, custEligibleWeeks, spouseEligibleWeeks, ageValidation = false;
window.KendraApp.Transpayload = {};
var matchAmount = false;
window.KendraApp.disbursementFlow=''
var btnFiltrLoanSanct = [{
    key: "Branch",
    value: ""
}, {
    key: "Loan",
    value: ""
}, {
    key: "KMs",
    value: ""
}, {
    key: "Kendra Name", // New key for KMname filter
    value: ""
}];
let selectedCheckboxesDisb = [];
let allCheckboxCheckedDisb = {
    row_0: false,
    row_1: false,
    row_2: false
};
var Pagination_Bar = 'pagination-bar';
var PagBtnInp = 'row_acc_pagiButtons :input';
var configLimit = 10;
var optClosureFinal=[];
window.totalPaginationPages = '0';
IncomeApp.isQuestionComplete=false;
var loandisburseEdit=true;
var viewCBReport = false;
apz.app.onLoad_LoanDisbursementList = function(params) {
    custData = params.matchingCustomer;
    // KendraApp.selectedDisbursement=custData;
    if (window.KendraLoans.hasOwnProperty("custFetchLoanAppRes") && window.KendraLoans.custFetchLoanAppRes.hasOwnProperty("applicationdtls")) {
        if (window.KendraLoans.custFetchLoanAppRes.applicationdtls.length > 0) {
            window.accntDetails = window.KendraLoans.custFetchLoanAppRes.applicationdtls[0];
        }
    }
    $('#header').addClass('sno');
    $('#footer').addClass('sno');
    $('#' + LoanDisbursementScrId + 'refId').addClass('sno');
   // CustomerApplications = CustomerApplications.requestObj.applicationdtls;
    $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', '');
    $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', 'apz.app.LoanDisbursementList.moveToBm()');
    /*if (window.kmBmRole === "BM") {
        apz.app.LoanDisbursementList.OnclickPreClosedLoansFinal();
    } else {
        apz.app.LoanDisbursementList.OnclickPreClosedLoans();
    }*/
        custAgeLimit = ApzCOB.GetCommonCodes("AGELIMIT").agelimit.custAgeLimit
        spouseAgeLimit = ApzCOB.GetCommonCodes("AGELIMIT").agelimit.spouseAgeLimit
};
apz.app.onShown_LoanDisbursementList = function(params) {
    custData = params.matchingCustomer;
    if (apz.deviceType === 'WEB' && (userRole === 'BM' && !isSelfAssigned)) {
        $('#' + LoanDisbursementScrId + "gr_col_191").removeClass('sno');
        let element = document.getElementById('LoanDi__LoanDisbursementList__gr_row_68');
        let element_next = document.getElementById('LoanDi__LoanDisbursementList__gr_row_69');
        if (element) {
            element.classList.add('web-disb');
        }
        if (element_next) {
            element_next.classList.remove('mt2');
        }
    }
    if (apz.deviceType === 'WEB' && (userRole === 'BM' && !isSelfAssigned)) {
        $('#' + LoanDisbursementScrId + "gr_col_191").removeClass('sno');
    } else {
        $('#' + LoanDisbursementScrId + "gr_col_191").addClass('sno');
    }
    if (apz.deviceType === 'WEB') {
        $('#LoanDi__LoanDisbursementList__loanDisbPageRow').removeClass('sno');
    } else {
        $('#LoanDi__LoanDisbursementList__loanDisbPageRow').addClass('sno');
    }
    /*userRole = params.currentRole
    if (params.currentRole == "KM") {
        $('#' + LoanDisbursementScrId + "bmFlow1").addClass('sno');
        $('#' + LoanDisbursementScrId + "kmFlow").removeClass('sno');
        hideNshow.show();
        ['loanAmt2', 'stage2', 'stage3', 'successDiv', 'applicationsDiv', 'loanHeader', 'searchDiv'].hide();
        ['stage1', 'status2'].show();
        $('#' + LoanDisbursementScrId + "gr_row_68").removeClass('bm-flow-review');
        apz.app.LoanDisbursementList.paintCustDetails();
        apz.app.LoanDisbursementList.paintExistingLoanDetails();
    } else if (params.currentRole === 'BM' || userRole == "BM" || userRole == "BM2") {
        hideNshow.hide();
        ['loanAmt2', 'stage2', 'vintage', 'bmFlow1', 'kmKYC'].show();
        ['status2', 'kmFlow'].hide();
        if (KendraApp.selectedDisbursement.customerDtls.loanDtls.disburseMode.idDesc === 'NEFT' && userRole === 'BM2') {
            ['bmFlow1', 'kmFlow'].hide();
            ['bmFlow2', 'bmKyc'].show();
        }
        $('#' + LoanDisbursementScrId + "gr_row_68").addClass('bm-flow-review');
        apz.app.LoanDisbursementList.paintReviewDetails()
    }
    if (!(apz.isNull(KendraApp.selectedDisbursement))) {
        if (KendraApp.selectedDisbursement.customerDtls.loanDtls.disburseMode.idDesc === 'CASH') {
            ['bmKyc'].show();
            ['kmKYC'].hide();
            //$('#' + LoanDisbursementScrId + "gr_row_68").addClass('bm-flow-review');
            if (userRole == "") {
                // ['bmKyc'].show();
                ['memberInfo'].show();
            } else {
                ['disbursementMode', 'associatedKM'].show();
                ['memberInfo'].hide();
            }
        } else if (KendraApp.selectedDisbursement.customerDtls.loanDtls.disburseMode.idDesc === 'NEFT') {
            ['bmKyc'].hide();
            ['kmKYC', 'memberInfo'].show();
            //$('#' + LoanDisbursementScrId + "gr_row_68").addClass('bm-flow-review');
            if (userRole === 'BM2') {
                ['bmKyc'].show();
                ['kmKYC'].hide();
            }
        }
    }*/
    
    if (window.KendraLoans.scr === 'LoanDisbursementList' || window.KendraLoans.scr === 'dashboardDisbursement') {
        ['applicationsDiv', 'searchDiv', 'loanHeader'].hide();
        if (window.kmBmRole === "BM" && !isSelfAssigned) {
            matchAmount = false;
            window.KendraApp.amountUpdate = false;
            if (!apz.isNull(KendraLoans.cbResponse.Approved_Loan_Amount)) {
                const appAmount = parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount);
                const customerLoanAmount = parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanAmount);
                const approvedAmount = parseInt(KendraLoans.cbResponse.Approved_Loan_Amount);
                if (appAmount === customerLoanAmount && customerLoanAmount === approvedAmount) {
                    matchAmount = true;
                    $("#LoanDi__LoanDisbursementList__amountchangeRow").addClass('sno');
                } else {
                    $("#LoanDi__LoanDisbursementList__amountchangeRow").removeClass('sno');
                }
            }
            if (!matchAmount) {
                if (!apz.isNull(KendraLoans.cbResponse.Approved_Loan_Amount)) {
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanAmount = KendraLoans.cbResponse.Approved_Loan_Amount;
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount = KendraLoans.cbResponse.Approved_Loan_Amount;
                    var insDet = window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls;
                    var insurAmt = 0;
                    if (insDet.member === 'Y' && insDet.Spouse === 'Y') {
                        insurAmt = KendraLoans.cbResponse.Insurance_Charge_Spouse + KendraLoans.cbResponse.Insurance_Charge_Member;
                        insDet.applicant_insurance_amt = KendraLoans.cbResponse.Insurance_Charge_Member;
                        insDet.spouse_insurance_amt = KendraLoans.cbResponse.Insurance_Charge_Spouse;
                    } else if (insDet.member === 'Y') {
                        insurAmt = KendraLoans.cbResponse.Insurance_Charge_Member;
                        insDet.applicant_insurance_amt = KendraLoans.cbResponse.Insurance_Charge_Member;
                        insDet.spouse_insurance_amt = "";
                    } else if (insDet.Spouse === 'Y') {
                        insurAmt = KendraLoans.cbResponse.Insurance_Charge_Spouse;
                        insDet.applicant_insurance_amt = "";
                        insDet.spouse_insurance_amt = KendraLoans.cbResponse.Insurance_Charge_Spouse;
                    } else {
                        insurAmt = 0;
                        insDet.applicant_insurance_amt = "";
                        insDet.spouse_insurance_amt = "";
                    }
                    var approvedAmt = KendraLoans.cbResponse.Approved_Loan_Amount;
                    insDet.insurCharges = insurAmt;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls = insDet;
                    var aprxloancharges = parseInt((KendraLoans.cbResponse.GST + KendraLoans.cbResponse.Processing_fees_without_GST));
                    var aprxloanchargeswithins = aprxloancharges + insurAmt;
                    var aprxloanamount = ((parseInt(approvedAmt)) - parseInt((KendraLoans.cbResponse.GST + KendraLoans.cbResponse
                        .Processing_fees_without_GST + insurAmt)));
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.loanAmt = KendraLoans.cbResponse
                        .Approved_Loan_Amount;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.GST = KendraLoans.cbResponse.GST;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1 =
                    aprxloanchargeswithins;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.aprxLoanCharges =
                    aprxloancharges;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee = KendraLoans
                        .cbResponse.Processing_fees_without_GST;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.aprxLoanAmt = aprxloanamount;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.iscbUpdated = true;
                    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount = approvedAmt;
                    if(window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.productType == 'EL'){
                        window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.interest_Fee = cbResponse.Interest_Fee;
                         window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.upfront_Fee = cbResponse.Upfront_Fee;
                    }else{
                        window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.interest_Fee = "";
                         window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.upfront_Fee = "";
                    }
                    window.KendraApp.amountUpdate = true;
                    custData = window.KendraLoans.custFetchLoanAppRes.applicationdtls[0];
                }
            }
        }
        apz.app.LoanDisbursementList.paintCustDetails();
    }
    if (window.KendraLoans.scr === 'ViewAll') {
        apz.app.LoanDisbursementList.paintLoanStatus();
        apz.app.LoanDisbursementList.paintCustomerList();
    }
    // if (apz.deviceType === 'WEB' && (userRole === 'BM'&& !isSelfAssigned)) {
    //     $('#LoanDi__LoanDisbursementList__bmWebDocsRow').removeClass('sno');
    // }else if(apz.deviceType === 'WEB'){
    //     $('#LoanDi__LoanDisbursementList__ kfsRow').removeClass('sno');
    //     $('#LoanDi__LoanDisbursementList__ kfsViewCol').addClass('sno');
    // }else{
    //      $('#LoanDi__LoanDisbursementList__ kfsRow').removeClass('sno');
    // }
    if (window.kmBmRole === "BM" && !isSelfAssigned) {
        if (undefined !== custData && custData.hasOwnProperty("status") && custData.status === "DISBURSED") {
            $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass("sno");
        }
        $('#' + LoanDisbursementScrId + 'LoanAmtDevHeader').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'LoanAmtDev').removeClass('sno');
        if (apz.deviceType === 'WEB') {
            $('#LoanDi__LoanDisbursementList__bmDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__bmWebDocs').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__kmDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__kmWebDocs').addClass('sno');
        } else if (apz.deviceType === 'ANDROID') {
            $('#LoanDi__LoanDisbursementList__bmDocs').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__bmWebDocs').removeClass('sno');
             $('#LoanDi__LoanDisbursementList__el_txt_907').addClass('sno');
            $('#LoanDi__LoanDisbursementList__kmDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__kmWebDocs').addClass('sno');
        }
    }
    if (window.kmBmRole === "KM" || isSelfAssigned) {
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass("sno");
        $('#' + LoanDisbursementScrId + 'LoanAmtDevHeader').addClass('sno');
        $('#' + LoanDisbursementScrId + 'LoanAmtDev').addClass('sno');
        if (apz.deviceType === 'WEB') {
            $('#LoanDi__LoanDisbursementList__bmDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__bmWebDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__kmDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__kmWebDocs').removeClass('sno');
        } else if (apz.deviceType === 'ANDROID') {
            $('#LoanDi__LoanDisbursementList__bmDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__bmWebDocs').addClass('sno');
            $('#LoanDi__LoanDisbursementList__kmDocs').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__kmWebDocs').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__sc_col_1479').addClass('sno');
        }
    }
     if (apz.deviceType === 'WEB' && (userRole === 'KM' || isSelfAssigned)) {
        $('#' + LoanDisbursementScrId + "gr_col_191").removeClass('sno');
    }
    // else {
    //     $('#' + LoanDisbursementScrId + "gr_col_191").addClass('sno');
    // }
    // apz.app.LoanDisbursementList.funcPagination();
    // apz.app.LoanDisbursementList.paintLoanStatus();
    // apz.app.LoanDisbursementList.paintCustomerList();
    // ApzCOB.customerNetoffDtls(KendraLoans.custFetchLoanAppRes.applicationdtls[0].branchId, KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerId);
    if (KendraApp.selectedDisbursement && KendraApp.selectedDisbursement.wfStatus === "INITDISBURSE") {
        $('#LoanDi__LoanDisbursementList__ct_frm_117').removeClass('sno');
    } else {
        $('#LoanDi__LoanDisbursementList__ct_frm_117').addClass('sno');
    }
       if (custData && custData.customerDtls && custData.customerDtls.loanDtls && (custData.customerDtls.loanDtls.product ===
        "GL.IGL.PRAGATI.RESTR" || custData.customerDtls.loanDtls.product ==="GL.IGL.PRGTI.RESTR.1Y")) {
        selectAllActiveLoans=false;
        if (KendraLoans.custFetchLoanAppRes && KendraLoans.custFetchLoanAppRes.applicationdtls && KendraLoans.custFetchLoanAppRes.applicationdtls
            .length > 0 && KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls) {
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                if(prod.status !=='CLOSED'){
                    selectAllActiveLoans = true;
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status = 'CLOSED';
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].isCompulsory = true;
                }
            });
            var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
            //KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
            if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.includes('/')) {
                //
            } else {
                KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
            }
            if(selectAllActiveLoans ||isBankDetailsUpdated){
                selectAllActiveLoans = true;
                ApzCOB.saveLoan();    
            }
        } else {
            console.error("Application details or customer details are not available:", KendraLoans.custFetchLoanAppRes);
        }
    }else{
            if (isBankDetailsUpdated) {
                selectAllActiveLoans = true;
                var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
                //KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
                if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.includes('/')) {
                    //
                } else {
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
                }
                ApzCOB.saveLoan();
            }
    }
    if (custData?.customerDtls?.loanDtls?.productId === 'GL.EMERG.LOAN') {
        //$("#" + LoanDisbursementScrId + "sc_col_1429").addClass("sno");
        //apz.setElmValue(LoanDisbursementScrId + "el_txt_868",'DOWNLOAD KFS');
    }else{
        //$("#" + LoanDisbursementScrId + "sc_col_1429").removeClass("sno");
    }
    loandisburseEdit=ApzCOB.GetCommonCodes("LOANEDIT").loanEdit.BMdisbursement;
    if(!loandisburseEdit){
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass('sno');
    }
    var crtEdit=ApzCOB.GetCommonCodes("LOANEDIT").loanEdit;
    if(!crtEdit.CRT.Edit){
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass('sno');
    }
};
apz.app.LoanDisbursementList.selectAllActiveLoans = function() {
    var tempActiveLoan = [];
    if (window.kmBmRole === "KM" || isSelfAssigned) {
        tempActiveLoan = t24Loans;
    } else if (window.kmBmRole === "BM" && !isSelfAssigned) {
        tempActiveLoan = t24FinalLoans;
    }
    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls = [];
    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls = tempActiveLoan;
    return KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.some(item => item.status === 'DISBURSED');
}
apz.app.LoanDisbursementList.paintLoanStatus = function() {
    /*var status = [];
    CustomerApplications.forEach(function(el, i) {
        if (!(status.includes(CustomerApplications[i].status))) {
            CustomerApplications[i].loanStatus = CustomerApplications[i].status
            laonStatusList.push(CustomerApplications[i]);
            status.push(CustomerApplications[i].status);
        }
    })
    laonStatusList.unshift({
        loanStatus: "All Applications"
    })*/
    // var loanStatus = [{
    //     key: "All Applications",
    //     value: ""
    // }, {
    //     key: "Pending",
    //     value: ""
    // }, {
    //     key: "Disbursed",
    //     value: ""
    // }, {
    //     key: "Reject",
    //     value: ""
    // }];
    var loanStatus = [],
        status = [];
    disbursementList.forEach(function(el, i) {
        if (!(status.includes(disbursementList[i].status))) {
            var obj = {
                status: disbursementList[i].status
            }
            loanStatus.push(obj);
            status.push(disbursementList[i].status);
        }
        if (el.customerName) {
            disbursementList[i].profileName = el.customerName.substr(0, 1);
        }
    })
    loanStatus.unshift({
        status: "All Applications"
    })
    if (loanStatus.length > 0) {
        apz.data.scrdata.LoanDi__LoanStatusList_Res = {};
        apz.data.scrdata.LoanDi__LoanStatusList_Res = loanStatus;
        apz.data.loadData("LoanStatusList", 'LoanDi');
        $('#LoanDi__LoanStatusList__o__LoanDi__LoanStatusList_Res__status_0').addClass('active');
        $("#LoanDi__LoanStatusList__o__LoanStatus__loanStatus_0").addClass('active');
    }
}
apz.app.LoanDisbursementList.paintCustomerList = function() {
    /*CustomerApplications.forEach(function(el, index) {
        CustomerApplications[index].custName = CustomerApplications[index].customerDtls.customerName
        CustomerApplications[index].kendraName = CustomerApplications[index].kendraName ? CustomerApplications[index].kendraName : '-'
        CustomerApplications[index].kendraId = CustomerApplications[index].kendraId
        CustomerApplications[index].status = CustomerApplications[index].customerDtls.loanDtls.disburseMode.idDesc
        CustomerApplications[index].amount = CustomerApplications[index].customerDtls.loanDtls.chargeAndBreakupDtls.loanAmt
        CustomerApplications[index].product = 'IGL'
        customerList.push(CustomerApplications[index]);
    })*/
    if (disbursementList.length > 0) {
        apz.data.scrdata.LoanDi__CustomersList_Res = {};
        apz.data.scrdata.LoanDi__CustomersList_Res.Customer = disbursementList;
        if (apz.deviceType === 'WEB') {
            apz.app.LoanDisbursementList.funcPagination(disbursementList);
        } else {
            apz.data.loadData("CustomersList", 'LoanDi');
        }
        // apz.data.loadData("CustomersList", 'LoanDi');
    }
    apz.app.LoanDisbursementList.loadcrtData('Customer');
    pendingData = disbursementList.filter(d => d.status === 'Pending')
    apz.setElmValue(LoanDisbursementScrId + "listCount", pendingData.length + '/' + disbursementList.length);
}
// apz.app.LoanDisbursementList.paintCustomerList = function() {
//     if (disbursementList && disbursementList.length > 0) {
//         apz.data.scrdata.LoanDi__CustomersList_Res = {};
//         apz.data.scrdata.LoanDi__CustomersList_Res.Customer = disbursementList;
//           apz.setElmValue(LoanDisbursementScrId + "listCount", disbursementList.length + '/' + disbursementList.length);
//           apz.app.LoanDisbursementList.funcPagination(disbursementList);
//     } else {
//         console.warn("Disbursement list is empty or not yet populated.");
//         return;
//     }
// }
// apz.app.LoanDisbursementList.onClickSelectedCustomer = function(pthis) {
//     // ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage2', 'stage3', 'successDiv'].hide();
//     // ['stage1'].show();
//     let rowNo = $(pthis).attr('rowno');
//     if (onStatusSelect) {
//         KendraApp.selectedDisbursement = customerListBasedOnStatus[rowNo];
//     } else {
//         KendraApp.selectedDisbursement = disbursementList[rowNo];
//     }
//     // KendraApp.selectedDisbursement.applicationId = '910828693761';
//     // KendraApp.selectedDisbursement.versionNum = '2'
//     ApzCOB.fetchLoanApplication(KendraApp.selectedDisbursement, 'LoanDisbursementList');
//     /*custData = KendraApp.selectedDisbursement;*/
//     //custFetchLoanAppRes    -->Use this FetchLoanApplication response
//     /*apz.app.LoanDisbursementList.paintCustDetails();*/
//     //apz.app.LoanDisbursementList.paintExistingLoanDetails();
//     //$('#' + LoanDisbursementScrId + 'refId').removeClass('sno');
// }
apz.app.LoanDisbursementList.onClickSelectedCustomer = function(pthis) {
    let rowNo = $(pthis).attr('rowno');
    let selectedList = apz.data.scrdata.LoanDi__CustomersList_Res.Customer;
    KendraApp.selectedDisbursement = selectedList[rowNo];
    ApzCOB.fetchLoanApplication(KendraApp.selectedDisbursement, 'LoanDisbursementList');
}
apz.app.LoanDisbursementList.paintCustDetails = function(params) {
    //custData = params.matchingCustomer;
    if (custData.kendraId.includes('#')) {
        kendraId = custData.kendraId.split('#')[1];
    } else {
        kendraId = custData.kendraId;
    }
    KendraApp.KendraResponse.forEach(function(el, i) {
        if (KendraApp.KendraResponse[i].kendraDtls.kendraId === parseInt(kendraId)) {
            nextMeetingDate = KendraApp.KendraResponse[i].kendraDtls.nextMeetingDate;
            meetingDay = KendraApp.KendraResponse[i].kendraDtls.meetingDay;
        }
    })
    apz.setElmValue(LoanDisbursementScrId + "refId1", custData.applicationId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "refId2", custData.applicationId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "refId3", custData.applicationId ?? 'NO DATA');
    if ((window.userRole === "KM" || isSelfAssigned) && KendraApp.selectedDisbursement.wfStatus !== 'DISBURSED') {
        apz.setElmValue(LoanDisbursementScrId + "custName", custData.customerDtls.customerName ?? 'NO DATA');
        apz.setElmValue(LoanDisbursementScrId + "image", custData.customerDtls.customerName.slice(0, 1));
        apz.setElmValue(LoanDisbursementScrId + "kendraId", custData.kendraId ?? 'NO DATA');
        apz.setElmValue(LoanDisbursementScrId + "kendraName", custData.kendraName ?? 'NO DATA');
        // apz.setElmValue(LoanDisbursementScrId + "groupID", JSON.parse(custData.addInfo).groupId ?? 'NO DATA');
        apz.setElmValue(LoanDisbursementScrId + "groupID",typeof custData?.addInfo === "string"? (JSON.parse(custData.addInfo)?.groupId ?? "NO DATA"): (custData?.addInfo?.groupId ?? "NO DATA"));
        apz.setElmValue(LoanDisbursementScrId + "custStatus", custData.loanMode ?? 'NO DATA');
        ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage2', 'stage3', 'successDiv'].hide();
        ['stage1'].show();
        apz.app.LoanDisbursementList.paintExistingLoanDetails();
    } else { // BM Final Disbursment Flow
        hideNshow.hide();
        apz.app.LoanDisbursementList.paintReviewDetails();
        $('#' + LoanDisbursementScrId + 'preCloseExistLoans').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'availPreCloseLoans').removeClass('sno');
        ['loanAmt2', 'stage2', 'vintage', 'bmFlow1', 'kmKYC'].show();
        ['status2', 'kmFlow'].hide();
        apz.app.LoanDisbursementList.paintExistingLoanFinalDetails();
    }
    var addinfo = custData.addInfo;
    if (typeof addinfo == 'string') {
        addinfo = JSON.parse(addinfo)
    }
    if (apz.isNull(addinfo.isApprovedCRT)) {
        $('#LoanDi__LoanDisbursementList__crtFlagDet').addClass('sno');
    } else {
        if (addinfo.isApprovedCRT) {
            // console.log('true'); 
            $('#LoanDi__LoanDisbursementList__crtFlagDet').removeClass('sno');
        } else {
            $('#LoanDi__LoanDisbursementList__crtFlagDet').addClass('sno');
        }
    }
    if (userRole == 'KM' ||userRole == 'BM') {
        $('#LoanDi__LoanDisbursementList__houseHoldview').addClass('sno');
        if (typeof addinfo.isQuestionComplete === "undefined") {
             IncomeApp.isQuestionComplete=true;
            $('#LoanDi__LoanDisbursementList__houseHoldRowKM').addClass('sno');
            $('#LoanDi__LoanDisbursementList__houseHoldRowBM').addClass('sno');
        } else {
            if (addinfo.isQuestionComplete == 'Update' || addinfo.isQuestionComplete == 'Insert') {
                // console.log('true'); 
                IncomeApp.isQuestionComplete=true;
                $('#LoanDi__LoanDisbursementList__houseHoldRowKM').addClass('sno');
                $('#LoanDi__LoanDisbursementList__houseHoldRowBM').addClass('sno');
            } else {
                IncomeApp.isQuestionComplete = false
                if (userRole == 'KM') {
                    if (KendraApp.selectedDisbursement.wfStatus === 'DISBURSEINPROGRESS') {
                        //$('#LoanDi__LoanDisbursementList__houseHoldRowBM').removeClass('sno'); 
                        $('#LoanDi__LoanDisbursementList__houseHoldview').removeClass('sno');
                    } else {
                        $('#LoanDi__LoanDisbursementList__houseHoldRowKM').removeClass('sno');
                    }
                } else if (userRole == 'BM') {
                    if (KendraApp.selectedDisbursement.wfStatus === 'DISBURSEINPROGRESS') {
                        $('#LoanDi__LoanDisbursementList__houseHoldRowBM').removeClass('sno');
                    }
                }
                $('#LoanDi__LoanDisbursementList__houseHoldRowKM').removeClass('sno');
                // $('#LoanDi__LoanDisbursementList__houseHoldRowBM').removeClass('sno');
            }
        }
    }
}
apz.app.LoanDisbursementList.paintExistingLoanFinalDetails = function() {
    closedLoansFinal = [];
    avaliableLoansFinal = [];
    totPreCloAmtFinal = 0;
    t24FinalLoans = [];
    var loans = custData.customerDtls.loanDtls.activeLoanDtls;
    KendraLoans.custNetoffDetails.forEach(function(ele, i) {
        var isMatched = false;
        var obj = {};
        loans.forEach(function(el, j) {
            if (ele.accountId === el.loanId) {
                isMatched = true;
                obj.status = el.status;
                obj.customerId = el.customerId;
                obj.approvedAmt = el.approvedAmt;
                obj.freq = el.freq;
                obj.term = el.term;
                if(!apz.isNull(el.isCompulsory)){
                   obj.isCompulsory = el.isCompulsory;  
                }
                obj.lnValueDate = el.lnValueDate;
                obj.interestRate = el.interestRate;
                obj.overduePrincipal = ele.overdueAmt;
                obj.overdueInterest = "";
                obj.overDueStatus = el.overDueStatus;
                obj.productType = el.productType;
                obj.shortDesc = el.shortDesc;
                obj.description = el.description;
                obj.loanId = ele.accountId;
                obj.amount = ele.amount;
                obj.product = ele.product;
                obj.lnMatDate = ele.maturityDate;
                obj.outstandingPrincipal = ele.principalAmt;
                obj.productId = ele.product;
                obj.maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(ele.maturityDate), "dd/mm/yy")
            }
        })
        if (!isMatched) {
            let tempArray = KendraApp.ProductList.filter(val => (val.productDtls.productId === ele.product));
            obj.status = "DISBURSED";
            obj.customerId = KendraLoans.cbResponse.Customer_id;
            obj.approvedAmt = KendraLoans.cbResponse.Approved_Loan_Amount.toString();
            obj.freq = "";
            obj.term = "";
            obj.isCompulsory = false;
            obj.lnValueDate = "";
            obj.interestRate = "";
            obj.overduePrincipal = ele.overdueAmt;
            obj.overdueInterest = "";
            obj.overDueStatus = "";
            obj.productType = tempArray[0].productDtls.productType;
            obj.shortDesc = tempArray[0].productDtls.shortDesc;
            obj.description = tempArray[0].productDtls.description;
            obj.loanId = ele.accountId;
            obj.amount = ele.amount;
            obj.product = ele.product;
            obj.lnMatDate = ele.maturityDate;
            obj.outstandingPrincipal = ele.principalAmt;
            obj.productId = ele.product;
            obj.maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(ele.maturityDate), "dd/mm/yy")
        }
        t24FinalLoans.push(obj);
    })
    loans = t24FinalLoans;
    loans.forEach(function(ele, i) {
        if (loans[i].status === "CLOSED") {
            totPreCloAmtFinal = totPreCloAmtFinal + parseInt(ele.amount)
            loans[i].amount = ApzCOB.fn_FormatAmount(parseInt(ele.amount))
            loans[i].productType = ele.shortDesc
            loans[i].maturingOn = ele.maturityDate;
            closedLoansFinal.push(loans[i])
        } else if (loans[i].status === "DISBURSED") {
            totPreCloAmtFinal = totPreCloAmtFinal + parseInt(ele.overduePrincipal)
            loans[i].amount = ApzCOB.fn_FormatAmount(parseInt(ele.amount))
            loans[i].productType = ele.shortDesc
            loans[i].maturingOn = ele.maturityDate;
            avaliableLoansFinal.push(loans[i])
        }
    })
    apz.data.scrdata.LoanDi__ExistingLoansFinal_Res = {};
    if (closedLoansFinal.length > 0) {
        apz.data.scrdata.LoanDi__ExistingLoansFinal_Res.LoansPreClosedBefore = closedLoansFinal;
        apz.data.loadData("ExistingLoansFinal", 'LoanDi');
        
        if (custData && custData.customerDtls && custData.customerDtls.loanDtls && (custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" ||
                custData.customerDtls.loanDtls.product === "GL.IGL.PRGTI.RESTR.1Y")) {
            closedLoansFinal.forEach(function(j, k) {
                var pthis = '#LoanDi__LoanDisbursementList__el_cbx_21_' + k;
                $(pthis).attr('disabled', 'disabled');
                $(pthis).removeAttr('onclick');
            });
        } else {
            if (!apz.isNull(closedLoansFinal[0].isCompulsory)) {
                closedLoansFinal.forEach(function(j, k) {
                    var pthis = '#LoanDi__LoanDisbursementList__el_cbx_21_' + k;
                    if (!apz.isNull(j.isCompulsory)) {
                        if (j.isCompulsory) {
                            $(pthis).attr('disabled', 'disabled');
                            $(pthis).removeAttr('onclick');
                        } else {
                            $(pthis).removeAttr('disabled');
                            $(pthis).attr('onclick', 'apz.app.LoanDisbursementList.onclickOptClosureLoanChexkBox(this)');
                            $(pthis).parent().closest('li').removeClass('chk-dsbl');
                        }
                    }
                });
            }
        }
        $('#' + LoanDisbursementScrId + 'preClosedLoansFinal').removeClass('sno');
    } else {
        ['noRecord3'].show();
        $('#' + LoanDisbursementScrId + 'noRecord33').removeClass('sno');
    }
    optClosureFinal=JSON.parse(JSON.stringify(closedLoansFinal));
    if (avaliableLoansFinal.length > 0) {
        apz.data.scrdata.LoanDi__ExistingLoansFinal_Res.AvailableForPreClosure = avaliableLoansFinal;
        apz.data.loadData("ExistingLoansFinal", 'LoanDi');
        if (custData && custData.customerDtls && custData.customerDtls.loanDtls && (custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" ||
                custData.customerDtls.loanDtls.product === "GL.IGL.PRGTI.RESTR.1Y")) {
            avaliableLoansFinal.forEach(function(j, k) {
                var pthis = '#LoanDi__LoanDisbursementList__el_cbx_22_' + k;
                $(pthis).trigger('click')
                $(pthis).attr('disabled', 'disabled');
                $(pthis).removeAttr('onclick');
            });
        }
    } else {
        ['noRecord4'].show();
        $('#' + LoanDisbursementScrId + 'noRecord44').removeClass('sno');
    }
    if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmtFinal) {
        $('#LoanDi__LoanDisbursementList__preclosureAmtChk').removeClass('sno');
        //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', true);
        $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', true);
    } else {
        $('#LoanDi__LoanDisbursementList__preclosureAmtChk').addClass('sno');
        //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', false);
        $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', false);
    }
    apz.app.LoanDisbursementList.updateFinalAmt();
}
apz.app.LoanDisbursementList.onclickOptClosureLoanChexkBoxKM = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    if ($('#' + LoanDisbursementScrId + 'el_cbx_16_' + rowNo).prop('checked') === true) {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (closedLoans[rowNo].loanId === el.accountId) {
                totPreCloAmt = totPreCloAmt + parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmt) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', true);
        } else {
            optClosureFinal[rowNo].status = "CLOSED";
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').addClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', false);
        }
    } else {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (closedLoans[rowNo].loanId === el.accountId) {
                totPreCloAmt = totPreCloAmt - parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmt) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', true);
        } else {
            optClosureFinal[rowNo].status = "DISBURSED";
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').addClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', false);
        }
    }
};
apz.app.LoanDisbursementList.onclickOptClosureLoanChexkBox = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    if ($('#' + LoanDisbursementScrId + 'el_cbx_21_' + rowNo).prop('checked') === true) {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (closedLoansFinal[rowNo].loanId === el.accountId) {
                totPreCloAmtFinal = totPreCloAmtFinal + parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmtFinal) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').removeClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', true);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', true);
        } else {
            optClosureFinal[rowNo].status = "CLOSED";
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').addClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', false);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', false);
        }
        closedLoansFinal.forEach(function(loan, i) {
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                if (prod.loanId == closedLoansFinal[rowNo].loanId) {
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status = 'CLOSED';
                }
            });
        });
    } else {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (closedLoansFinal[rowNo].loanId === el.accountId) {
                totPreCloAmtFinal = totPreCloAmtFinal - parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmtFinal) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').removeClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', true);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', true);
        } else {
            optClosureFinal[rowNo].status = "DISBURSED";
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').addClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', false);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', false);
        }
        closedLoansFinal.forEach(function(loan, i) {
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                if (prod.loanId == closedLoansFinal[rowNo].loanId) {
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status =
                        'DISBURSED';
                }
            });
        });
    }
    apz.app.LoanDisbursementList.updateFinalAmt();
};
apz.app.LoanDisbursementList.onclickPreClosureLoanCheckBoxFinal = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    if ($('#' + LoanDisbursementScrId + 'el_cbx_22_' + rowNo).prop('checked') === true) {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (avaliableLoansFinal[rowNo].loanId === el.accountId) {
                totPreCloAmtFinal = totPreCloAmtFinal + parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmtFinal) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').removeClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', true);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', true);
        } else {
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').addClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', false);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', false);
        }
		avaliableLoansFinal.forEach(function(loan, i) {
		   
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                if (prod.loanId == avaliableLoansFinal[rowNo].loanId) {
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status = 'CLOSED';
                }
            });
        });
    } else {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (avaliableLoansFinal[rowNo].loanId === el.accountId) {
                totPreCloAmtFinal = totPreCloAmtFinal - parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmtFinal) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').removeClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', true);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', true);
        } else {
            $('#LoanDi__LoanDisbursementList__preclosureAmtChk').addClass('sno');
            //$('#LoanDi__LoanDisbursementList__el_btn_55').attr('disabled', false);
            $('#LoanDi__LoanDisbursementList__el_btn_56').attr('disabled', false);
        }
		avaliableLoansFinal.forEach(function(loan, i) {
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                if (prod.loanId == avaliableLoansFinal[rowNo].loanId) {
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status = 'DISBURSED';
                }
            });
        });
    }
	apz.app.LoanDisbursementList.updateFinalAmt();
	
};
apz.app.LoanDisbursementList.OnclickPreClosedLoansFinal = function() {
    var preClosedLoan = $('#' + LoanDisbursementScrId + 'preClosedLoansFinal');
    var noRecord = $('#' + LoanDisbursementScrId + 'noRecord33');
    if (closedLoansFinal.length > 0) {
        if ((preClosedLoan).hasClass('sno')) {
            $('#' + LoanDisbursementScrId + 'preClosedLoansFinal').removeClass('sno');
        } else {
            $('#' + LoanDisbursementScrId + 'preClosedLoansFinal').addClass('sno');
        }
    } else {
        if ((noRecord).hasClass('sno')) {
            $('#' + LoanDisbursementScrId + 'noRecord33').removeClass('sno');
        } else {
            $('#' + LoanDisbursementScrId + 'noRecord33').addClass('sno');
        }
    }
}
apz.app.LoanDisbursementList.paintExistingLoanDetails = function() {
    closedLoans = [];
    avaliableLoans = [];
    totPreCloAmt = 0;
    t24Loans = [];
    var loans = custData.customerDtls.loanDtls.activeLoanDtls;
    KendraLoans.custNetoffDetails.forEach(function(ele, i) {
        var isMatched = false;
        var obj = {};
        loans.forEach(function(el, j) {
            if (ele.accountId === el.loanId) {
                isMatched = true;
                obj.status = el.status;
                obj.customerId = el.customerId;
                obj.approvedAmt = el.approvedAmt;
                obj.freq = el.freq;
                obj.term = el.term;
                if (!apz.isNull(el.isCompulsory)) {
                    obj.isCompulsory = el.isCompulsory;
                }
                obj.lnValueDate = el.lnValueDate;
                obj.interestRate = el.interestRate;
                obj.overduePrincipal = ele.overdueAmt;
                obj.overdueInterest = "";
                obj.overDueStatus = el.overDueStatus;
                obj.productType = el.productType;
                obj.shortDesc = el.shortDesc;
                obj.description = el.description;
                obj.loanId = ele.accountId;
                obj.amount = ele.amount;
                obj.product = ele.product;
                obj.lnMatDate = ele.maturityDate;
                obj.outstandingPrincipal = ele.principalAmt;
                obj.productId = ele.product;
                obj.maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(ele.maturityDate), "dd/mm/yy")
            }
        })
        if (!isMatched) {
            let tempArray = KendraApp.ProductList.filter(val => (val.productDtls.productId === ele.product));
            obj.status = "DISBURSED";
            obj.customerId = KendraLoans.cbResponse.Customer_id;
            obj.approvedAmt = KendraLoans.cbResponse.Approved_Loan_Amount.toString();
            obj.freq = "";
            obj.term = "";
            obj.isCompulsory = false;
            obj.lnValueDate = "";
            obj.interestRate = "";
            obj.overduePrincipal = ele.overdueAmt;
            obj.overdueInterest = "";
            obj.overDueStatus = "";
            obj.productType = tempArray[0].productDtls.productType;
            obj.shortDesc = tempArray[0].productDtls.shortDesc;
            obj.description = tempArray[0].productDtls.description;
            obj.loanId = ele.accountId;
            obj.amount = ele.amount;
            obj.product = ele.product;
            obj.lnMatDate = ele.maturityDate;
            obj.outstandingPrincipal = ele.principalAmt;
            obj.productId = ele.product;
            obj.maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(ele.maturityDate), "dd/mm/yy")
        }
        t24Loans.push(obj);
    })
    loans = t24Loans;
    loans.forEach(function(ele, i) {
        if (loans[i].status === "CLOSED") {
            totPreCloAmt = totPreCloAmt + parseInt(ele.amount);
            loans[i].amount = ApzCOB.fn_FormatAmount(parseInt(ele.amount));
            loans[i].productType = ele.shortDesc;
            loans[i].maturingOn = loans[i].maturityDate;
            closedLoans.push(loans[i]);
        } else if (loans[i].status === "DISBURSED") {
            totPreCloAmt = totPreCloAmt + parseInt(ele.overduePrincipal);
            loans[i].amount = ApzCOB.fn_FormatAmount(parseInt(ele.amount));
            loans[i].productType = ele.shortDesc;
            loans[i].maturingOn = loans[i].maturityDate;
            avaliableLoans.push(loans[i])
        }
    })
    apz.data.scrdata.LoanDi__ExistingLoans_Res = {};
    if (closedLoans.length > 0) {
        apz.data.scrdata.LoanDi__ExistingLoans_Res.LoansPreClosedBefore = closedLoans;
        apz.data.loadData("ExistingLoans", 'LoanDi');
        $('#' + LoanDisbursementScrId + 'preClosedLoans').removeClass('sno');
        if (custData && custData.customerDtls && custData.customerDtls.loanDtls && (custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" ||
                custData.customerDtls.loanDtls.product === "GL.IGL.PRGTI.RESTR.1Y")) {
            closedLoans.forEach(function(j, k) {
                var pthis = '#LoanDi__LoanDisbursementList__el_cbx_16_' + k;
                $(pthis).attr('disabled', 'disabled');
                $(pthis).removeAttr('onclick');
            });
        } else {
            if (!apz.isNull(closedLoans[0].isCompulsory)) {
                closedLoans.forEach(function(j, k) {
                    var pthis = '#LoanDi__LoanDisbursementList__el_cbx_16_' + k;
                    if (j.isCompulsory) {
                        $(pthis).attr('disabled', 'disabled');
                        $(pthis).removeAttr('onclick');
                    } else {
                        $(pthis).removeAttr('disabled');
                        $(pthis).attr('onclick', 'apz.app.LoanDisbursementList.onclickOptClosureLoanChexkBoxKM(this)');
                        $(pthis).parent().closest('li').removeClass('chk-dsbl');
                    }
                });
            }
        }
    }else {
        ['noRecord1'].show();
        $('#' + LoanDisbursementScrId + 'noRecord11').removeClass('sno');
    }
    optClosureFinal=JSON.parse(JSON.stringify(closedLoans));
    if (avaliableLoans.length > 0) {
        apz.data.scrdata.LoanDi__ExistingLoans_Res.AvailableForPreClosure = avaliableLoans;
        apz.data.loadData("ExistingLoans", 'LoanDi');
        if (custData && custData.customerDtls && custData.customerDtls.loanDtls && (custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" ||
                custData.customerDtls.loanDtls.product === "GL.IGL.PRGTI.RESTR.1Y")) {
            avaliableLoans.forEach(function(j, k) {
                var pthis = '#LoanDi__LoanDisbursementList__el_cbx_12_' + k;
                $(pthis).trigger('click')
                $(pthis).attr('disabled', 'disabled');
                $(pthis).removeAttr('onclick');
            });
        }
    } else {
        ['noRecord2'].show();
        $('#' + LoanDisbursementScrId + 'noRecord22').removeClass('sno');
    }
    if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmt) {
        $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').removeClass('sno');
        $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', true);
    } else {
        $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').addClass('sno');
        $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', false);
    }   
    if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].productType === 'EL') {
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].loanMode === 'NEFT PAYMENT SUCCESSFUL'||KendraLoans.custFetchLoanAppRes.applicationdtls[0].loanMode ==='IN BRANCH') {
            $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").removeClass("sno");
        } else {
            $("#LoanDi__LoanDisbursementList__gr_row_170").addClass("sno");
            $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass("sno");
        }
    } else {
        $("#LoanDi__LoanDisbursementList__gr_row_170").removeClass("sno");
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").removeClass("sno");
    }
    if(!loandisburseEdit){
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass('sno');
    }
    var crtEdit=ApzCOB.GetCommonCodes("LOANEDIT").loanEdit;
    if(!crtEdit.CRT.Edit){
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass('sno');
    }
};
apz.app.LoanDisbursementList.onclickPreClosureLoanCheckBox = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    let preClosure = [];
    avaliableLoans.forEach((item, index) => {
        if ($('#' + LoanDisbursementScrId + 'el_cbx_12_' + index).prop('checked') === true) {
            preClosure.push(item.productType);
        }
    });
    availForPreClos = preClosure;
    if ($('#' + LoanDisbursementScrId + 'el_cbx_12_' + rowNo).prop('checked') === true) {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (avaliableLoans[rowNo].loanId === el.accountId) {
                totPreCloAmt = totPreCloAmt + parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmt) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', true);
        } else {
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').addClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', false);
        }
    } else {
        KendraLoans.custNetoffDetails.forEach(function(el, i) {
            if (avaliableLoans[rowNo].loanId === el.accountId) {
                totPreCloAmt = totPreCloAmt - parseInt(el.principalAmt)
            }
        })
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount < totPreCloAmt) {
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').removeClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', true);
        } else {
            $('#LoanDi__LoanDisbursementList__preclosureAmtCheck').addClass('sno');
            $('#LoanDi__LoanDisbursementList__el_btn_36').attr('disabled', false);
        }
    }
};
apz.app.LoanDisbursementList.OnclickPreClosedLoans = function() {
    var preClosedLoan = $('#' + LoanDisbursementScrId + 'preClosedLoans');
    var noRecord = $('#' + LoanDisbursementScrId + 'noRecord11');
    if (closedLoans.length > 0) {
        if ((preClosedLoan).hasClass('sno')) {
            $('#' + LoanDisbursementScrId + 'preClosedLoans').removeClass('sno');
        } else {
            $('#' + LoanDisbursementScrId + 'preClosedLoans').addClass('sno');
        }
    } else {
        if ((noRecord).hasClass('sno')) {
            $('#' + LoanDisbursementScrId + 'noRecord11').removeClass('sno');
        } else {
            $('#' + LoanDisbursementScrId + 'noRecord11').addClass('sno');
        }
    }
}
apz.app.LoanDisbursementList.confirmStage1 = function() {
    ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage1', 'stage3', 'successDiv'].hide();
    ['stage2'].show();
    if (avaliableLoans.length == 0) {
        apz.app.LoanDisbursementList.paintReviewDetails();
    } else {
        KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls = [];
        KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls = t24Loans;
        avaliableLoans.forEach(function(loan, i) {
            if ($('#' + LoanDisbursementScrId + 'el_cbx_12_' + i).prop('checked') === true) {
                selectedPreclosureKMInit = true;
                KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                    if (prod.productId == loan.productId) {
                        KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status =
                            'CLOSED';
                    }
                });
            }
        });
        if (optClosureFinal.length !== 0) {
            optClosureFinal.forEach(function(loan, i) {
                if (loan.status == 'DISBURSED') {
                    selectedPreclosureKMInit = true;
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                        if (prod.productId == loan.productId) {
                            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status = 'DISBURSED';
                        }
                    });
                }
            });
        }
        if (selectedPreclosureKMInit) {
            var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
            //KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
            if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.includes('/')) {
                //
            } else {
                KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
            }
            ApzCOB.saveLoan();
        } else {
            apz.app.LoanDisbursementList.paintReviewDetails();
        }
    }
    if (window.kmBmRole === "KM" || isSelfAssigned) {
        $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass("sno");
    }
}
apz.app.LoanDisbursementList.paintReviewDetails = function() {
    var insurFor
    window.customerMobNum = custData.customerDtls.mobileNum;
    if (custData.customerDtls.loanDtls.insurDtls.member === 'Y' && custData.customerDtls.loanDtls.insurDtls.Spouse === 'Y') {
        insurFor = 'Member & Spouse'
    } else if (custData.customerDtls.loanDtls.insurDtls.member === 'Y') {
        insurFor = 'Member'
    } else if (custData.customerDtls.loanDtls.insurDtls.Spouse === 'Y') {
        insurFor = 'Spouse'
    }
    let loanForPreClosure = [];
    closedLoans.forEach(function(el, i) {
        loanForPreClosure.push(closedLoans[i].productType ?? 'NO DATA');
    });
    productMerged = (`${loanForPreClosure} ${availForPreClos}`);
    var totalOutstandingAmt = 0;
    custData.customerDtls.loanDtls.activeLoanDtls.forEach(function(el, i) {
        if (el.status !== 'CLOSED') {
            totalOutstandingAmt = totalOutstandingAmt + parseInt(el.outstandingPrincipal)
        }
    });
    apz.setElmValue(LoanDisbursementScrId + "outstandingAmt", " " + ApzCOB.fn_FormatAmount(totalOutstandingAmt) ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "revieCustName", custData.customerDtls.customerName ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "reviewImg", custData.customerDtls.customerName.slice(0, 1));
    apz.setElmValue(LoanDisbursementScrId + "reviekendraId", custData.kendraId);
    apz.setElmValue(LoanDisbursementScrId + "reviekendraName", custData.kendraName ?? 'NO DATA');
    // apz.setElmValue(LoanDisbursementScrId + "revieGroupID", JSON.parse(custData.addInfo).groupId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "revieGroupID",typeof custData?.addInfo === "string"? (JSON.parse(custData.addInfo)?.groupId ?? "NO DATA"): (custData?.addInfo?.groupId ?? "NO DATA"));
    apz.setElmValue(LoanDisbursementScrId + "revieCustStatus", custData.loanMode ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "loanAmount", custData.amount ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "product", custData.customerDtls.loanDtls.shortDesc ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "purpose", (custData.customerDtls.loanDtls.purpose.purposeDesc ?? 'NO DATA') + ' ' + '/' + ' ' +
        custData.customerDtls.loanDtls.purpose.productSubPurpose ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "repaymentFreq", (custData.customerDtls.loanDtls.repayFrequency.idDesc ?? 'NO DATA') + ' ' + 'for' +
        ' ' + custData.customerDtls.loanDtls.term ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "loanForPreClosure", productMerged);
    apz.setElmValue(LoanDisbursementScrId + "nameAndRelation", (custData.customerDtls.loanDtls.nomineeDtls.nomineeName ?? 'NO DATA') + '(' + (
        custData.customerDtls.loanDtls.nomineeDtls.relationWithMember ?? 'NO DATA') + ')');
    apz.setElmValue(LoanDisbursementScrId + "insurFor", insurFor);
    apz.setElmValue(LoanDisbursementScrId + "membersKycId", (custData.customerDtls.kycDtls.primaryType ?? 'NO DATA') + '(' + (custData
        .customerDtls.kycDtls.primaryId ?? 'NO DATA') + ')');
    if (custData.customerDtls.earnings.length === 0) {
        apz.setElmValue(LoanDisbursementScrId + "spouseKycId", 'NA');
        apz.setElmValue(LoanDisbursementScrId + "spouseNameAndDOB", 'NA');
    } else {
        apz.setElmValue(LoanDisbursementScrId + "spouseKycId", (custData.customerDtls.earnings[0].legaldocName ?? 'NO DATA') + '(' + (custData
            .customerDtls.earnings[0].legaldocId ?? 'NO DATA') + ')');
        apz.setElmValue(LoanDisbursementScrId + "spouseNameAndDOB", (custData.customerDtls.earnings[0] ? custData.customerDtls.earnings[0].name :
                'NO DATA') + ', ' + ApzCOB.dateformatter(ApzCOB.dateStringToDate(custData.customerDtls.earnings[0].dob ?? 'NO DATA'),
            "d M'y"));
    }
    if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.kycDtls.maritalStatus == 'MARRIED') {
        $('#' + LoanDisbursementScrId + 'sc_row_726').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'sc_row_718').removeClass('sno');
    } else {
        $('#' + LoanDisbursementScrId + 'sc_row_726').addClass('sno');
        $('#' + LoanDisbursementScrId + 'sc_row_718').addClass('sno');
    }
    apz.setElmValue(LoanDisbursementScrId + "accNumber", custData.customerDtls.bankDtls.bankAccNo ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "bankIfsc", (custData.customerDtls.bankDtls.bankName ?? 'NO DATA') + ',' + custData.customerDtls
        .bankDtls.bankIfscCode ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "branch", custData.customerDtls.bankDtls.bankBranchName ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "el_txt_841", custData.customerDtls.mobileNum ?? 'NO DATA');
    //var vintage = ((custData.customerDtls.kycDtls.vintage) / 365).toFixed(0);
    vintage = 'NO DATA'
    apz.setElmValue(LoanDisbursementScrId + "vintageYrs", 'Vintage' + ' ' + vintage + ' ' + 'Year');
    apz.setElmValue(LoanDisbursementScrId + "maritalStatus", custData.customerDtls.kycDtls.maritalStatus ?? "NO DATA")
    apz.setElmValue(LoanDisbursementScrId + "membersDOB", ApzCOB.dateformatter(ApzCOB.dateStringToDate(custData.customerDtls.kycDtls.dob ??
        'NO DATA'), "d M'y"));
    if (KendraApp.selectedDisbursement.wfStatus == 'DISBURSED') {
        $('#' + LoanDisbursementScrId + 'approveRow').addClass('sno');
        $('#' + LoanDisbursementScrId + 'editLoanAndInsBtn').addClass('sno');
        $('#' + LoanDisbursementScrId + 'ct_frm_118').addClass('sno');
    } else if (KendraApp.selectedDisbursement.applicationStatus === 'DISBURSED') {
        $('#LoanDi__LoanDisbursementList__approveRow').addClass('sno');
        $('#LoanDi__LoanDisbursementList__ct_frm_118').addClass('sno');
    } else if (KendraApp.selectedDisbursement.productCode === 'EL') {
        if (KendraApp.selectedDisbursement.loanMode === 'NEFT PAYMENT SUCCESSFUL'||KendraLoans.custFetchLoanAppRes.applicationdtls[0].loanMode ==='IN BRANCH'){
            $('#' + LoanDisbursementScrId + 'editLoanAndInsBtn').removeClass('sno');
        } else {
            $('#' + LoanDisbursementScrId + 'editLoanAndInsBtn').addClass('sno');
        }
        $("#LoanDi__LoanDisbursementList__gr_row_170").addClass("sno");
        $('#' + LoanDisbursementScrId + 'approveRow').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'ct_frm_118').removeClass('sno');
        $('#LoanDi__LoanDisbursementList__el_txt_869_li').addClass('sno');
    } else {
        $("#LoanDi__LoanDisbursementList__gr_row_170").removeClass("sno");
        $('#' + LoanDisbursementScrId + 'approveRow').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'editLoanAndInsBtn').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'ct_frm_118').removeClass('sno');
        if (window.kmBmRole === "KM" ||isSelfAssigned) {
            $("#LoanDi__LoanDisbursementList__editLoanAndInsBtn").addClass("sno");
        }
        
    }
    //apz.app.LoanDisbursementList.updateFinalAmt();
    var addinfo = custData.addInfo;
    if (typeof addinfo == 'string') {
        addinfo = JSON.parse(addinfo)
    }
    if (apz.isNull(addinfo.isApprovedCRT)) {
        $('#LoanDi__LoanDisbursementList__crtFlagDet1').addClass('sno');
    } else {
        if (addinfo.isApprovedCRT) {
            // console.log('true'); 
            $('#LoanDi__LoanDisbursementList__crtFlagDet1').removeClass('sno');
        } else {
            $('#LoanDi__LoanDisbursementList__crtFlagDet1').addClass('sno');
        }
    }
}
apz.app.LoanDisbursementList.updateFinalAmt = function() {
    var approvedAmt = custData.amount;
    if (typeof approvedAmt === 'string') {
        approvedAmt = approvedAmt.replace('', '')
    }
    var loanCharges = 0;
    if (!apz.isNull(custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1)) {
        loanCharges = parseInt(custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1)
    }
    var insurCharges = custData.customerDtls.loanDtls.insurDtls.insurCharges || "0";
    var membInsuCharges = custData.customerDtls.loanDtls.insurDtls.applicant_insurance_amt || "0";
    var spouseInsuCharges = custData.customerDtls.loanDtls.insurDtls.spouse_insurance_amt || "0";
    var aprxInstallmentAmtBM = apz.isNull(custData.customerDtls.loanDtls.installmentDetails)?'':custData.customerDtls.loanDtls.installmentDetails
    if(aprxInstallmentAmtBM === ''){
        $('#LoanDi__LoanDisbursementList__el_txt_896_ul').addClass('sno');
    }else{
        $('#LoanDi__LoanDisbursementList__el_txt_896_ul').removeClass('sno');
    }
    apz.setElmValue(LoanDisbursementScrId + "memInsDisbCharges", ApzCOB.fn_FormatAmount(membInsuCharges));
    apz.setElmValue(LoanDisbursementScrId + "spouseDisbInsCharges", ApzCOB.fn_FormatAmount(spouseInsuCharges));
    apz.setElmValue(LoanDisbursementScrId + "approvedAmtBM", approvedAmt);
    apz.setElmValue(LoanDisbursementScrId + "aprxInstallmentAmtBM", aprxInstallmentAmtBM);
    apz.setElmValue(LoanDisbursementScrId + "approvedAmtBM", approvedAmt);
    apz.setElmValue(LoanDisbursementScrId + "insurChargesBM", ApzCOB.fn_FormatAmount(insurCharges));
    apz.setElmValue(LoanDisbursementScrId + "processingFeeBM", custData.customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee);
    apz.setElmValue(LoanDisbursementScrId + "gstFeeBM", custData.customerDtls.loanDtls.chargeAndBreakupDtls.GST);
    apz.setElmValue(LoanDisbursementScrId + "preClosureAmtBM", ApzCOB.fn_FormatAmount(totPreCloAmtFinal));
    var finalCharges = parseInt(loanCharges);
    if (totPreCloAmtFinal != 0) {
        finalCharges = parseInt(loanCharges) + parseInt(totPreCloAmtFinal);
    }
    apz.setElmValue(LoanDisbursementScrId + "finalAmtBM", ApzCOB.fn_FormatAmount(parseInt(approvedAmt) - finalCharges));
    var proclosedAcc = '';
    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach((loan, j) => {
        if (loan.status == 'CLOSED') {
            if (apz.isNull(proclosedAcc)) {
                proclosedAcc = loan.shortDesc;
            } else {
                proclosedAcc = proclosedAcc + ',' + loan.shortDesc;
            }
        }
    });
    productMerged = proclosedAcc;
    apz.setElmValue(LoanDisbursementScrId + "loanForPreClosure", productMerged);
    if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].productType === 'EL') {
        let upFrontFee = parseInt(custData.customerDtls.loanDtls.chargeAndBreakupDtls.upfront_Fee);
        let loanAmount = parseInt(custData.customerDtls.loanDtls.chargeAndBreakupDtls.loanAmt);
        let finalAmt = loanAmount - upFrontFee;
        document.getElementById('LoanDi__LoanDisbursementList__el_txt_881_txtcnt').innerText = 'Upfront Charges (Including GST)';
        document.getElementById('LoanDi__LoanDisbursementList__el_txt_878_txtcnt').innerText = 'Approx Installment Amount';
        $("#" + LoanDisbursementScrId + "sc_row_1042").addClass('sno');
        apz.setElmValue(LoanDisbursementScrId + "gstFeeBM", custData.customerDtls.loanDtls.chargeAndBreakupDtls.upfront_Fee);
        apz.setElmValue(LoanDisbursementScrId + "finalAmtBM", ApzCOB.fn_FormatAmount(finalAmt));
        if (custData.customerDtls.loanDtls.repayFrequency.idDesc === 'WEEKLY') {
            document.getElementById('LoanDi__LoanDisbursementList__processingFeeBM_txtcnt').innerText = '100';
        } else {
            document.getElementById('LoanDi__LoanDisbursementList__processingFeeBM_txtcnt').innerText = '200';
        }
    }else{
        $("#" + LoanDisbursementScrId + "sc_row_1042").removeClass('sno');
    }
}
apz.app.LoanDisbursementList.confirmStage2 = function() {
    checked = $('#LoanDi__LoanDisbursementList__el_btn_37').is(":checked")
    if (checked) {
        ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage2', 'stage2', 'successDiv'].hide();
        ['stage3'].show();
        if (custData.customerDtls.loanDtls.disburseMode.idDesc === 'CASH') {
            // kyc doc
            ['confirmInBranch'].show();
            ['confirmOnfiled'].hide();
            // ['confirmOnfiled'].show();
            //  ['confirmInBranch'].hide();
        } else if (custData.customerDtls.loanDtls.disburseMode.idDesc === 'NEFT') {
            ['confirmInBranch'].show();
            ['confirmOnfiled'].hide();
        }
        apz.app.LoanDisbursementList.paintConfirmDisbursement()
    } else {
        ApzCOB.fnDisplayMsg('Please verify the above customers original documents', "E");
    }
    //apz.app.LoanDisbursementList.paintConfirmDisbursement()
}
apz.app.LoanDisbursementList.paintConfirmDisbursement = function() {
    var approvedAmt = custData.amount;
    let addInfo = custData.addInfo;
    if (typeof approvedAmt === 'string') {
        approvedAmt = approvedAmt.replace('', '')
    }
    if (typeof addInfo === "string") {
        addInfo = JSON.parse(addInfo);
    }
    var loanCharges = 0;
    if (!apz.isNull(custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1)) {
        loanCharges = parseInt(custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1)
    }
    var insurCharges = custData.customerDtls.loanDtls.insurDtls.insurCharges || "0";
    var membInsuCharges = custData.customerDtls.loanDtls.insurDtls.applicant_insurance_amt || "0";
    var spouseInsuCharges = custData.customerDtls.loanDtls.insurDtls.spouse_insurance_amt || "0";
    var aprxInstallmentAmt = apz.isNull(custData.customerDtls.loanDtls.installmentDetails)?'':custData.customerDtls.loanDtls.installmentDetails
    if(aprxInstallmentAmt === ''){
        $('#LoanDi__LoanDisbursementList__el_txt_897_ul').addClass('sno');
    }else{
        $('#LoanDi__LoanDisbursementList__el_txt_897_ul').removeClass('sno');
    }
    //    var processingFee = custData.customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee.replaceAll(/[^a-zA-Z0-9 .]/g, '').trim();
    //  var finalAmount = ApzCOB.fn_unFormatAmount(approvedAmt.replace('', '')) - (parseInt(insurCharges) + parseInt(processingFee))
    apz.setElmValue(LoanDisbursementScrId + "conCustName", custData.customerDtls.customerName ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "conImg", custData.customerDtls.customerName.slice(0, 1));
    apz.setElmValue(LoanDisbursementScrId + "conkendraId", custData.kendraId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "conkendraName", custData.kendraName ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "conGroupID",addInfo.groupId ?? "NO DATA");
    // apz.setElmValue(LoanDisbursementScrId + "conGroupID", JSON.parse(custData.addInfo).groupId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "conCustStatus", custData.loanMode ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "approvedAmt", approvedAmt);
    apz.setElmValue(LoanDisbursementScrId + "aprxInstallmentAmt", aprxInstallmentAmt);
    apz.setElmValue(LoanDisbursementScrId + "insurCharges", ApzCOB.fn_FormatAmount(insurCharges));
     apz.setElmValue(LoanDisbursementScrId + "kmDisbMemInsCharg", ApzCOB.fn_FormatAmount(membInsuCharges));
    apz.setElmValue(LoanDisbursementScrId + "kmDisbSpInsCharge", ApzCOB.fn_FormatAmount(spouseInsuCharges));
    apz.setElmValue(LoanDisbursementScrId + "processingFee", custData.customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee);
    apz.setElmValue(LoanDisbursementScrId + "gstFee", custData.customerDtls.loanDtls.chargeAndBreakupDtls.GST);
    apz.setElmValue(LoanDisbursementScrId + "preClosureAmt", ApzCOB.fn_FormatAmount(totPreCloAmt));
    var finalCharges = parseInt(loanCharges);
    if (totPreCloAmt != 0) {
        finalCharges = parseInt(loanCharges) + parseInt(totPreCloAmt);
    }
    apz.setElmValue(LoanDisbursementScrId + "finalAmt", ApzCOB.fn_FormatAmount(parseInt(approvedAmt) - finalCharges));
    var addinfo = custData.addInfo;
    if (typeof addinfo == 'string') {
        addinfo = JSON.parse(addinfo)
    }
    if (apz.isNull(addinfo.isApprovedCRT)) {
        $('#LoanDi__LoanDisbursementList__crtFlagDet2').addClass('sno');
    } else {
        if (addinfo.isApprovedCRT) {
            // console.log('true'); 
            $('#LoanDi__LoanDisbursementList__crtFlagDet2').removeClass('sno');
        } else {
            $('#LoanDi__LoanDisbursementList__crtFlagDet2').addClass('sno');
        }
    }
}
apz.app.LoanDisbursementList.backNavStage1 = function() {
    if (window.KendraLoans.scr === 'dashboardDisbursement') {
        ApzCOB.backNavigation();
    } else if (window.KendraLoans.scr === 'LoanDisbursementList') {
        ['stage1', 'stage2', 'stage3', 'successDiv'].hide();
        ['applicationsDiv', 'searchDiv', 'loanHeader'].show();
        apz.app.LoanDisbursementList.paintLoanStatus();
        apz.app.LoanDisbursementList.paintCustomerList();
    }
    productMerged = [];
    // ['stage1', 'stage2', 'stage3', 'successDiv'].hide();
    // ['applicationsDiv', 'searchDiv', 'loanHeader'].show();
    // ApzCOB.backNavigation()
}
apz.app.LoanDisbursementList.backNavStage2 = function() {
    if (KendraApp.selectedDisbursement.wfStatus === 'DISBURSED') {
        if (window.KendraLoans.scr === 'dashboardDisbursement') {
            ApzCOB.backNavigation()
        } else if (window.KendraLoans.scr === 'LoanDisbursementList') {
            ['stage1', 'stage2', 'stage3', 'successDiv'].hide();
            ['applicationsDiv', 'searchDiv', 'loanHeader'].show();
            apz.app.LoanDisbursementList.paintLoanStatus();
            apz.app.LoanDisbursementList.paintCustomerList();
        }
    } else {
        if (window.KendraLoans.scr === 'dashboardDisbursement') {} else if (window.KendraLoans.scr === 'LoanDisbursementList') {}
        ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage2', 'stage3', 'successDiv'].hide();
        ['stage1'].show();
    }
    if ((userRole === 'BM' && !isSelfAssigned) || userRole === 'BM2') {
        ApzCOB.backNavigation();
        ['stage1'].hide();
    }
}
apz.app.LoanDisbursementList.backNavStage3 = function() {
    ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage1', 'stage3', 'successDiv', 'CBconsentDiv'].hide();
    ['stage2'].show();
    $('#' + LoanDisbursementScrId + 'stage3').addClass('sno');
    $('#' + LoanDisbursementScrId + 'stage2').removeClass('sno');
}
apz.app.LoanDisbursementList.savepreClosureLoanFinal = function() {
    if (avaliableLoansFinal.length == 0 && optClosureFinal.length==0) {
        //apz.app.LoanDisbursementList.preClosureLoan();
        apz.app.LoanDisbursementList.moveToBm();
    } else {
        KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls = [];
        KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls = t24FinalLoans;
        avaliableLoansFinal.forEach(function(loan, i) {
            if ($('#' + LoanDisbursementScrId + 'el_cbx_22_' + i).prop('checked') === true) {
                selectedPreclosureBMFinal = true;
                KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                    if (prod.productId == loan.productId) {
                        KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status =
                            'CLOSED';
                    }
                });
            }
        });
        if (optClosureFinal.length !== 0) {
            optClosureFinal.forEach(function(loan, i) {
                if (loan.status == 'DISBURSED') {
                    selectedPreclosureBMFinal = true;
                    KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                        if (prod.productId == loan.productId) {
                            KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls[j].status = 'DISBURSED';
                        }
                    });
                }
            });
        }
        if (selectedPreclosureBMFinal) {
            var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
            if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.includes('/')) {
                //
            } else {
                KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
            }
            //KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
            ApzCOB.saveLoan();
        } else {
            //apz.app.LoanDisbursementList.preClosureLoan();
            apz.app.LoanDisbursementList.moveToBm();
        }
    }
}
apz.app.LoanDisbursementList.preClosureLoan = function() {
    //var loans = custData.customerDtls.loanDtls.activeLoanDtls
    /*closeAcctNo = [];
    preCloseLoans = [];
    var loans = KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.activeLoanDtls;
    loans.forEach(function(el, i) {
        if (el.status === "CLOSED") {
            preCloseLoans.push(el)
        }
    });
    if (preCloseLoans.length === custData.customerDtls.loanDtls.activeLoanDtls.length) {
        preCloseLoans.forEach(function(loan, i) {
            //closeAcctNo.push(loan.loanId);
            closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === loan.loanId).arrangementId);
        });
        precloseType = "3- All Loan Preclosure";
    } else {
        if (preCloseLoans.length === 1) {
            if (preCloseLoans[0].productId === custData.customerDtls.loanDtls.productId) {
                precloseType = "1- Same Loan Preclosure";
                //closeAcctNo.push(preCloseLoans[0].loanId);
                closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === preCloseLoans[0].loanId).arrangementId);
            } else {
                precloseType = "2- Selected Loan Preclosure";
                //closeAcctNo.push(preCloseLoans[0].loanId);
                closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === preCloseLoans[0].loanId).arrangementId);
            }
        } else if (preCloseLoans.length > 1) {
            preCloseLoans.forEach(function(loan, i) {
                //closeAcctNo.push(loan.loanId);
                closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === loan.loanId).arrangementId);
            });
            precloseType = "2- Selected Loan Preclosure";
        }
    }*/
    closeAcctNo = [];
    preCloseLoans = [];
    var loans = t24FinalLoans;
    loans.forEach(function(el, i) {
        if (el.status === "CLOSED") {
            preCloseLoans.push(el)
        }
    });
    if (preCloseLoans.length === KendraLoans.custNetoffDetails.length) {
        preCloseLoans.forEach(function(loan, i) {
            //closeAcctNo.push(loan.loanId);
            closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === loan.loanId).arrangementId);
        });
        if ((custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" || custData.customerDtls.loanDtls.product === "GL.IGL.PRGTI.RESTR.1Y")) {
            precloseType = "3- All Loan Preclosure";
        } else {
            precloseType = "2- Selected Loan Preclosure";
        }
    } else {
        if (preCloseLoans.length === 1) {
            if (preCloseLoans[0].productId === custData.customerDtls.loanDtls.productId) {
                precloseType = "1- Same Loan Preclosure";
                //closeAcctNo.push(preCloseLoans[0].loanId);
                closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === preCloseLoans[0].loanId).arrangementId);
            } else {
                precloseType = "2- Selected Loan Preclosure";
                //closeAcctNo.push(preCloseLoans[0].loanId);
                closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === preCloseLoans[0].loanId).arrangementId);
            }
            if ((custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" || custData.customerDtls.loanDtls.product ===
                "GL.IGL.PRGTI.RESTR.1Y")) {
                precloseType = "3- All Loan Preclosure";
            }
        } else if (preCloseLoans.length > 1) {
            preCloseLoans.forEach(function(loan, i) {
                //closeAcctNo.push(loan.loanId);
                closeAcctNo.push(KendraLoans.custNetoffDetails.find(item => item.accountId === loan.loanId).arrangementId);
            });
            precloseType = "2- Selected Loan Preclosure";
            if ((custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" || custData.customerDtls.loanDtls.product ===
                "GL.IGL.PRGTI.RESTR.1Y")) {
                precloseType = "3- All Loan Preclosure";
            }
        }
    }
};
apz.app.LoanDisbursementList.moveToBm = function() {
    if (LOANLIMIT?.Disbursed?.isCheck === true) {
        var configDays = LOANLIMIT?.Disbursed?.configDays;
        var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        var today = new Date();
        var activeLoans = KendraLoans.custNetoffDetails || [];
        for (var i = 0; i < activeLoans.length; i++) {
            var loan = activeLoans[i];
            if (!loan.disbDate) continue;
            var year = parseInt(loan.disbDate.substr(0, 4), 10);
            var month = parseInt(loan.disbDate.substr(4, 2), 10) - 1;
            var day = parseInt(loan.disbDate.substr(6, 2), 10);
            var disbDate = new Date(year, month, day);
            var diffDays = Math.floor((today - disbDate) / (1000 * 60 * 60 * 24));
            if (diffDays >= 0 && diffDays < configDays) {
                var disbDateFormatted = ("0" + disbDate.getDate()).slice(-2) + "-" + months[disbDate.getMonth()];
                var afterDate = new Date(disbDate.getTime() + configDays * 24 * 60 * 60 * 1000);
                var afterDateFormatted = ("0" + afterDate.getDate()).slice(-2) + "-" + months[afterDate.getMonth()];
                var selectedloanType = (KendraApp.ProductList || []).filter(function(p) {
                    return p.productDtls && p.productDtls.productId === loan.product;
                })[0];
                var loanType = selectedloanType.productDtls
                loanType = loanType ? loanType.description : loan.product;
                var loanAmt = ApzCOB.fn_FormatAmount(loan.amount);
                apz.stopLoader();
                ApzCOB.fnDisplayMsg(loanType + " of Rs " + loanAmt + " is disbursed on " + disbDateFormatted + ". Please proceed loan application on " +
                    afterDateFormatted + ".", "E");
                return false;
            }
        }
    }
    var closeAccArr = [];
    var insurerId = "";
    closeAcctNo.forEach(function(m) {
        var objAcc = {};
        objAcc.closeAcctNo = m;
        closeAccArr.push(objAcc)
    });
    if (userRole === "BM" && !isSelfAssigned) {
        apz.app.LoanDisbursementList.preClosureLoan();
        //apz.app.LoanDisbursementList.savepreClosureLoanFinal();
        var productSubPurpose = KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.purpose.productSubPurpose;
        KendraApp.ProductList.forEach(function(j) {
            j.productDtls.prodPurpose.forEach(function(k) {
                //console.log(k.productSubPurpose);
                for (let i = 0; i < k.productSubPurpose.length; i++) {
                    if (productSubPurpose == k.productSubPurpose[i]) {
                        productSubPurpose = k.productSubPurpose[i];
                    }
                }
            });
        });
        var cbSummary = KendraLoans.cbResponse.Derived_Attribute_1 + " |" + KendraLoans.cbResponse.Derived_Attribute_2 + " |" + KendraLoans
            .cbResponse.Derived_Attribute_3 + "  |" + KendraLoans.cbResponse.Derived_Attribute_4;
        if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls.member === 'Y') {
            insurerId = KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls.insuranceProvider || "";
        }
        var memberCode = LOV_LIST.nomineeReation.filter(val => (val.desc.toUpperCase() === KendraLoans.custFetchLoanAppRes.applicationdtls[0]
            .customerDtls.loanDtls.nomineeDtls.relationWithMember.toUpperCase()));
        if (closeAcctNo.length === 0) {
            precloseType = '';
        }
        if ((custData.customerDtls.loanDtls.product === "GL.IGL.PRAGATI.RESTR" || custData.customerDtls.loanDtls.product === "GL.IGL.PRGTI.RESTR.1Y")) {
            precloseType = "3- All Loan Preclosure";
        }
        //var matchAmount = false;
        var addinfo = KendraLoans.custFetchLoanAppRes.applicationdtls[0].addInfo;
        var annualPercentageRate = '';
        var foir = '';
        if (typeof addinfo == 'string') {
            addinfo = JSON.parse(addinfo)
        }
        if (apz.isNull(addinfo.isApprovedCRT)) {
            annualPercentageRate = KendraLoans.cbResponse.eir;
            var derivedValue = '';
            if (apz.isNull(KendraLoans.cbResponse.final_foir_obligation)) {
                derivedValue = number = KendraLoans.cbResponse.Derived_Attribute_4.match(/\d+\.\d+/)[0];
            } else {
                derivedValue = KendraLoans.cbResponse.final_foir_obligation;
            }
            //var derivedValue = number = KendraLoans.cbResponse.Derived_Attribute_4.match(/\d+\.\d+/)[0];
            foir = derivedValue;
            /*if (parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount) == parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0]
                    .customerDtls.loanAmount)) {
                matchAmount = true;
            }*/
        } else {
            if (addinfo.isApprovedCRT) {
                /*if (parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount) == parseInt(KendraLoans.custFetchLoanAppRes
                        .applicationdtls[0].customerDtls.loanAmount)) {
                    matchAmount = true;
                }*/
                annualPercentageRate = addinfo.APR;
                foir = addinfo.FOIR;
            } else {
               /* if (parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount) == parseInt(KendraLoans.custFetchLoanAppRes
                        .applicationdtls[0].customerDtls.loanAmount) && parseInt(KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls
                        .loanAmount) == parseInt(KendraLoans.cbResponse.Approved_Loan_Amount)) {
                    matchAmount = true;
                }*/
                annualPercentageRate = KendraLoans.cbResponse.eir;
                var derivedValue = '';
                if (apz.isNull(KendraLoans.cbResponse.final_foir_obligation)) {
                    derivedValue = number = KendraLoans.cbResponse.Derived_Attribute_4.match(/\d+\.\d+/)[0];
                } else {
                    derivedValue = KendraLoans.cbResponse.final_foir_obligation;
                }
                foir = derivedValue;
            }
        }
        if (apz.isNull(foir) || apz.isNull(annualPercentageRate)) {
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
            $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
            return;
        }
        if (apz.isNull(KendraLoans.cbResponse.Approved_Loan_Amount)) {
            ApzCOB.fnDisplayMsg('The BRE approved loan amount is Zero. Please reject and re-enter the loan.', "E");
            $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
            return;
        }else if(parseInt(KendraLoans.cbResponse.Approved_Loan_Amount) >parseInt(accntDetails.customerDtls.loanDtls.caglAmt)){
            ApzCOB.fnDisplayMsg('The entered loan amount is less than the disbursed amount. Please reject and re-enter the loan.', "E");
            $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
            return; 
        }
        // T24 API Call
        var t24ReqObj = {
            "nominationDetails": [{
                "nomineeName": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.nomineeDtls.nomineeName,
                "relationToCust": memberCode.length > 0 ? memberCode[0].val : ''
            }],
            "customerId": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.customerId,
            "loanAction": "NEW.LOAN",
            "loanProduct": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.productId,
            "currencyId": "INR",
            "mmflPreclosureAmt": "",
            "borrowerInsurance": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls.member === 'Y' ?
                'YES' : 'NO',
            "spouseInsurance": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls.Spouse === 'Y' ?
                'YES' : 'NO',
            "modeOfPayment": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.disburseMode.idDesc,
            "term": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.term,
            "amount": KendraLoans.custFetchLoanAppRes.applicationdtls[0].amount,
            "paymentFreq": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.repayFrequency.idDesc,
            "loanPurpose": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.purpose.purpose,
            "loanSubPurpose": productSubPurpose,
            "custRelationOccupation": '',
            "NomineeUpi": "",
            "cbValidTill": "",
            "creditAssessRecom": "APPROVE",
            "creditAssessNotes": "APPROVE",
            "cbReportDate": KendraLoans.cbResponse.Request_Date.replaceAll('-', ''),
            "cbStatus": "",
            "cbSummary": cbSummary,
            "cbReportLink": "https://caglinterface.grameenkoota.in/pdf/v1/getpdf?customerid=" + KendraLoans.custFetchLoanAppRes
                .applicationdtls[0].customerDtls.customerId,
            "cbRemarks": "PASS",
            "cbScore": "",
            "creditAssessResult": "PASS",
            "creditAssessRemarks": "PASS",
            "creditAssessUpdBy": "",
            "creditAssessUpdDate": "",
            "precloseType": precloseType,
            "reviewApprovalNotes": "PASS",
            "status": "801",
            "interestRate": KendraLoans.cbResponse.roi,
            "annualPercentageRate": annualPercentageRate,
            "declineReason": "", //KendraLoans.cbResponse.Rejection_reason,
            "remarks": KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId,
            "referenceId": KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId,
            "closeAcctNo": closeAcctNo,
            "insurerId": insurerId,
            "foir": foir,
            "earning_member": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.earnings.length,
            "family_income": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.income[0].totIncome,
            "gSTPF": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.GST,
            "processingFee": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee,
            "insuranceChargeMember": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls
                .applicant_insurance_amt,
            "insuranceChargeSpouse": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.insurDtls.spouse_insurance_amt,
            "upfrontInt": KendraLoans.custFetchLoanAppRes?.applicationdtls?.[0]?.customerDtls?.loanDtls?.productType === 'EL'? (KendraLoans.cbResponse?.Interest_Fee ?? "0") + "": ""
        }
        window.isSkipAvail = false;
        window.t24ReqObj = t24ReqObj;
        window.userSkipedOTP = false;
        otpDetails = {};
        let isDisbOTPInvalid = false;
        var appliedProduct = {};
        for (const product of KendraApp.ProductResponse) {
            if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.product == product.productDtls.productId) {
                appliedProduct = product.productDtls;
            }
        }
        if (appliedProduct.disbOTP === undefined || appliedProduct.disbOTP === null) {
            isDisbOTPInvalid = true;
        }
        if (isDisbOTPInvalid) {
            if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee == '0' && (
                    custData.customerDtls.loanDtls.product !== "GL.IGL.PRAGATI.RESTR" && custData.customerDtls.loanDtls.product !==
                    "GL.IGL.PRGTI.RESTR.1Y")) {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E", apz.app.LoanDisbursementList
                    .reCheckprocessingFee);
            } else {
                window.KendraApp.isnotQualifyApp = false;
                if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.productType === "EL") {
                    window.isSkipAvail = true;
                     apz.app.LoanDisbursementList.loandisbursement()
                    //apz.app.LoanDisbursementList.loanCreationT24Service(t24ReqObj);
                } else {
                    if (!apz.isNull(addinfo.otpDetails)) {
                        otpDetails = addinfo.otpDetails;
                        if (addinfo.otpDetails.OTPOptional == 'Both') {
                            window.isSkipAvail = true;
                            ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                        } else if (addinfo.otpDetails.OTPOptional == 'OTP') {
                            ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                        } else {
                            window.isSkipAvail = true;
                             apz.app.LoanDisbursementList.loandisbursement()
                            //apz.app.LoanDisbursementList.loanCreationT24Service(t24ReqObj);
                        }
                    } else {
                        ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                    }
                }
            }
        } else {
            if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee == '0' && (
                    custData.customerDtls.loanDtls.product !== "GL.IGL.PRAGATI.RESTR" && custData.customerDtls.loanDtls.product !==
                    "GL.IGL.PRGTI.RESTR.1Y")) {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E", apz.app.LoanDisbursementList
                    .reCheckprocessingFee);
            } else {
                window.KendraApp.isnotQualifyApp = false;
                if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.productType === "EL") {
                    window.isSkipAvail = true;
                     apz.app.LoanDisbursementList.loandisbursement()
                    //apz.app.LoanDisbursementList.loanCreationT24Service(t24ReqObj);
                } else {
                    if (!apz.isNull(addinfo.otpDetails)) {
                        otpDetails = addinfo.otpDetails;
                        if (!apz.isNull(otpDetails.branchOTP) && otpDetails.branchOTP === 'disbOTP') {
                            if (appliedProduct.disbOTP === 'YES') {
                                ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                            } else {
                                window.isSkipAvail = true;
                                apz.app.LoanDisbursementList.loandisbursement();
                                //apz.app.LoanDisbursementList.loanCreationT24Service(t24ReqObj);
                            }
                        } else {
                            if (addinfo.otpDetails.OTPOptional == 'Both') {
                                window.isSkipAvail = true;
                                ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                            } else if (addinfo.otpDetails.OTPOptional == 'OTP') {
                                ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                                $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
                            } else {
                                window.isSkipAvail = true;
                                apz.app.LoanDisbursementList.loandisbursement()
                                //apz.app.LoanDisbursementList.loanCreationT24Service(t24ReqObj);
                            }
                        }
                    } else {
                        ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                    }
                }
            }
        }
        //ApzCOB.loanCreationT24Service(t24ReqObj);
    } else {
        var workflow = {
            "currentRole": "KM",
            "action": "NEXT",
            "workflowId": "SANCTION",
            "stage": "SANCTIONED",
            "remarks": "The Loan disbursement initiate by "+LoggedInUserDetails.userID +' ('+currentUserRole +').'
        }
        ApzCOB.updateAppication(workflow);
    }
    // if (KendraApp.selectedDisbursement.customerDtls.loanDtls.disburseMode.idDesc === 'CASH') {
    //     if (userRole === "" || userRole === "BM2") {
    //         ApzCOB.toggleModal(BaseScrId + "otpAuthModal");
    //     }
    // }
}
apz.app.LoanDisbursementList.reCheckprocessingFee = function() {
    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.iscbUpdated = false;
    window.KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.chargeAndBreakupDtls.loanAmt = KendraLoans.custFetchLoanAppRes
        .applicationdtls[0].amount;
    window.KendraApp.isnotQualifyApp = true;
    var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
    if (appDate.length === 3) {
        KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
    }
    ApzCOB.saveLoan();
}
apz.app.LoanDisbursementList.kmInitiatedToBM = function() {
    disbursementList = disbursementList.filter(function(item) {
        return item.customerId !== KendraApp.selectedDisbursement.customerId;
    });
    var z = [];
    disbursementList.forEach((item) => {
        if (item.status === 'Move to BM') {
            z.push(item);
        }
    });
    if (z.length === 0) { // Display "No records found" message
        $('#LoanDi__LoanDisbursementList__gr_row_128').addClass('sno');
        $('#LoanDi__LoanDisbursementList__ct_frm_130').removeClass('sno');
    } else {
        $('#LoanDi__LoanDisbursementList__ct_frm_130').addClass('sno');
        $('#LoanDi__LoanDisbursementList__gr_row_128').removeClass('sno');
    }
    var x = [];
    if (z.length >= 4) {
        $('#LoanDi__LoanDisbursementList__el_btn_50').removeClass('sno'); // Show the "View More" button
        x = z.slice(0, 4);
    } else {
        $('#LoanDi__LoanDisbursementList__el_btn_50').addClass('sno');
        x = z;
    }
    apz.data.scrdata.LoanDi__CustomersList_Res = {};
    apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer = x; // Load the filtered data
    apz.data.loadData("CustomersList", 'LoanDi');
    ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage1', 'stage3', 'stage2', 'CBconsentDiv'].hide();
    ['successDiv'].show();
     if (userRole === 'BM') {
        $('#LoanDi__LoanDisbursementList__el_btn_67').addClass('sno');
        $('#LoanDi__LoanDisbursementList__viewReport_ul').removeClass('sno');
    } else {
        $('#LoanDi__LoanDisbursementList__el_btn_67').removeClass('sno');
        $('#LoanDi__LoanDisbursementList__viewReport_ul').addClass('sno');
    }
    var custName = custData.customerName + " (" + ApzCOB.fn_FormatAmount(custData.amount) + " " + custData.customerDtls.loanDtls.shortDesc + ")";
    apz.setElmValue(LoanDisbursementScrId + "succCustName", custName);
    apz.setElmValue(LoanDisbursementScrId + "sucRefId", "#" + custData.applicationId);
    setTimeout(function() {
        $('#' + LoanDisbursementScrId + 'successDtlsForm').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'gr_row_126').removeClass('sno');
    }, 3000);
    apz.app.LoanDisbursementList.loadcrtData();
    apz.app.LoanDisbursementList.moreDetails();
     if(userRole === 'KM'){
        $('#LoanDi__LoanDisbursementList__successDiv').removeClass('sno');
    }
}
apz.app.LoanDisbursementList.finalSubmitByBM = function() {
    if (!window.isSkipAvail) {
        ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
    }
    if (!apz.isNull(otpDetails)) {
        if (otpDetails.OTPOptional == 'Both' && !window.userSkipedOTP) {
            ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
        }
    }
    if (KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.loanDtls.productType === 'EL' && KendraLoans.custFetchLoanAppRes.applicationdtls[
            0].customerDtls.loanDtls.disburseMode.idDesc == 'NEFT') {
        apz.app.LoanDisbursementList.sendSMSLink();
    }
    $('#' + LoanDisbursementScrId + 'el_txt_687').addClass('sno');
    $('#' + LoanDisbursementScrId + 'el_txt_688').removeClass('sno');
    setTimeout(function() {
        $('#' + LoanDisbursementScrId + 'successDtlsForm').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'gr_row_126').removeClass('sno');
    }, 3000);
    disbursementList = disbursementList.filter(val => (val.applicationId !== accntDetails.applicationId));
    apz.data.scrdata.LoanDi__CustomersList_Res = {};
    if (disbursementList.length > 0) {
        if (disbursementList.length <= 4) {
            apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer = {};
            apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer = disbursementList; // Load the filtered data
            apz.data.loadData("CustomersList", 'LoanDi');
        } else {
            let slicedDisbursementArray = disbursementList.slice(0, 4);
            let x = slicedDisbursementArray.filter((item) => {
                return item.status === "Pending"
            })
            apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer = {};
            apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer = x; // Load the filtered data
            apz.data.loadData("CustomersList", 'LoanDi');
        }
        apz.app.LoanDisbursementList.loadcrtData('ViewAllCustomer');
    }
    var custName = custData.customerName + " (" + ApzCOB.fn_FormatAmount(custData.amount) + " " + custData.customerDtls.loanDtls.shortDesc + ")";
    apz.setElmValue(LoanDisbursementScrId + "succCustName", custName);
    apz.setElmValue(LoanDisbursementScrId + "sucRefId", "#" + custData.applicationId);
    ['applicationsDiv', 'searchDiv', 'loanHeader', 'stage1', 'stage3', 'stage2', 'CBconsentDiv'].hide();
    ['successDiv'].show();
    if (userRole === 'BM') {
        $('#LoanDi__LoanDisbursementList__el_btn_67').addClass('sno');
        $('#LoanDi__LoanDisbursementList__viewReport_ul').removeClass('sno');
    } else {
        $('#LoanDi__LoanDisbursementList__el_btn_67').removeClass('sno');
        $('#LoanDi__LoanDisbursementList__viewReport_ul').addClass('sno');
    }
    apz.app.LoanDisbursementList.moreDetailsFinal();
}
apz.app.LoanDisbursementList.t24RejectCaseHandle = function() {
    var custName = custData.customerName + " (" + ApzCOB.fn_FormatAmount(custData.amount) + " " + custData.customerDtls.loanDtls.shortDesc + ")";
    apz.setElmValue(LoanDisbursementScrId + "rejCustName", custName);
    apz.setElmValue(LoanDisbursementScrId + "rejRefId", "#" + custData.applicationId);
    apz.setElmValue(LoanDisbursementScrId + "el_txt_812", "Loan ID #" + custData.applicationId);
    document.getElementById(LoanDisbursementScrId + 'rejectReason').innerText = KendraApp.disbursedApp.error.errorDetails[0].message;
    apz.setElmValue(LoanDisbursementScrId + "rejectInterest", (JSON.parse(KendraLoans.custFetchLoanAppRes.cbResponse.resPayload).roi ??
        'NO DATA') + "%");
    apz.setElmValue(LoanDisbursementScrId + "rejectTenure", (custData.customerDtls.loanDtls.term.split("W")[0] ?? 'NO DATA') + " Weeks");
    apz.setElmValue(LoanDisbursementScrId + "rejectFrequency", custData.customerDtls.loanDtls.repayFrequency.idDesc ?? 'NO DATA');
    $('#LoanDi__LoanDisbursementList__sc_row_972').addClass('sno');
    $('#LoanDi__LoanDisbursementList__sc_row_974').addClass('sno');
}
apz.app.LoanDisbursementList.moreDetailsFinal = function() {
    $('#' + LoanDisbursementScrId + 'stage3').addClass('sno');
    $('#' + LoanDisbursementScrId + 'moreDetailsDiv').removeClass('sno');
    var preclosedAmt = 0;
    var activeLoans = custData.customerDtls.loanDtls.activeLoanDtls
    activeLoans.forEach(function(el, i) {
        if (activeLoans[i].status === "CLOSED") {
            var amt = parseFloat(activeLoans[i].outstandingPrincipal) + parseFloat(activeLoans[i].overdueInterest) + parseFloat(
                activeLoans[i].overduePrincipal);
            preclosedAmt = parseFloat(preclosedAmt) + parseFloat(amt);
        }
    })
    preclosedAmt = ApzCOB.fn_FormatAmount(preclosedAmt);
    apz.setElmValue(LoanDisbursementScrId + "interest", (KendraLoans.cbResponse.roi ?? 'NO DATA') + "%");
    apz.setElmValue(LoanDisbursementScrId + "tenure", KendraApp.disbursedApp.body.term ?? 'NO DATA');
    var loanProcessingFee = custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1;
    if (custData.customerDtls.loanDtls.productType === "EL") {
        apz.setElmValue(LoanDisbursementScrId + "loanCharges", ApzCOB.fn_FormatAmount(custData.customerDtls.loanDtls.chargeAndBreakupDtls
            .upfront_Fee) ?? 'NO DATA');
    } else {
        apz.setElmValue(LoanDisbursementScrId + "loanCharges", ApzCOB.fn_FormatAmount(custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1) ??
            'NO DATA');
    }
    apz.setElmValue(LoanDisbursementScrId + "frequency", custData.customerDtls.loanDtls.repayFrequency.idDesc ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "preclosedAmount", '' + ApzCOB.fn_FormatAmount(totPreCloAmtFinal));
    apz.setElmValue(LoanDisbursementScrId + "sucRefId", custData.applicationId);
}
apz.app.LoanDisbursementList.moreDetails = function() {
    $('#' + LoanDisbursementScrId + 'stage3').addClass('sno');
    $('#' + LoanDisbursementScrId + 'moreDetailsDiv').removeClass('sno');
    var preclosedAmt = 0;
    var activeLoans = custData.customerDtls.loanDtls.activeLoanDtls
    activeLoans.forEach(function(el, i) {
        if (activeLoans[i].status === "CLOSED") {
            var amt = parseFloat(activeLoans[i].outstandingPrincipal) + parseFloat(activeLoans[i].overdueInterest) + parseFloat(
                activeLoans[i].overduePrincipal);
            preclosedAmt = parseFloat(preclosedAmt) + parseFloat(amt);
        }
    })
    preclosedAmt = ApzCOB.fn_FormatAmount(preclosedAmt);
    apz.setElmValue(LoanDisbursementScrId + "interest", (JSON.parse(KendraLoans.custFetchLoanAppRes.cbResponse.resPayload).roi ?? 'NO DATA') +
        "%");
    apz.setElmValue(LoanDisbursementScrId + "tenure", custData.customerDtls.loanDtls.term ?? 'NO DATA');
    var addInfo1 = custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1;
    var formattedLoanCharges = addInfo1;
    if (typeof addInfo1 === 'string') {
        formattedLoanCharges = ApzCOB.fn_FormatAmount(addInfo1.replace(/[^a-zA-Z0-9 .]/g, ''));
    }
    //apz.setElmValue(LoanDisbursementScrId + "loanCharges", formattedLoanCharges);
    if (custData.customerDtls.loanDtls.productType === "EL") {
        apz.setElmValue(LoanDisbursementScrId + "loanCharges", ApzCOB.fn_FormatAmount(custData.customerDtls.loanDtls.chargeAndBreakupDtls
            .aprxLoanCharges) ?? 'NO DATA');
    } else {
        apz.setElmValue(LoanDisbursementScrId + "loanCharges", ApzCOB.fn_FormatAmount(custData.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1) ??
            'NO DATA');
    }
    apz.setElmValue(LoanDisbursementScrId + "frequency", custData.customerDtls.loanDtls.repayFrequency.idDesc ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "preclosedAmount", ' ' + ApzCOB.fn_FormatAmount(totPreCloAmt));
    apz.setElmValue(LoanDisbursementScrId + "sucRefId", custData.applicationId);
    // apz.setElmValue(LoanDisbursementScrId + "loanCharges", custData.customerDtls.loanDtls ? ApzCOB.fn_FormatAmount(custData.customerDtls.loanDtls
    //     .chargeAndBreakupDtls.addInfo1.replaceAll(/[^a-zA-Z0-9 .]/g, '')) : 'NO DATA');
    // apz.setElmValue(LoanDisbursementScrId + "frequency", custData.customerDtls.loanDtls.repayFrequency.idDesc ?? 'NO DATA');
    // apz.setElmValue(LoanDisbursementScrId + "preclosedAmount", ' ' + ApzCOB.fn_FormatAmount(totPreCloAmt));
    // apz.setElmValue(LoanDisbursementScrId + "sucRefId", custData.applicationId);
}
apz.app.LoanDisbursementList.viewCustList = function() {
    apz.app.LoanDisbursementList.paintLoanStatus();
    apz.app.LoanDisbursementList.paintCustomerList();
    ['applicationsDiv', 'searchDiv', 'loanHeader'].show();
    $('#' + LoanDisbursementScrId + 'successDiv').addClass('sno');
    if ((userRole === "BM" && !isSelfAssigned) && apz.deviceType === 'ANDROID') {
        $('#' + LoanDisbursementScrId + 'applicationsDiv').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'stage2').addClass('sno');
        $('#LoanDi__LoanDisbursementList__loanHeader').removeClass('sno');
    } else if ((userRole === "BM"&& !isSelfAssigned) && apz.deviceType == 'WEB') {
        $('#' + LoanDisbursementScrId + 'applicationsDiv').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'stage2').addClass('sno');
        $('#' + LoanDisbursementScrId + 'failureDiv').addClass('sno');
    }
}
apz.app.LoanDisbursementList.custDetailsBasedOnStatus = function(pthis) {
    apz.startLoader(); // Start loader to indicate processing
    setTimeout(function() {
        var status = $('#' + pthis.id).text().trim(); // Get status from clicked tab
        onStatusSelect = true; // Indicate that a status is selected
        $('.ett-para').removeClass('active');
        $(pthis).addClass('active');
        customerListBasedOnStatus = [];
        if (status === 'All Applications') {
            customerListBasedOnStatus = disbursementList;
        } else {
            customerListBasedOnStatus = disbursementList.filter(function(el) {
                return el.status === status;
            });
        }
        if (customerListBasedOnStatus.length > 0) {
            apz.data.scrdata.LoanDi__CustomersList_Res = {}; // Clear previous data
            apz.data.scrdata.LoanDi__CustomersList_Res.Customer = customerListBasedOnStatus;
            apz.data.loadData("CustomersList", 'LoanDi');
            apz.app.LoanDisbursementList.loadcrtData('Customer');
            if (apz.deviceType === 'WEB') {
                window.pageNo = 1;
                let totalItems = customerListBasedOnStatus.length;
                if (totalItems > configLimit) {
                    apz.app.LoanDisbursementList.InitialisePagination(totalItems, customerListBasedOnStatus);
                } else {
                    apz.app.LoanDisbursementList.HidePagination(customerListBasedOnStatus);
                }
                apz.app.LoanDisbursementList.loadCurrentPageData(window.pageNo);
            }
        } else {
            if (apz.deviceType === 'WEB') {
                apz.app.LoanDisbursementList.HidePagination([]);
            }
        }
        apz.setElmValue(LoanDisbursementScrId + "listCount", customerListBasedOnStatus.length + '/' + disbursementList.length);
        apz.stopLoader();
    }, 300);
};
apz.app.LoanDisbursementList.onSearch = function(pthis) {
    var searchText = $("#" + pthis.id).val();
    var searchResult = [];
    if (onStatusSelect) {
        searchResult = ApzCOB.arraySearch(searchText, customerListBasedOnStatus, ["customerName", "kendraName", "productType", "loanAmt",
            "status","customerId","applicationId"], 'LoanDi__CustomersList_Res', "", '', '');
    } else {
        searchResult = ApzCOB.arraySearch(searchText, disbursementList, ["customerName", "kendraName", "productType", "loanAmt", "status","customerId","applicationId"],
            'LoanDi__CustomersList_Res', "", '', '');
    }
    searchResult.forEach((item, index) => {
        item.rowNo = index;
    });
    if (searchResult.length === 0) {
        $("#" + LoanDisbursementScrId + "noFromAccountsRow").removeClass("sno");
        $("#" + LoanDisbursementScrId + "customerList").addClass("sno");
    } else {
        $("#" + LoanDisbursementScrId + "noFromAccountsRow").addClass("sno");
        $("#" + LoanDisbursementScrId + "customerList").removeClass("sno");
    }
    if (searchText.length === 0) {
        if (onStatusSelect) {
            apz.data.scrdata.LoanDi__CustomersList_Res.Customer = customerListBasedOnStatus;
            if (apz.deviceType === 'WEB') {
                apz.app.LoanDisbursementList.funcPagination(customerListBasedOnStatus);
            }
        } else {
            apz.data.scrdata.LoanDi__CustomersList_Res.Customer = disbursementList;
            if (apz.deviceType === 'WEB') {
                apz.app.LoanDisbursementList.funcPagination(disbursementList);
            }
        }
        $("#" + LoanDisbursementScrId + "noFromAccountsRow").addClass("sno");
        $("#" + LoanDisbursementScrId + "customerList").removeClass("sno");
    } else {
        apz.data.scrdata.LoanDi__CustomersList_Res = {};
        apz.data.scrdata.LoanDi__CustomersList_Res.Customer = searchResult;
        if (apz.deviceType === 'WEB') {
            apz.app.LoanDisbursementList.funcPagination(searchResult);
        }
    }
    if (apz.deviceType !== 'WEB') {
        apz.data.loadData("CustomersList", 'LoanDi');
    };
    apz.app.LoanDisbursementList.loadcrtData('Customer');
}
var div = ['kmFlow', 'sc_row_688', 'gr_row_67', 'sc_row_499', 'gr_row_106', 'gr_row_72']
apz.app.LoanDisbursementList.viewAllDetails = function() {
    $('#' + LoanDisbursementScrId + 'stage2').removeClass('sno')
    $('#' + LoanDisbursementScrId + 'successDiv').addClass('sno');
    div.forEach(function(k, i) {
        $('#' + LoanDisbursementScrId + k).addClass('sno');
    })
    $('#' + LoanDisbursementScrId + 'el_txt_376_txtcnt').text('Moved to BM');
    $('#' + LoanDisbursementScrId + 'sc_row_485').addClass('sno');
}
apz.app.LoanDisbursementList.ageValidation = function() {
    ageValidation = true;
    var depDob;
    var term = parseInt(custData.customerDtls.loanDtls.term)
    if (custData.customerDtls.kycDtls.maritalStatus === 'MARRIED') {
        custData.customerDtls.earnings.forEach(function (k, i) {
            if (custData.customerDtls.earnings[i].memRelation === "SPOUSE") {
              depDob = custData.customerDtls.earnings[i].dob;
            }
          });
        custEligibleWeeks = Math.floor(ApzCOB.eligibleWeeks(custData.customerDtls.kycDtls.dob, 'customer'));
        spouseEligibleWeeks = Math.floor(ApzCOB.eligibleWeeks(depDob, ''));
        var spouseChecked = custData.customerDtls.loanDtls.insurDtls.Spouse
        if (custEligibleWeeks === 0) {
            ApzCOB.fnDisplayMsg("Age of customer is greater than 65 years", "E");
            ageValidation = false
            return false;
        }
        if (custEligibleWeeks >= term) {
            if (spouseEligibleWeeks <= term && spouseChecked === 'Y') {
                ApzCOB.fnDisplayMsg("Insurance not valid for spouse age", "E");
                ageValidation = false
                return false;
            }
        } else {
            ApzCOB.fnDisplayMsg("Customer age is not eligible for selected tenure, Application can be submitted with lesser tenure", "E");
            return false;
        }
    } else {
        custEligibleWeeks = Math.floor(ApzCOB.eligibleWeeks(custData.customerDtls.kycDtls.dob, 'customer'));
        if (custEligibleWeeks < term) {
            ApzCOB.fnDisplayMsg("Customer age is not eligible for selected tenure, Application can be submitted with lesser tenure", "E");
            ageValidation = false
            return false;
        }
    }
    return ageValidation
}
apz.app.LoanDisbursementList.approve = function() {
    checked = $('#LoanDi__LoanDisbursementList__el_btn_37').is(":checked")
    var isEnableDisableBtn = true;
     if(isEnableDisableBtn){
        $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', true);
        var isEnableDisableBtn = false;
    }
    if (IncomeApp.isQuestionComplete) {
        if (checked) {
            isEnableDisableBtn = false;
            //ApzCOB.toggleModal(BaseScrId + "otpAuthModal");
            //if (apz.app.LoanDisbursementList.nextMeetingDate()) {
            if (apz.app.LoanDisbursementList.ageValidation()) {
                ageValidation = false;
                apz.app.LoanDisbursementList.savepreClosureLoanFinal();
            }
            //apz.app.LoanDisbursementList.moveToBm();
            /*} else {
                ApzCOB.fnDisplayMsg('Tomorrow is the meeting day please disburse tomorrow', "E");
            }*/
        } else {
            ApzCOB.fnDisplayMsg('Please verify the above customers original documents', "E");
             $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
        }
    } else {
         //ApzCOB.fnDisplayMsg('Please add the Household Details for loan disbursement', "E");
         ApzCOB.fnDisplayMsg("The Income Assessment Questionnaire is pending.Do you want to add questionnaire??", "C", apz.app.LoanDisbursementList.proceedCB);
         $(".ajs-button.ajs-ok").text("Yes");
         $(".ajs-button.ajs-cancel").text("No");
         $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
    }
}
apz.app.LoanDisbursementList.approveEsign = function() {
    checked = $('#LoanDi__LoanDisbursementList__el_btn_37').is(":checked")
    if (checked) {
        ApzCOB.toggleModal(BaseScrId + "otpAuthModal");
        $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', '');
        $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', 'apz.app.LoanDisbursementList.cbConsent()');
    } else {
        ApzCOB.fnDisplayMsg('Please verify the above customers original documents', "E");
    }
}
apz.app.LoanDisbursementList.confirmEsign = function() {
    ApzCOB.toggleModal(BaseScrId + "otpAuthModal");
    $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', '');
    $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', 'apz.app.LoanDisbursementList.moveToBm()');
    //ApzCOB.toggleModal(BaseScrId + "otpAuthModal");
}
apz.app.LoanDisbursementList.cbConsent = function() {
    ApzCOB.toggleModal(BaseScrId + "otpAuthModal");
    $('#APZCBO__BaseScreens__el_btn_64').attr('onClick', '');
    ['stage2'].hide();
    ['CBconsentDiv'].show();
}
apz.app.LoanDisbursementList.activeloanlist = function() {
    var activeloanDtls = $('#' + LoanDisbursementScrId + 'activeloanDtls');
    let activeLoanList = [];
    if ((activeloanDtls).hasClass('sno')) {
        if (custData.customerDtls && custData.customerDtls.loanDtls && custData.customerDtls.loanDtls.activeLoanDtls && custData.customerDtls
            .loanDtls.activeLoanDtls.length > 0) {
            activeloanDtls.removeClass('sno');
            custData.customerDtls.loanDtls.activeLoanDtls.forEach(function(el, i) {
                if (el.status !== 'CLOSED') {
                    var wks = ApzCOB.findMaturityWeek(el.lnMatDate);
                    var loanAmt=el.approvedAmt;
                    if (apz.isNull(el.approvedAmt)) {
                     loanAmt=el.amount;
                    }
                    var maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(el.lnMatDate), "dd/mm/yy");
                    let lObj = {
                        maturityDate: wks + ' Wks ' + '(' + maturityDate + ')',
                        product: el.shortDesc,
                        loanId: el.loanId,
                        description: el.description,
                        loanAmount:" " + loanAmt,
                        dueAmt: " " + parseInt(el.outstandingPrincipal) + ' (  ' + (parseInt(el.overdueInterest) + parseInt(el
                            .overduePrincipal)) + ' )'
                    };
                    activeLoanList.push(lObj);
                }
            });
            if (activeLoanList.length > 0) {
                apz.data.scrdata.LoanDi__ActiveLoans_Res = {};
                apz.data.scrdata.LoanDi__ActiveLoans_Res.LoanDtls = activeLoanList;
                apz.data.loadData("ActiveLoans", 'LoanDi');
            }
        } else {
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_NO_EXIST_LOAN_AVAIL"), "I");
        }
    } else {
        activeloanDtls.addClass('sno');
    }
}
// Upload Document
apz.app.LoanDisbursementList.selectDocument = function() {
    apz.startLoader();
    if (apz.deviceOs === 'iOS') {
        var json = {};
        json.id = "IMPORT_DEVICE_FILES_ID";
        json.callBack = apz.app.LoanDisbursementList.selectDocumentCB;
        apz.ns.importDeviceFiles(json);
    } else if (apz.deviceOs === 'ANDROID') {
        var json = {
            "fileCategory": "EXTERNAL",
            "location": "",
            "openFile": "N",
            "id": "FILEBROWSER_ID",
            "callBack": apz.app.LoanDisbursementList.selectDocumentCB
        };
        apz.ns.fileBrowser(json);
    }
};
var basefileURI = "";
apz.app.LoanDisbursementList.selectDocumentCB = function(params) {
    apz.stopLoader();
    if (params.status == true) {
        selFilePath = params.filePath;
        var filePath = selFilePath.split('/')
        var path = '';
        for (var i = 0; i < filePath.length - 1; i++) {
            if (filePath[i] != '') {
                path += '/' + filePath[i];
            }
        }
        var fileTypeArr = filePath[filePath.length - 1].split('.');
        var fileType = fileTypeArr[fileTypeArr.length - 1];
        if (fileType.toLowerCase() == 'jpg' || fileType.toLowerCase() == 'gif' || fileType.toLowerCase() == 'pdf' || fileType.toLowerCase() ==
            'png') {
            if (apz.deviceOs === 'ANDROID') {
                //basefileURI = params.fileURI;
                basefileURI = params.fileURi;
            }
            apz.app.LoanDisbursementList.getFileSizeplugin(params.filePath);
        } else {
            // Show error
            // $("#" + UpDocsScrId + selectedDocTypeIface + "Err").removeClass('sno');
            // $("#" + UpDocsScrId + selectedDocTypeIface + "_Name").html(filePath[filePath.length - 1]);
            // $("#" + UpDocsScrId + selectedDocTypeIface + "_Err").html("File format unsupported");
        }
    }
};
apz.app.LoanDisbursementList.getFileSizeplugin = function(selFilePath) {
    var json = {
        "id": "FILESIZE",
        "callBack": apz.app.LoanDisbursementList.getFileSizepluginCB,
        "filePath": selFilePath
    };
    apz.ns.getFileSize(json);
}
var filesizeval = "";
apz.app.LoanDisbursementList.getFileSizepluginCB = function(params) {
    if (params.status == true) {
        var filePath = selFilePath.split('/');
        var path = '';
        for (var i = 0; i < filePath.length - 1; i++) {
            if (filePath[i] != '') {
                path += '/' + filePath[i];
            }
        }
        filesizeval = params.fileSize;
        selectedFileSize = filesizeval / 1000;
        selectedFileSize = selectedFileSize.toFixed(3) + " MB";
        if (filesizeval < 5000) {
            sizeVal = true;
        } else {
            sizeVal = false;
        }
        if (sizeVal) {
            var json = {};
            json.id = "FILETOBASE64";
            json.callBack = apz.app.LoanDisbursementList.convertToBase64CB;
            json.filePath = selFilePath;
            if (apz.deviceOs === 'ANDROID') {
                json.fileURI = basefileURI;
            }
            apz.ns.fileToBase64(json);
        } else {
            // $("#" + UpDocsScrId + selectedDocTypeIface + "Err").removeClass('sno');
            // $("#" + UpDocsScrId + selectedDocTypeIface + "_Name").html(filePath[filePath.length - 1]);
            // $("#" + UpDocsScrId + selectedDocTypeIface + "_Err").html("Please upload a smaller file (5 MB or less)");
        }
    }
};
apz.app.LoanDisbursementList.convertToBase64CB = function(params) {
    if (params.hasOwnProperty("text")) {
        docBase64Val = params.text;
    } else {
        docBase64Val = params.base64;
    }
    var filePath = selFilePath.split('/');
    var path = '';
    for (var i = 0; i < filePath.length - 1; i++) {
        if (filePath[i] != '') {
            path += '/' + filePath[i];
        }
    }
    var fileTypeArr = filePath[filePath.length - 1].split('.');
    var fileType = fileTypeArr[fileTypeArr.length - 1];
    // apz.app.UploadDocs.getFileSizeCB(params.text.split('\n').join(''))
    var fileNameObj = {
        "name": filePath[filePath.length - 1],
        "path": path,
        "fileSize": selectedFileSize,
        "fileType": fileType,
        "base64": docBase64Val.split('\n').join('')
    }
    if (sizeVal) {
        apz.setElmValue(LoanDisbursementScrId + "fileName", fileNameObj.name);
        // uploadedDocArray[selectedDocTypeIface].push(fileNameObj);
        // $("#" + UpDocsScrId + selectedDocTypeIface + "_list").removeClass('sno');
        // apz.data.scrdata['UpDocs__' + selectedDocTypeIface + 'Paint_Res'] = uploadedDocArray[selectedDocTypeIface];
        // if (uploadedDocArray[selectedDocTypeIface].length > 4) {
        //     $("#UpDocs__UploadDocs__" + selectedDocTypeIface + "_btn_ul button").attr('disabled', 'true');
        // }
        // apz.data.loadData(selectedDocTypeIface + 'Paint');
        // var liLen = $("#UpDocs__UploadDocs__" + selectedDocTypeIface + "_list li").length;
        // for (var li = 0; li < liLen; li++) {
        //     if ($('#' + $("#UpDocs__UploadDocs__" + selectedDocTypeIface + "_list_row_" + li).find(".File__name__list__doc").attr('id') + ' span')
        //         .html() == '') {
        //         $("#UpDocs__UploadDocs__" + selectedDocTypeIface + "_list_row_" + li).hide();
        //     } else {
        //         $("#UpDocs__UploadDocs__" + selectedDocTypeIface + "_list_row_" + li).show();
        //     }
        // }
        // // doc upload non mandatory changes starts
        // // $("#UNORMB__BaseScreens__continue").prop('disabled', false);
        // $("#UNORMB__BaseScreens__continue").html('Continue');
        // // doc upload non mandatory changes ends
    } else {
        $("#" + UpDocsScrId + selectedDocTypeIface + "Err").removeClass('sno');
        $("#" + UpDocsScrId + selectedDocTypeIface + "_Name").html(filePath[filePath.length - 1]);
        $("#" + UpDocsScrId + selectedDocTypeIface + "_Err").html("Please upload a smaller file (5 MB or less)");
    }
};
apz.app.LoanDisbursementList.closeApp = function() {
    if (window.currentUserRole === "DEO"){
    ApzCOB.fetchKendraDetailsDeo(LoggedInUserDetails.loginResponse.addInfo2);
    } else {
     ApzCOB.dashboardAppListAPI();
    }
   
}
apz.app.LoanDisbursementList.clickRejectSanctionLoan = function() {
    ApzCOB.toggleModal(LoanDisbursementScrId + "rejectToggle");
    let paintData = loanRejectionReasons.map((data) => ({
        reasons: data
    }));
    apz.data.scrdata.LoanDi__CustomersList_Res = {};
    apz.data.scrdata.LoanDi__CustomersList_Res.RejectReasonList = paintData;
    apz.data.loadData("CustomersList", 'LoanDi');
    apz.app.LoanDisbursementList.loadcrtData('Customer');
}
apz.app.LoanDisbursementList.onClickOfRejectionCheckBox = function(pthis) {
    let id = pthis.id.split('_').at(-1);
    if (apz.data.scrdata.LoanDi__CustomersList_Res.RejectReasonList[id].reasons === 'Others' && $("#" + pthis.id).prop("checked")) {
        apz.app.LoanDisbursementList.removeSnoClassForTextArea("LoanDi__CustomersList__o__RejectReasonList__reasons_" + id,
            LoanDisbursementScrId + "textArea_row", "ADD");
    } else if (apz.data.scrdata.LoanDi__CustomersList_Res.RejectReasonList[id].reasons === 'Others' && (!$("#" + pthis.id).prop("checked"))) {
        apz.app.LoanDisbursementList.removeSnoClassForTextArea("LoanDi__CustomersList__o__RejectReasonList__reasons_" + id,
            LoanDisbursementScrId + "textArea_row", "REMOVE");
    }
    apz.data.scrdata.LoanDi__CustomersList_Res.RejectReasonList.forEach((data, index) => {
        if (index !== parseInt(id)) {
            $("#" + LoanDisbursementScrId + "el_cbx_17_" + index).prop("checked", false);
            apz.app.LoanDisbursementList.removeSnoClassForTextArea("LoanDi__CustomersList__o__RejectReasonList__reasons_" + index,
                LoanDisbursementScrId + "textArea_row", "REMOVE");
        }
    })
}
apz.app.LoanDisbursementList.onClickOfSubmitRejectList = function() {
    rejSelReason = apz.app.LoanDisbursementList.collectSubmitData();
    if(apz.isNull(rejSelReason)){
        ApzCOB.fnDisplayMsg('Reason is not selected!', "I");
        return;
    }
    ApzCOB.toggleModal(LoanDisbursementScrId + "rejectToggle");
    let role = userRole
    var workflowId,stage
    if(role === 'BM'){
        workflowId = "DISBURSE"
        stage = "DISBURSEMENT"
    }else{
        workflowId = "SANCTION"
        stage = "SANCTIONED"
    }
    var workflow = {
        "currentRole": role,
        "action": "REJECT",
        "workflowId": workflowId,
        "stage": stage,
        "remarks": rejSelReason
    }
    ApzCOB.updateAppication(workflow);
}
apz.app.LoanDisbursementList.paintRejectFlowData = function() {
    var rejectPreclosedAmt = 0;
    var activeLoans = custData.customerDtls.loanDtls.activeLoanDtls
    activeLoans.forEach(function(el, i) {
        if (activeLoans[i].status === "CLOSED") {
            rejectPreclosedAmt = parseInt(rejectPreclosedAmt) + parseInt(activeLoans[i].approvedAmt);
        }
    })
    //$("#" + LoanDisbursementScrId + "rejectedMoreOptDiv").removeClass("sno");
    $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
    if (userRole === 'KM') {
        $("#" + LoanDisbursementScrId + "stage3").addClass("sno");
    }
    $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
    document.getElementById(LoanDisbursementScrId + 'rejectReason').innerText = rejSelReason;
    $("#" + LoanDisbursementScrId + "newLoanList").removeClass('sno');
    var custName = custData.customerName + " (" + ApzCOB.fn_FormatAmount(custData.amount) + " " + custData.customerDtls.loanDtls.productType +
        ")";
    apz.setElmValue(LoanDisbursementScrId + "rejectInterest", (KendraLoans.cbResponse.roi ?? 'NO DATA') + "%");
    apz.setElmValue(LoanDisbursementScrId + "rejectTenure", custData.customerDtls.loanDtls.term ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "rejectLoanCharges", custData.customerDtls.loanDtls ? ApzCOB.fn_FormatAmount(custData.customerDtls
        .loanDtls.chargeAndBreakupDtls.addInfo1) : 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "rejectFrequency", custData.customerDtls.loanDtls.repayFrequency.idDesc ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "rejectPreclosedAmount", ' ' + ApzCOB.fn_FormatAmount(totPreCloAmtFinal));
    apz.setElmValue(LoanDisbursementScrId + "sucRefId", 'No DATA');
    apz.setElmValue(LoanDisbursementScrId + "el_txt_812", "Loan ID #" + custData.applicationId);
    apz.setElmValue(LoanDisbursementScrId + "rejCustName", custName);
    apz.setElmValue(LoanDisbursementScrId + "sucRefId", "#" + custData.applicationId);
    /*let pedingData = disbursementList.filter((data) => (data.status === 'Pending'));
    if (pedingData.length === 0) {
        $("#" + LoanDisbursementScrId + 'gr_row_155').addClass('sno');
        $("#" + LoanDisbursementScrId + 'noRecDiv').removeClass('sno');
    } else {
        $("#" + LoanDisbursementScrId + 'gr_row_155').removeClass('sno');
        $("#" + LoanDisbursementScrId + 'noRecDiv').addClass('sno');
        pedingData = pedingData.slice(0, 4);
        
    }*/
    disbursementList = disbursementList.filter(function(item) {
        return item.customerId !== KendraApp.selectedDisbursement.customerId;
    });
    var z = [];
    disbursementList.forEach((item) => {
        if (item.status === 'Pending') {
            z.push(item);
        }
    });
    if (z.length === 0) { // Display "No records found" message
        $("#" + LoanDisbursementScrId + 'gr_row_155').addClass('sno');
        $("#" + LoanDisbursementScrId + 'noRecDiv').removeClass('sno');
    } else {
        $("#" + LoanDisbursementScrId + 'gr_row_155').removeClass('sno');
        $("#" + LoanDisbursementScrId + 'noRecDiv').addClass('sno');
    }
    var x = [];
    if (z.length >= 4) {
        $("#" + LoanDisbursementScrId + 'el_btn_62').removeClass('sno'); // Show the "View More" button
        x = z.slice(0, 4);
    } else {
        $("#" + LoanDisbursementScrId + 'el_btn_62').addClass('sno');
        x = z;
    }
    apz.data.scrdata.LoanDi__CustomersList_Res.RejectCustomerList = {};
    apz.data.scrdata.LoanDi__CustomersList_Res.RejectCustomerList = x;
    apz.data.loadData("CustomersList", 'LoanDi');
    apz.app.LoanDisbursementList.loadcrtData('Customer');
    // document.getElementById(LoanDisbursementScrId + 'rejectedMoreOptDiv').style.backgroundColor = '#FCE4E4';
    // document.getElementById(LoanDisbursementScrId + 'ct_nav_33').style.backgroundColor = '#BB3333';
    // document.getElementById(LoanDisbursementScrId + 'sc_col_1341').style.backgroundColor = '#BB3333';
    // document.getElementById(LoanDisbursementScrId + 'ct_frm_140').style.backgroundColor = '#BB3333';
}
apz.app.LoanDisbursementList.clickMoreOptionsBtn = function() {
    if ($("#" + LoanDisbursementScrId + "rejectedMoreOptDiv").hasClass("sno")) {
        $("#" + LoanDisbursementScrId + "rejectedMoreOptDiv").removeClass("sno");
    } else {
        $("#" + LoanDisbursementScrId + "rejectedMoreOptDiv").addClass("sno");
    }
}
apz.app.LoanDisbursementList.succMoreOptionsBtn = function() {
    if ($("#" + LoanDisbursementScrId + "sucMoreOptDiv").hasClass("sno")) {
        $("#" + LoanDisbursementScrId + "sucMoreOptDiv").removeClass("sno");
    } else {
        $("#" + LoanDisbursementScrId + "sucMoreOptDiv").addClass("sno");
    }
}
apz.app.LoanDisbursementList.removeSnoClassForTextArea = function(baseId, targetId, method) {
    let baseElement = document.getElementById(baseId);
    let ancestorSpan = baseElement.closest('li');
    let targetElement = ancestorSpan.querySelector(`#${targetId}`);
    if (method === 'ADD') {
        targetElement.classList.remove('sno');
    } else {
        targetElement.classList.add('sno');
    }
}
apz.app.LoanDisbursementList.collectSubmitData = function() {
    let reason;
    apz.data.scrdata.LoanDi__CustomersList_Res.RejectReasonList.forEach((data, index) => {
        if ($("#" + LoanDisbursementScrId + "el_cbx_17_" + index).prop("checked") && (data.reasons !== 'Others')) {
            reason = data.reasons;
        } else if ($("#" + LoanDisbursementScrId + "el_cbx_17_" + index).prop("checked") && data.reasons === 'Others') {
            reason = $("#" + LoanDisbursementScrId + "el_txa_1_" + index).val();
        }
    })
    return reason;
}
apz.app.LoanDisbursementList.editDetails = function() {
    ApzCOB.launchMicroApp('EDITLA', 'EditLoanAndInsurance', 'APZCBO__BaseScreens__BaseDIV', "");
}
apz.app.LoanDisbursementList.generateOtp = function() {
    window.KendraApp.Transpayload.req = {};
    var req = {
        "apiRequest": {
            "interfaceName": "GenerateOTPAndSendSMS",
            "appId": apz.appId,
            "userId": LoggedInUserDetails.userID,
            "requestObj": {
                "payload": {}
            }
        }
    }
    var addInfo = accntDetails.addInfo;
    if (typeof addinfo == 'string') {
        addinfo = JSON.parse(addinfo)
    }
    var branchId = '';
    if (!apz.isNull(addInfo.branchId)) {
        branchId = addInfo.branchId;
    }
    req.apiRequest.requestObj = window.t24ReqObj;
    req.apiRequest.requestObj.actionType = "OTP_SEND";
   // req.apiRequest.requestObj.mobileNo = "9538145309";
    req.apiRequest.requestObj.mobileNo = custData.customerDtls.mobileNum;
    req.apiRequest.requestObj.accountNo = accntDetails.customerDtls.bankDtls.bankAccNo;
    req.apiRequest.requestObj.customerName = accntDetails.customerName;
    req.apiRequest.requestObj.applicationId = accntDetails.applicationId;
    req.apiRequest.requestObj.branchId = branchId;
    req.apiRequest.requestObj.type = 'DISBURSE';
    req.apiRequest.requestObj.userRole=currentUserRole;
    req.apiRequest.requestObj.appVersion=appVersion;
    req.apiRequest.requestObj.remarks = 'The Loan disbursed by(OTP)'+LoggedInUserDetails.userID +' ('+currentUserRole +').';
    req.apiRequest.requestObj.userName=LoggedInUserDetails.loginResponse.userDet.name;
    req.apiRequest.requestObj.userId=LoggedInUserDetails.userID;
    req.apiRequest.requestObj.workflowId = "GenerateOTPAndSendSMS";
    req.apiRequest.requestObj.interfaceName = "GenerateOTPAndSendSMS";
    req.apiRequest.workflowId = "GenerateOTPAndSendSMS";
    req.apiRequest.interfaceName = "GenerateOTPAndSendSMS";
    window.KendraApp.Transpayload.req = req;
    apz.startLoader();
    ApzCOB.serverBuildParam(gAppId, "WorkFlowService", "N", "N", req, true, apz.app.LoanDisbursementList.generateOtpCB);
};
apz.app.LoanDisbursementList.generateOtpCB = function(params) {
    apz.stopLoader();
    if (ApzCOB.handleServiceCallBacks(params)) {
        if (!apz.isNull(params.res.APZCBO__WorkFlowService_Res.apiResponse.ResponseBody.responseObj)) {
            var otpRes = JSON.parse(params.res.APZCBO__WorkFlowService_Res.apiResponse.ResponseBody.responseObj);
            var errorMsg='';
            if(!apz.isNull(otpRes.apiResponse.ResponseBody.DisburseMessage)){
              errorMsg=otpRes.apiResponse.ResponseBody.DisburseMessage;  
            }
            if (!apz.isNull(errorMsg)) {
                ApzCOB.toggleModal(LoanDisbursementScrId + "mobConfirmModal");
                ApzCOB.fnDisplayMsg('Disbursement is permitted only within the permissible time.', "I");
            } else {
                otpRes = JSON.parse(otpRes.apiResponse.ResponseBody.responseObj).GenerateOTP;
                window.KendraApp.Transpayload.otpResObj = otpRes;
                window.KendraApp.Transpayload.Module = "LOAN";
                var req = {
                    "apiRequest": {
                        "interfaceName": "ValidateOTPAndDisbursement",
                        "appId": gAppId,
                        "userId": LoggedInUserDetails.userID,
                        "requestObj": window.t24ReqObj
                    }
                }
                req.apiRequest.requestObj.applicationId = accntDetails.applicationId;
                req.apiRequest.requestObj.versionNo = accntDetails.versionNo;
                req.apiRequest.requestObj.schedulerEnabled = "N";
                req.apiRequest.requestObj.userRole = currentUserRole;
                req.apiRequest.requestObj.appVersion = appVersion;
                req.apiRequest.requestObj.userName = LoggedInUserDetails.loginResponse.userDet.name;
                req.apiRequest.requestObj.userId = LoggedInUserDetails.userID;
                req.apiRequest.requestObj.remarks = 'The Loan disbursed by'+LoggedInUserDetails.userID +' ('+currentUserRole +').';
                req.apiRequest.requestObj.otp = "";
                req.apiRequest.requestObj.RefNo = "";
                req.apiRequest.workflowId = "ValidateOTP";
                req.apiRequest.interfaceName = "ValidateOTPAndDisbursement";
                KendraApp.WorkflowRequest = req;
                ApzCOB.LaunchAuthentication("", "LoanDi__LoanDisbursementList__mobConfirmModal", "LoanDi__LoanDisbursementList__AuthenticateBaseDiv",
                    "apz.app.LoanDisbursementList.cancelAuthentication", "apz.app.LoanDisbursementList.validateOtpCB", req, 'OTP',
                    "apz.app.LoanDisbursementList.failureFn");
            }
        }
    }
};
apz.app.LoanDisbursementList.failureFn = function(params) {
    apz.stopLoader();
};
apz.app.LoanDisbursementList.cancelAuthentication = function(params) {
    apz.stopLoader();
};
apz.app.LoanDisbursementList.validateOtpCB = function(params) {
    apz.stopLoader();
    if (!apz.isNull(params.header) && !apz.isNull(params.linkedActivities)) {
        KendraApp.disbursedApp = params;
        if (!apz.isNull(params.header.id) && !apz.isNull(params.linkedActivities[0].body.arrangementId)) {
            KendraApp.LoanId = params.header.id;
            $("#" + LoanDisbursementScrId + "loanRow").removeClass("sno");
            apz.setElmValue(LoanDisbursementScrId + "sucLoanId", "Loan ID:#" + KendraApp.LoanId);
            $("#LoanDi__LoanDisbursementList__el_txt_687").addClass("sno");
            $("#LoanDi__LoanDisbursementList__el_txt_688").removeClass("sno");
            $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
            $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
            $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
            $("#" + LoanDisbursementScrId + "failureDiv").addClass("sno");
            $("#" + LoanDisbursementScrId + "successDiv").removeClass("sno");
            apz.app.LoanDisbursementList.finalSubmitByBM();
        } else {
            $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
            $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
            $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
            $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
            //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
            //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
            $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
            ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
        }
    } else if (!apz.isNull(params.header) && !apz.isNull(params.error)) {
        KendraApp.disbursedApp = params;
        if (apz.isNull(params.error.errorDetails)) {
            $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
            $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
            $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
            $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
            //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
            //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
            $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
            ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
            apz.app.LoanDisbursementList.t24RejectCaseHandle();
        } else if (!apz.isNull(params.header.id) && !apz.isNull(params.error.errorDetails[0].code)) {
            $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
            $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
            $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
            $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
            //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
            //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
            $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
            ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
            apz.app.LoanDisbursementList.t24RejectCaseHandle();
        } else if (!apz.isNull(params.header.status === 'failed') && !apz.isNull(params.error.errorDetails[0].code)) {
            $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
            $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
            $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
            $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
            //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
            //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
            $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
            ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
            apz.app.LoanDisbursementList.t24RejectCaseHandle();
        }
    } else {
        ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
        ApzCOB.fnDisplayMsg('Some technical issue occurred, Please try again', "E");
        /*$("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
        $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
        $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
        $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
        //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
        //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
        $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
        ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");*/
    }
}
apz.app.LoanDisbursementList.onCLickLoanFilter = function() {
    ApzCOB.toggleModal(LoanDisbursementScrId + "filterModal");
    apz.data.scrdata.LoanDi__IPaintBtnFilter_Res = btnFiltrLoanSanct;
    apz.data.loadData("IPaintBtnFilter", "LoanDi");
    $('#LoanDi__LoanDisbursementList__ct_lst_49_row_0, #LoanDi__LoanDisbursementList__branchList').hide();
    $('#' + LoanDisbursementScrId + "loanList").removeClass('sno');
    $('#' + LoanDisbursementScrId + "kmList").addClass('sno');
    $('#' + LoanDisbursementScrId + "ct_lst_53").addClass('sno');
    $('#' + LoanDisbursementScrId + "ct_lst_49_row_0").removeClass('active');
    $('#' + LoanDisbursementScrId + "ct_lst_49_row_1").addClass('active');
    $('#' + LoanDisbursementScrId + "ct_lst_49_row_2").removeClass('active');
    $('#' + LoanDisbursementScrId + "ct_lst_49_row_3").removeClass('active');
    apz.app.LoanDisbursementList.filterBranchLoan();
    if ((window.userRole !== "BM") || (window.userRole == "KM" ||isSelfAssigned)) {
        $('#' + LoanDisbursementScrId + "ct_lst_49_row_2").addClass('sno');
        // $('#' + LoanDisbursementScrId + "ct_lst_49_row_3").addClass('sno');
    } else {
        $('#' + LoanDisbursementScrId + "ct_lst_49_row_2").removeClass('sno');
        // $('#' + LoanDisbursementScrId + "ct_lst_49_row_3").removeClass('sno');
    }
    $('.srb').each(function() {
        let checkbox = $(this).find('input[type="checkbox"]');
        let activeRow;
        if ($(this).closest('#' + LoanDisbursementScrId + "ct_lst_49_row_0").length) {
            activeRow = 'row_0';
        } else if ($(this).closest('#' + LoanDisbursementScrId + "ct_lst_49_row_1").length) {
            activeRow = 'row_1';
        } else if ($(this).closest('#' + LoanDisbursementScrId + "ct_lst_49_row_2").length) {
            activeRow = 'row_2';
        } else if ($(this).closest('#' + LoanDisbursementScrId + "ct_lst_53_row_4").length) {
            activeRow = 'row_4';
        }
        if ($(this).index() !== 0 && !checkbox.prop('checked')) {
            allCheckboxCheckedDisb[activeRow] = false;
        }
    });
}
apz.app.LoanDisbursementList.filterBranchLoan = function() {
    let branchArray = [];
    let loanArray = [],
        product = [];
    let kmNamesArray = [],
        kmName = [];
    var kendraNameArry = [],
        name = [];
    disbursementList.forEach(function(el, i) {
        if (!(name.includes(disbursementList[i].kendraName))) {
            var obj = {
                kendraName: disbursementList[i].kendraName
            };
            kendraNameArry.push(obj);
            name.push(disbursementList[i].kendraName);
        }
        if (!(kmName.includes(disbursementList[i].kmid))) {
            var obj = {
                kmName: disbursementList[i].kmid
            };
            kmNamesArray.push(obj);
            kmName.push(disbursementList[i].kmid);
        }
        if (!(product.includes(disbursementList[i].productType))) {
            var obj = {
                product: disbursementList[i].productType
            };
            loanArray.push(obj);
            product.push(disbursementList[i].productType);
        }
    });
    kendraNameArry.unshift({
        kendraName: "All"
    });
    kmNamesArray.unshift({
        kmName: "All"
    });
    loanArray.unshift({
        product: "All"
    });
    apz.data.scrdata.LoanDi__IPaintKMsName_Res = kmNamesArray;
    apz.data.scrdata.LoanDi__IPaintLoanBranchDtls_Res = kendraNameArry;
    apz.data.scrdata.LoanDi__IPaintLoanDtls_Res = loanArray;
    apz.data.loadData("IPaintKMsName", "LoanDi");
    apz.data.loadData("IPaintLoanBranchDtls", "LoanDi");
    apz.data.loadData("IPaintLoanDtls", "LoanDi");
};
apz.app.LoanDisbursementList.branchLoanSelection = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    $.each(btnFiltrLoanSanct, function(i) {
        if (parseInt(rowNo) === i) {
            $("#" + LoanDisbursementScrId + "ct_lst_49_row_" + i).addClass("active");
        } else {
            $("#" + LoanDisbursementScrId + "ct_lst_49_row_" + i).removeClass("active");
        }
    });
    if (window.userRole === "BM" && !isSelfAssigned) {
        $("#" + LoanDisbursementScrId + "ct_lst_49_row_2").removeClass("sno");
    } else {
        $("#" + LoanDisbursementScrId + "ct_lst_49_row_2").addClass("sno");
    }
    if (pthis.innerText === "Branch") {
        $("#" + LoanDisbursementScrId + "kmList").addClass("sno");
        $("#" + LoanDisbursementScrId + "loanList").addClass("sno");
        $("#" + LoanDisbursementScrId + "branchList").removeClass("sno");
        $("#" + LoanDisbursementScrId + "ct_lst_53").addClass("sno");
    } else if (pthis.innerText === "Loan") {
        $("#" + LoanDisbursementScrId + "kmList").addClass("sno");
        $("#" + LoanDisbursementScrId + "branchList").addClass("sno");
        $("#" + LoanDisbursementScrId + "loanList").removeClass("sno");
        $("#" + LoanDisbursementScrId + "ct_lst_53").addClass("sno");
    } else if (pthis.innerText === "KMs") {
        $("#" + LoanDisbursementScrId + "branchList").addClass("sno");
        $("#" + LoanDisbursementScrId + "loanList").addClass("sno");
        $("#" + LoanDisbursementScrId + "kmList").removeClass("sno");
        $("#" + LoanDisbursementScrId + "ct_lst_53").addClass("sno");
    } else if (pthis.innerText === "Kendra Name") {
        $("#" + LoanDisbursementScrId + "branchList").addClass("sno");
        $("#" + LoanDisbursementScrId + "loanList").addClass("sno");
        $("#" + LoanDisbursementScrId + "kmList").addClass("sno");
        $("#" + LoanDisbursementScrId + "ct_lst_53").removeClass("sno");
    }
};
apz.app.LoanDisbursementList.CheckboxSelection = function(pthis) {
    let checkbox = $(pthis).find('input[type="checkbox"]');
    let isChecked = checkbox.prop('checked');
    let checkboxListSelector, allCheckboxSelector;
    let selectedValues = [];
    let activeRow;
    if ($("#" + LoanDisbursementScrId + "ct_lst_49_row_0").hasClass('active')) {
        checkboxListSelector = "#" + LoanDisbursementScrId + 'branchList';
        allCheckboxSelector = checkboxListSelector + " .srb:first input[type='checkbox']";
        activeRow = 'row_0';
    } else if ($("#" + LoanDisbursementScrId + "ct_lst_49_row_1").hasClass('active')) {
        checkboxListSelector = "#" + LoanDisbursementScrId + 'loanList';
        allCheckboxSelector = checkboxListSelector + " .srb:first input[type='checkbox']";
        activeRow = 'row_1';
    } else if ($("#" + LoanDisbursementScrId + "ct_lst_49_row_2").hasClass('active')) {
        checkboxListSelector = "#" + LoanDisbursementScrId + 'kmList';
        allCheckboxSelector = checkboxListSelector + " .srb:first input[type='checkbox']";
        activeRow = 'row_2';
    } else if ($("#" + LoanDisbursementScrId + "ct_lst_49_row_3").hasClass('active')) {
        checkboxListSelector = "#" + LoanDisbursementScrId + 'ct_lst_53';
        allCheckboxSelector = checkboxListSelector + " .srb:first input[type='checkbox']";
        activeRow = 'row_3';
    }
    if (pthis.innerText === "All") { // If "All" checkbox is clicked
        let allCheckbox = $(allCheckboxSelector);
        allCheckbox.prop('checked', isChecked);
        $(checkboxListSelector + " input[type='checkbox']").not(allCheckbox).prop('checked',
        isChecked); // Check/uncheck other checkboxes based on "All" checkbox
        allCheckboxCheckedDisb[activeRow] = isChecked;
    } else { // If any other checkbox is clicked
        let allCheckbox = $(allCheckboxSelector);
        let otherCheckboxes = $(checkboxListSelector + " input[type='checkbox']").not(allCheckbox); // Check if all other checkboxes are checked
        let allOthersChecked = otherCheckboxes.length > 0 && otherCheckboxes.filter(':checked').length === otherCheckboxes.length;
        if (isChecked && allOthersChecked) {
            allCheckbox.prop('checked', true);
            allCheckboxCheckedDisb[activeRow] = true;
        } else {
            allCheckbox.prop('checked', false);
            allCheckboxCheckedDisb[activeRow] = false;
        }
    }
    $('.srb input[type="checkbox"]').each(function() {
        let checkedValue = $(this).closest('.srb').find('.ett-para > span').text();
        if ($(this).prop('checked')) {
            selectedValues.push(checkedValue);
        }
    });
    selectedCheckboxesDisb = selectedValues;
}
apz.app.LoanDisbursementList.resetBranchLoan = function(pthis) {
    $(".srb").find('input[type="checkbox"]').prop("checked", false).prop("disabled", false);
    ApzCOB.toggleModal(LoanDisbursementScrId + "filterModal");
    apz.data.scrdata.LoanDi__CustomersList_Res.Customer = disbursementList;
    apz.data.loadData("CustomersList", "LoanDi");
    apz.app.LoanDisbursementList.loadcrtData('Customer');
};
apz.app.LoanDisbursementList.applyBranchAndLoan = function(pthis) {
    let selectedBranches = [];
    let selectedLoanProductAmounts = [];
    let selectedKMNames = [];
    let selectedKendraNames = [];
    if ($("#LoanDi__LoanDisbursementList__ct_lst_49_row_0").hasClass("active")) {
        $(".srb").each(function() {
            let branchValue = $(this).find(".ett-para > span").html();
            let checkbox = $(this).find('input[type="checkbox"]');
            if (checkbox.prop("checked")) {
                selectedBranches.push(branchValue);
            }
        });
    } else if ($("#LoanDi__LoanDisbursementList__ct_lst_49_row_1").hasClass("active")) {
        $(".srb").each(function() {
            let loanValue = $(this).find(".ett-para > span").html();
            let checkbox = $(this).find('input[type="checkbox"]');
            if (checkbox.prop("checked")) {
                selectedLoanProductAmounts.push(loanValue);
            }
        });
    } else if ($("#LoanDi__LoanDisbursementList__ct_lst_49_row_2").hasClass("active")) {
        $(".srb").each(function() {
            let kmName = $(this).find(".ett-para > span").html();
            let checkbox = $(this).find('input[type="checkbox"]');
            if (checkbox.prop("checked")) {
                selectedKMNames.push(kmName);
            }
        });
    } else if ($("#LoanDi__LoanDisbursementList__ct_lst_49_row_3").hasClass("active")) {
        $("li[id^='LoanDi__LoanDisbursementList__ct_lst_53_row_']").each(function() {
            let kendraName = $(this).find("p.ett-para > span").html(); // Adjust if HTML structure differs
            let checkbox = $(this).find('input[type="checkbox"]');
            if (checkbox.prop("checked")) {
                selectedKendraNames.push(kendraName);
            }
        });
    }
    if (selectedBranches.length === 0 && selectedLoanProductAmounts.length === 0 && selectedKMNames.length === 0 && selectedKendraNames.length ===
        0) {
        alert("Please select at least one branch, loan, KM, or Kendra.");
        return;
    }
    let filteredCustomers = [];
    if ($('#LoanDi__LoanDisbursementList__ct_lst_49_row_0').hasClass('active')) {
        if (selectedBranches.includes("All")) {
            ApzCOB.toggleModal(LoanDisbursementScrId + "filterModal");
            apz.data.scrdata.LoanDi__CustomersList_Res.Customer = disbursementList;
            apz.data.loadData("CustomersList", "LoanDi");
            apz.app.LoanDisbursementList.loadcrtData('Customer');
            return;
        }
        filteredCustomers = disbursementList.filter(customer => selectedBranches.includes(customer.kendraName));
    } else if ($('#LoanDi__LoanDisbursementList__ct_lst_49_row_1').hasClass('active')) {
        filteredCustomers = disbursementList.filter(customer => selectedLoanProductAmounts.includes(customer.productType));
    } else if ($('#LoanDi__LoanDisbursementList__ct_lst_49_row_2').hasClass('active')) {
        filteredCustomers = disbursementList.filter(customer => selectedKMNames.includes(customer.kmid));
    } else if ($('#LoanDi__LoanDisbursementList__ct_lst_49_row_3').hasClass('active')) {
        filteredCustomers = disbursementList.filter(customer => selectedKendraNames.includes(customer.kendraName));
    }
    ApzCOB.toggleModal(LoanDisbursementScrId + "filterModal");
    apz.data.scrdata.LoanDi__CustomersList_Res.Customer = filteredCustomers;
    if (apz.deviceType === 'WEB') {
        let totalItems = filteredCustomers.length;
        window.pageNo = 1;
        apz.app.LoanDisbursementList.InitialisePagination(totalItems, filteredCustomers);
    } else {
        apz.data.loadData("CustomersList", "LoanDi");
    }
    apz.app.LoanDisbursementList.loadcrtData('Customer');
    // apz.data.loadData("CustomersList", "LoanDi");
    setTimeout(function() {
        $("[id^='LoanDi__LoanStatusList__o__LoanDi__LoanStatusList_Res__status_']").each(function(index) {
            if (index === 0) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
    }, 100);
};
apz.app.LoanDisbursementList.viewDoc = function() {
    ApzCOB.downloadSanctionReport(KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId);
}
apz.app.LoanDisbursementList.downloadDBKit = function() {
    ApzCOB.downloadLoanDBKitReport(KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId);
}
apz.app.LoanDisbursementList.nextMeetingDate = function() {
    var nextdate = new Date(nextMeetingDate)
    var currentDate = new Date();
    var newDate1 = new Date(currentDate);
    var newDate2 = new Date(currentDate);
    var newDate3 = new Date(currentDate);
    newDate1.setDate(currentDate.getDate() + 1);
    newDate2.setDate(currentDate.getDate() + 2);
    newDate3.setDate(currentDate.getDate() + 3);
    //const dateOnly = today.toISOString().split('T')[0];
    if (today < nextdate) {
        console.log('Today is before the nextMeetingDate date.');
        if (meetingDay != 'FRI' && meetingDay != 'SAT') {
            if ((nextdate.toISOString().split('T')[0]) === (newDate1.toISOString().split('T')[0])) {
                return false;
            } else {
                return true;
            }
        } else {
            if ((nextdate.toISOString().split('T')[0]) == (newDate1.toISOString().split('T')[0]) || (nextdate.newDate1.toISOString().split('T')[
                    0]) == (newDate3.newDate1.toISOString().split('T')[0])) {
                return false;
            } else {
                return true;
            }
        }
    } else if (today > nextdate) {
        console.log('Today is after the nextMeetingDate date.');
        return true;
    }
}
apz.app.LoanDisbursementList.editMobile = function() {
    $('#APZCBO__BaseScreens__BaseDIV').addClass('sno');
    let data = {
        selectedCust: custData,
        childScr: 'LoanDisbursementList'
    };
    ApzCOB.launchMicroApp("NEWLOA", "UpdateMobNumber", "APZCBO__BaseScreens__STAGE15", data);
}
apz.app.LoanDisbursementList.onUpdateMobNum = function() {
    window.mobileNoUpdateAtDisbursement = true;
    ApzCOB.saveLoan();
    apz.setElmValue(LoanDisbursementScrId + "el_txt_841", custData.customerDtls.mobileNum);
}
apz.app.LoanDisbursementList.downLoadSanctionLetter = function() {
    ApzCOB.downloadSanctionReport(KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId);
}
apz.app.LoanDisbursementList.downloadDisbBKit = function() {
    ApzCOB.downloadLoanDBKitReport(KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId);
}
apz.app.LoanDisbursementList.InitialisePagination = function(totalItems, dataList) {
    $('#' + LoanDisbursementScrId + PagBtnInp).attr("disabled", false);
    $('#' + LoanDisbursementScrId + 'row_acc_pagiButtons').css('opacity', '1');
    window.totalPaginationPages = Math.ceil(Number(totalItems) / Number(configLimit));
    var page = window.totalPaginationPages > 1 ? "PAGES" : "PAGE";
    apz.setElmValue(LoanDisbursementScrId + "remPages", "of " + window.totalPaginationPages);
    var PageArr = [];
    for (let i = 1; i <= totalPaginationPages; i++) {
        let obj = {
            value: i,
            desc: i
        };
        PageArr.push(obj);
    }
    apz.populateDropdown(document.getElementById(LoanDisbursementScrId + 'dropDownPage'), PageArr);
    window.pageNo = window.pageNo || 1;
    const paginationBar = $('#' + LoanDisbursementScrId + Pagination_Bar);
    if (paginationBar.data('pagination')) {
        paginationBar.pagination('destroy'); // Destroy previous instance
    }
    paginationBar.pagination({
        dataSource: dataList,
        totalNumber: Number(totalItems),
        pageSize: Number(configLimit),
        pageNumber: Number(window.pageNo),
        callback: function(data, pagination) {
            window.pageNo = pagination.pageNumber;
            $('#' + LoanDisbursementScrId + 'dropDownPage').val(window.pageNo);
            apz.app.LoanDisbursementList.displayRecords(dataList); // Display records for the current page
        }
    });
    apz.app.LoanDisbursementList.displayRecords(dataList);
};
apz.app.LoanDisbursementList.FuncPaginationPrev = function() {
    if (window.pageNo > 1) {
        window.pageNo--; // Decrement page number
        $('#' + LoanDisbursementScrId + 'dropDownPage').val(window.pageNo);
        $('#' + LoanDisbursementScrId + Pagination_Bar).pagination('go', window.pageNo); // Go to the previous page
    }
};
apz.app.LoanDisbursementList.FuncPaginationNext = function() {
    if (window.pageNo < window.totalPaginationPages) {
        window.pageNo++; // Increment page number
        $('#' + LoanDisbursementScrId + 'dropDownPage').val(window.pageNo);
        $('#' + LoanDisbursementScrId + Pagination_Bar).pagination('go', window.pageNo); // Go to the next page
    }
};
apz.app.LoanDisbursementList.OnChangeValue = function(pthis) {
    window.pageNo = Number(pthis.value); // Update pageNo when dropdown is changed
    $('#' + LoanDisbursementScrId + Pagination_Bar).pagination('go', window.pageNo); // Go to the selected page
};
apz.app.LoanDisbursementList.displayRecords = function(dataList) {
    const itemsPerPage = configLimit;
    let startIndex = (window.pageNo - 1) * itemsPerPage;
    let endIndex = startIndex + itemsPerPage;
    const currentItems = dataList.slice(startIndex, endIndex);
    $(".paginationjs").addClass("sno");
    $('#' + LoanDisbursementScrId + 'pageForm').removeClass("sno");
    $('#' + LoanDisbursementScrId + Pagination_Bar).removeClass("sno");
    apz.data.scrdata.LoanDi__CustomersList_Res.Customer = currentItems;
    apz.data.loadData("CustomersList", 'LoanDi');
    apz.app.LoanDisbursementList.loadcrtData('Customer');
    // let pendingData = disbursementList.filter(d => d.status === 'Pending');
    // apz.setElmValue(LoanDisbursementScrId + "listCount", `${currentItems.length} / ${disbursementList.length}`);
    // $("#" + LoanDisbursementScrId + "pageItemCount").text(currentItems.length);
};
apz.app.LoanDisbursementList.funcPagination = function(dataList) {
    // let dataList = customerListBasedOnStatus.length > 0 ? customerListBasedOnStatus : disbursementList;
    totalItems = dataList.length;
    if (!apz.isNull(dataList)) {
        $('#' + LoanDisbursementScrId + 'pageForm').removeClass("sno");
        let num = Number(totalItems) / Number(configLimit);
        window.totalPaginationPages = Math.ceil(num);
        if (Number(totalItems) > Number(configLimit)) {
            apz.app.LoanDisbursementList.InitialisePagination(totalItems, dataList);
        } else {
            apz.app.LoanDisbursementList.HidePagination(dataList);
        }
        window.currentPageNumber = window.pageNo;
    } else {
        apz.app.LoanDisbursementList.HidePagination(dataList);
    }
};
apz.app.LoanDisbursementList.HidePagination = function(dataList) {
    if (Number(totalItems) <= Number(configLimit)) {
        $('#' + LoanDisbursementScrId + PagBtnInp).attr("disabled", true);
        $('#' + LoanDisbursementScrId + 'row_acc_pagiButtons').css('opacity', '0.3');
    }
    $('#' + LoanDisbursementScrId + Pagination_Bar).addClass("sno");
    apz.data.scrdata.LoanDi__CustomersList_Res = {};
    apz.data.scrdata.LoanDi__CustomersList_Res.Customer = dataList;
    apz.data.loadData("CustomersList", 'LoanDi');
    apz.app.LoanDisbursementList.loadcrtData('Customer');
};
apz.app.LoanDisbursementList.loadCurrentPageData = function(pageNo) {
    let itemsPerPage = 10; // Set how many items you want to show per page
    let startIndex = (pageNo - 1) * itemsPerPage;
    let endIndex = startIndex + itemsPerPage;
    let paginatedData = customerListBasedOnStatus.slice(startIndex, endIndex);
    apz.data.scrdata.LoanDi__CustomersList_Res.Customer = paginatedData;
    apz.data.loadData("CustomersList", 'LoanDi');
    apz.app.LoanDisbursementList.loadcrtData('Customer');
};
//apz.app.LoanDisbursementList.onClickSelectedKendra();for failure
apz.app.LoanDisbursementList.onPendingSuccRow = function(pthis, type) {
    let rowNumber = $(pthis).attr("rowno");
    let selectedList = [];
    if (type === 'Suc') {
        KendraApp.selectedDisbursement = apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer[rowNumber];
        selectedList = apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer;
    } else {
        KendraApp.selectedDisbursement = apz.data.scrdata.LoanDi__CustomersList_Res.RejectCustomerList[rowNumber];
        selectedList = apz.data.scrdata.LoanDi__CustomersList_Res.RejectCustomerList;
    }
    let selectedCustomer = selectedList[rowNumber];
    //KendraApp.selectedDisbursement = apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer[rowNumber];
    let fullData = disbursementList.find(function(item) {
        return item.applicationId === selectedCustomer.applicationId;
    });
    if (fullData) {
        ApzCOB.fetchLoanApplication(fullData, 'LoanDisbursementList');
    } else {
        console.error("No matching data found for the selected row.");
    }
}
apz.app.LoanDisbursementList.loadcrtData = function(typ) {
    var custList=apz.data.scrdata.LoanDi__CustomersList_Res.Customer;
    var flagId='#LoanDi__LoanDisbursementList__crtFlag_';
    var iqaFlagId='#LoanDi__LoanDisbursementList__iaqFlag_';
    if(typ !=='Customer'){
       custList=apz.data.scrdata.LoanDi__CustomersList_Res.ViewAllCustomer;
       flagId='#LoanDi__LoanDisbursementList__crtFlagSuc_';
       iqaFlagId='#LoanDi__LoanDisbursementList__iaqFlagSuc_';
    }
     custList.forEach(function(m, n) {
        var addinfo = m.addInfo;
        if (typeof addinfo == 'string') {
            addinfo = JSON.parse(addinfo)
        }
        if (apz.isNull(addinfo.isApprovedCRT)) {
            $(flagId + n).addClass('sno')
        } else {
            if (addinfo.isApprovedCRT) {
                // console.log('true'); 
                $(flagId + n).removeClass('sno')
            } else {
                $(flagId + n).addClass('sno')
            }
        }
        if (typeof addinfo.isQuestionComplete === "undefined") {
            $(iqaFlagId + n).addClass('sno')
        } else {
            if (addinfo.isQuestionComplete == 'Update' || addinfo.isQuestionComplete == 'Insert') {
               $(iqaFlagId + n).addClass('sno')
            } else {
                 $(iqaFlagId + n).removeClass('sno')
            }
        }
        // console.log(addinfo.isApprovedCRT,n)
    });
};
apz.app.LoanDisbursementList.loandisbursement = function() {
    window.KendraApp.disbursementFlow = 'NONOTP';
    if (window.KendraApp.amountUpdate) {
        var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
        if (appDate.length === 3) {
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
        }
        ApzCOB.saveLoan()
    } else {
        apz.app.LoanDisbursementList.loanCreationT24Service();
    }
}
apz.app.LoanDisbursementList.generateOtpnew = function() {
    window.KendraApp.disbursementFlow = 'OTP';
    if (window.KendraApp.amountUpdate) {
        var appDate = KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate.split('-');
        if (appDate.length === 3) {
            KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationDate = appDate[1] + '/' + appDate[2] + '/' + appDate[0];
        }
        ApzCOB.saveLoan()
    } else {
        apz.app.LoanDisbursementList.generateOtp();
    }
}
apz.app.LoanDisbursementList.loanCreationT24Service = function() {
    apz.startLoader();
    var req = {
        "apiRequest": {
            "appId": gAppId,
            "interfaceName": "PreClosureLoan",
            "requestObj": window.t24ReqObj
        }
    }
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstartTimer("Loan Creation without otp", req);
        apz.app.BaseScreens.UElogevent("Loan Creation without otp", req);
    }
    req.apiRequest.requestObj.userRole = currentUserRole;
    req.apiRequest.requestObj.appVersion = appVersion;
    req.apiRequest.requestObj.userName = LoggedInUserDetails.loginResponse.userDet.name;
    req.apiRequest.requestObj.userId = LoggedInUserDetails.userID;
    req.apiRequest.requestObj.remarks = 'The Loan disbursed by '+LoggedInUserDetails.userID +' ('+currentUserRole +').';
    ApzCOB.serverBuildParam(gAppId, 'PreClosureLoan', 'N', 'N', req, 'Y', apz.app.LoanDisbursementList.loanCreationT24ServiceCB);
}
apz.app.LoanDisbursementList.loanCreationT24ServiceCB = function(params) {
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstopTimer("Loan Creation without otp", params.req);
    }
    //  console.log("PreClosureLoan", params);
    if (ApzCOB.handleServiceCallBacks(params)) {
        if (!apz.isNull(params.res.APZCBO__PreClosureLoan_Res.apiResponse.ResponseBody.responseObj)) {
            var headerRes = JSON.parse(params.res.APZCBO__PreClosureLoan_Res.apiResponse.ResponseBody.responseObj);
            if (!apz.isNull(headerRes.header) && !apz.isNull(headerRes.linkedActivities)) {
                KendraApp.disbursedApp = headerRes;
                if (!apz.isNull(headerRes.header.id) && !apz.isNull(headerRes.linkedActivities[0].body.arrangementId)) {
                    KendraApp.LoanId = headerRes.header.id;
                    $("#" + LoanDisbursementScrId + "loanRow").removeClass("sno");
                    apz.setElmValue(LoanDisbursementScrId + "sucLoanId", "Loan ID:#" + KendraApp.LoanId);
                    $("#LoanDi__LoanDisbursementList__el_txt_687").addClass("sno");
                    $("#LoanDi__LoanDisbursementList__el_txt_688").removeClass("sno");
                    $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
                    $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
                    $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
                    $("#" + LoanDisbursementScrId + "failureDiv").addClass("sno");
                    $("#" + LoanDisbursementScrId + "successDiv").removeClass("sno");
                    apz.app.LoanDisbursementList.finalSubmitByBM();
                } else {
                    $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
                    $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
                    $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
                    $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
                    //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
                    //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
                    $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
                    //  ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
                }
            } else if (!apz.isNull(headerRes.header) && !apz.isNull(headerRes.error)) {
                KendraApp.disbursedApp = headerRes;
                if (!apz.isNull(headerRes.header.id) && !apz.isNull(headerRes.error.errorDetails[0].code)) {
                    $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
                    $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
                    $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
                    $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
                    //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
                    //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
                    $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
                    // ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
                    apz.app.LoanDisbursementList.t24RejectCaseHandle();
                } else if (!apz.isNull(headerRes.header.status) && headerRes.header.status === "failed" && !apz.isNull(headerRes.error.errorDetails[0].code)){
                // else if (!apz.isNull(params.header.status === 'failed') && !apz.isNull(params.error.errorDetails[0].code)) {
                    $("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
                    $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
                    $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
                    $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
                    //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
                    //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
                    $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
                    //ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
                    apz.app.LoanDisbursementList.t24RejectCaseHandle();
                }
            } else {
                // ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");
                ApzCOB.fnDisplayMsg('Some technical issue occurred, Please try again', "E");
                /*$("#" + LoanDisbursementScrId + "loanRow").addClass("sno");
                $("#" + LoanDisbursementScrId + "stage2").addClass("sno");
                $("#" + LoanDisbursementScrId + "successDiv").addClass("sno");
                $("#" + LoanDisbursementScrId + "failureDiv").removeClass("sno");
                //$('#' + LoanDisbursementScrId + 'textArea2').removeClass('sno');
                //apz.setElmValue("LoanDi__LoanDisbursementList__textArea2", "Failed");
                $("#" + LoanDisbursementScrId + "failureDiv").addClass("failed");
                ApzCOB.toggleModal("Authen__OTPAuthentication__mdl_OTPAuthModal");*/
                $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
            }
        } else {
            apz.stopLoader();
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
            $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
        }
    } else {
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
        $('#LoanDi__LoanDisbursementList__el_btn_56').prop('disabled', false);
    }
    //apz.app.AddLoanDetails.paintconfirmDetails();
    apz.stopLoader();
}
apz.app.LoanDisbursementList.sendSMSLink = function() {
        let addInfo = KendraLoans.custFetchLoanAppRes.applicationdtls[0].addInfo;
        if (typeof addInfo === "string") {
            addInfo = JSON.parse(addInfo);
        }
        const newBranchId = addInfo.branchId;
        var req = {
            "apiRequest": {
                "interfaceName": "SendSMSForSanctionReportLink",
                "appId": "APZCBO",
                "requestObj": {
                    "applicationId": KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId,
                    "actionType": "SANCTION_REPORT_LINK_SEND",
                    "type": '',
                    "branchId": newBranchId,
                    "mobileNo": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerDtls.mobileNum,
                    "customerName": KendraLoans.custFetchLoanAppRes.applicationdtls[0].customerName,
                    "workflowId": "SendSMSForSanctionReportLink"
                },
                "workflowId": "SendSMSForSanctionReportLink"
            }
        };
        ApzCOB.serverBuildParam(gAppId, 'WorkFlowService', 'N', 'N', req, 'Y', apz.app.LoanDisbursementList.sendSMSLinkCB);
   
}
apz.app.LoanDisbursementList.sendSMSLinkCB = function(params) {
    apz.stopLoader();
}
apz.app.LoanDisbursementList.downloadKFS = function(){
    ApzCOB.downloadSanctionReport(KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId,);
}
apz.app.LoanDisbursementList.viewKFS = function() {
    var request = {
	                "apiRequest": {
	                    "appId": "APZCBO",
	                    "interfaceName": "FetchSanctionReport",
	                    "requestObj": {
	                        "appId": "APZCBO",
	                        "applicationId": KendraLoans.custFetchLoanAppRes.applicationdtls[0].applicationId,
	                        "versionNum": "1"
	                    }
	                }
	            }
        apz.startLoader();
	  ApzCOB.serverBuildParam(gAppId, 'FetchSanctionReport', 'N', 'N', request, 'Y', apz.app.LoanDisbursementList.viewKFSCB);
}
apz.app.LoanDisbursementList.viewKFSCB = function (params) {
    apz.stopLoader();
    try {
        if (!apz.isNull(params.res.APZCBO__FetchSanctionReport_Res.apiResponse.ResponseBody.responseObj)) {
            var base64Resp = params.res.APZCBO__FetchSanctionReport_Res.apiResponse.ResponseBody.responseObj;
            if (base64Resp !== '') {
                $('#' + LoanDisbursementScrId + "gr_row_106").addClass('sno')
                $('#' + LoanDisbursementScrId + "gr_row_68").addClass('sno');
                $('#' + LoanDisbursementScrId + "gr_row_64").addClass('sno');
                $('#' + LoanDisbursementScrId + "approveRow").addClass('sno');
                $('#' + LoanDisbursementScrId + "kfsDocMianRow").removeClass('sno');
                $('#' + LoanDisbursementScrId + "kfsHeader").removeClass('sno');
                if (userRole == 'KM') {
                    $('#LoanDi__LoanDisbursementList__existingLoan2').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__confirmDisbur2').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__gr_row_75').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__gr_row_77').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__gr_row_78').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__gr_row_79').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__confirmOnfiled').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__confirmInBranch').addClass('sno');
                    $('#LoanDi__LoanDisbursementList__gr_row_74').addClass('sno');
                }
                var byteCharacters = atob(base64Resp);
                var byteNumbers = new Array(byteCharacters.length);
                for (var i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                var blob = new Blob([byteArray], { type: 'text/html' });
                var htmlUrl = URL.createObjectURL(blob);
                var htmlContainer = document.getElementById("LoanDi__LoanDisbursementList__kfsDocs");
                if (!htmlContainer) {
                    console.error("Error: HTML container element not found!");
                    return;
                }
                htmlContainer.style.cssText = `
                    max-width: 100%;          /* Prevent content from exceeding container */
                    max-height: 600px;        /* Limit height */
                    overflow: auto;           /* Enable scrolling */
                    border: 1px solid #ccc;   /* Optional border for clarity */
                    padding: 10px;            /* Add some space */
                    background-color: white;  /* Ensure background */
                `;
                fetch(htmlUrl)
                    .then(response => response.text()) 
                    .then(html => {
                        htmlContainer.innerHTML = html; 
                    })
                    .catch(error => {
                        ApzCOB.fnDisplayMsg("Error loading document.", "E");
                    });
            } else {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
            }
        } else {
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
        }
    } catch (e) {
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
    }
};
apz.app.LoanDisbursementList.exitKFSDetails = function() {
   ApzCOB.dashboardAppListAPI();
}
apz.app.LoanDisbursementList.addQuestionary = function() {
    $('#APZCBO__BaseScreens__BaseDIV').addClass('sno');
    IncomeApp.flow = 'disburse';
    IncomeApp.applicationDetails=KendraLoans.custFetchLoanAppRes.applicationdtls[0];
    ApzCOB.launchMicroApp('questi', 'AddHouseHoldDetails', 'APZCBO__BaseScreens__STAGE2', '');
}
apz.app.LoanDisbursementList.AddHouseHoldDetailsCB = function() {
    if (IncomeApp.isQuestionComplete) {
        $('#LoanDi__LoanDisbursementList__houseHoldRowKM').addClass('sno');
        $('#LoanDi__LoanDisbursementList__houseHoldRowBM').addClass('sno');
        $('#LoanDi__LoanDisbursementList__houseHoldview').addClass('sno');
    } else {
        if (userRole == 'KM') {
            $('#LoanDi__LoanDisbursementList__houseHoldRowKM').removeClass('sno');
        } else if (userRole == 'BM') {
            $('#LoanDi__LoanDisbursementList__houseHoldRowBM').removeClass('sno');
        }
    }
}
apz.app.LoanDisbursementList.proceedCB = function(params) {
    if (params.choice === true) {
       apz.app.LoanDisbursementList.addQuestionary();
    } else {
        return;
    }
}
apz.app.LoanDisbursementList.viewReportBackNavigation = function() {
    if (viewPassbook || viewCBReport) {
        viewPassbook = false;
        viewCBReport = false;
        $('#' + LoanDisbursementScrId + "gr_row_187").removeClass('sno')
        $('#' + LoanDisbursementScrId + "docMianRow").addClass('sno');
    } else {
        $('#' + LoanDisbursementScrId + "successDiv").removeClass('sno')
        $('#' + LoanDisbursementScrId + "LoanReportsDocumentsDiv").addClass('sno');
        // ['successDiv'].show();
        // ['LoanReportsDocumentsDiv'].hide();
    }
}
var passbookLoanId, passbookApplicationId;
apz.app.LoanDisbursementList.viewReports = function() {
    $('#' + LoanDisbursementScrId + "successDiv").addClass('sno');
    $('#' + LoanDisbursementScrId + "LoanReportsDocumentsDiv").removeClass('sno');
    // ['successDiv'].hide();
    // ['LoanReportsDocumentsDiv'].show();
    apz.setElmValue(LoanDisbursementScrId + "reportCustname", custData.customerName ?? 'NO DATA');
    $('#' + LoanDisbursementScrId + 'reportProfilename').text(custData.customerName.substr(0, 1) || 'A');
    apz.setElmValue(LoanDisbursementScrId + "reportKendraID", custData.kendraId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "reportGroupId", JSON.parse(custData?.addInfo || '{}').groupId ?? 'NO DATA');
    apz.setElmValue(LoanDisbursementScrId + "reportProdName", custData.customerDtls.loanDtls.productType);
    apz.setElmValue(LoanDisbursementScrId + "reportProductAmt", parseFloat(custData.amount) ?? 'NO DATA');
    $('#' + LoanDisbursementScrId + 'sanctionLetterDiv').addClass('sno');
    $('#' + LoanDisbursementScrId + 'disbursementKitDiv').addClass('sno');
    if (apz.deviceType === 'WEB' && ['KM', 'BM', 'DEO'].includes(userRole)) {
        $('#' + LoanDisbursementScrId + 'passbookView').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'passbookDownload_ul').removeClass('sno');
        $('#LoanDi__LoanDisbursementList__el_icn_79_ul').removeClass('sno');
    }
    if (apz.deviceType === 'ANDROID') {
        $('#' + LoanDisbursementScrId + 'passbookView').removeClass('sno');
        $('#' + LoanDisbursementScrId + 'passbookDownload_ul').addClass('sno');
    }
    if(custData.productType === 'EL'){
         $('#' + LoanDisbursementScrId + 'passbookDiv').addClass('sno');
    }
    // var loan = apz.data.scrdata.Custom__LoanDetails_Res.LoanDetailsNode[rowNo]
    // if(loan.isActiveLoan){
    //     $('#' + LoanDisbursementScrId + 'cbReportDiv').addClass('sno');
    //     $('#' + LoanDisbursementScrId + 'passbookDiv').removeClass('sno');
    // }
    // if(loan.isMaitriLoan){
    //     $('#' + LoanDisbursementScrId + 'cbReportDiv').removeClass('sno');
    //     $('#' + LoanDisbursementScrId + 'passbookDiv').removeClass('sno');
    // }
    // passbookLoanId = custData.loanDtls[rowNo].loanId;
    passbookApplicationId = custData.applicationId
}
apz.app.LoanDisbursementList.downloadCbReport = function() {
    apz.startLoader();
    var request = {
        "apiRequest": {
            "appId": "APZCBO",
            "interfaceName": "CBReportDownload",
            "serviceName": "bank",
            "userId": LoggedInUserDetails.userID,
            "requestObj": {
                "loanId": custData.applicationId
            }
        }
    }
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstartTimer("User CBReport Download", request);
        apz.app.BaseScreens.UElogevent("User CBReport Download", request);
    }
    ApzCOB.serverBuildParam(gAppId, 'CBReportDownload', 'N', 'N', request, 'Y', apz.app.LoanDisbursementList.downloadCbReportCB);
}
apz.app.LoanDisbursementList.downloadCbReportCB = function(params) {
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstopTimer("User CBReport Download", params.req);
    }
    apz.stopLoader();
    try {
        //if (ApzCOB.handleServiceCallBacks(params)) {
        if (!apz.isNull(params.res.APZCBO__CBReportDownload_Res.apiResponse.ResponseBody.responseObj)) {
            var base64Resp = params.res.APZCBO__CBReportDownload_Res.apiResponse.ResponseBody.responseObj;
            if (base64Resp.length <= 1000) {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
                return;
            }
            if (base64Resp !== '') {
                if (apz.deviceType === 'WEB') {
                    var fileName = "CB_Report_" + custData.applicationId + ".pdf";
                    var byteCharacters = atob(base64Resp);
                    var byteArray = new Uint8Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteArray[i] = byteCharacters.charCodeAt(i);
                    }
                    var blob = new Blob([byteArray], {
                        type: 'application/pdf'
                    });
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    return;
                } else {
                    //ApzCOB.convertBase64ToFile(base64Resp, "Loan Disbursement Kit");
                    ApzCOB.base64toSavefile(base64Resp, "CB_Report_" + KendraApp.selectedCustomer.selectedApp.applicationId, "CB Report");
                }
            } else {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
            }
        }
    } catch (e) {
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
    }
}
apz.app.LoanDisbursementList.viewCbReport = function() {
    apz.startLoader();
    viewCBReport = true;
    var request = {
        "apiRequest": {
            "appId": "APZCBO",
            "interfaceName": "CBReportDownload",
            "serviceName": "bank",
            "userId": LoggedInUserDetails.userID,
            "requestObj": {
                "loanId": custData.applicationId
            }
        }
    }
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstartTimer("User CBReport Download", request);
        apz.app.BaseScreens.UElogevent("User CBReport Download", request);
    }
    ApzCOB.serverBuildParam(gAppId, 'CBReportDownload', 'N', 'N', request, 'Y', apz.app.LoanDisbursementList.viewCbReportCB);
}
apz.app.LoanDisbursementList.viewCbReportCB = function(params){
      if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstopTimer("User CBReport Download", params.req);
    }
    try {
        let respObj = params.res.APZCBO__CBReportDownload_Res.apiResponse.ResponseBody.responseObj;
        if (!apz.isNull(respObj)) {
            var base64Resp = respObj.replace(/\s/g, ''); // Clean whitespace
            if (base64Resp.length <= 1000) {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
                apz.stopLoader();
                return;
            }
            console.log("[downloadCbReportCB]  Base64 response length:", base64Resp.length);
            // --- Decode Base64 to Uint8Array ---
            var byteCharacters = atob(base64Resp);
            var byteNumbers = new Array(byteCharacters.length);
            for (var i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            var byteArray = new Uint8Array(byteNumbers);
            // --- Create PDF Blob ---
            var blob = new Blob([byteArray], { type: 'application/pdf' });
            var pdfUrl = URL.createObjectURL(blob);
            console.log("[downloadCbReportCB] Blob created. PDF URL:", pdfUrl);
            // --- Get container ---
            var pdfContainer = document.getElementById(LoanDisbursementScrId + "reportPassBook");
            if (!pdfContainer) {
                console.error("[downloadCbReportCB]  PDF container element not found!");
                apz.stopLoader();
                return;
            }
            console.log("[downloadCbReportCB]  PDF container found:", pdfContainer);
            // Toggle UI rows
           $('#' + LoanDisbursementScrId + "gr_row_187").addClass('sno')
            $('#' + LoanDisbursementScrId + "docMianRow").removeClass('sno');
            // Clear container
            pdfContainer.innerHTML = "";
            if (apz.deviceType === 'WEB') {
                // --- For Web: embed viewer ---
                console.log("[downloadCbReportCB] Web mode  embedding PDF in <embed>");
                pdfContainer.innerHTML = `<embed 
                                    src="${pdfUrl}" 
                                    type="application/pdf" 
                                    style="width: 100%; height: 600px; overflow: auto; border: none;" />`;
                                      apz.stopLoader();
            } else {
                // --- For Mobile/Tablet: Render with PDF.js ---
                console.log("[downloadCbReportCB] Mobile/Tab mode  Rendering with PDF.js from blob URL...");
                pdfContainer.style.cssText = `
          max-width: 100%;
          max-height: 600px;
          overflow-x: auto;   /*  enable horizontal scroll */
          overflow-y: auto;
          border: 1px solid #ccc;
          padding: 10px;
          background-color: white;
        `;
                if (!window['pdfjsLib']) {
                    console.error("[downloadCbReportCB]  pdf.js library not loaded!");
                    ApzCOB.fnDisplayMsg("PDF viewer not available.", "E");
                    apz.stopLoader();
                    return;
                }
                pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
                const loadingTask = pdfjsLib.getDocument(pdfUrl); // use blob URL for safety
                loadingTask.promise.then(function (pdf) {
                    console.log("[downloadCbReportCB]  PDF loaded with", pdf.numPages, "pages");
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        pdf.getPage(pageNum).then(function (page) {
                            console.log("[downloadCbReportCB] Rendering page", pageNum, "...");
                            //  Force larger scale for readability
                            const desiredScale = 2.0; // Increase this (e.g., 2.5 or 3) if still small
                            let viewport;
                            try {
                                viewport = page.getViewport({ scale: desiredScale, rotation: page.rotate || 0 });
                            } catch (e) {
                                console.warn("[downloadCbReportCB] v3.x getViewport failed, trying v2.x...");
                                viewport = page.getViewport(desiredScale); // fallback for v2.x
                            }
                            if (!viewport || !viewport.width || !viewport.height ||
                                isNaN(viewport.width) || isNaN(viewport.height)) {
                                console.error("[downloadCbReportCB]  Invalid viewport, forcing fallback size.");
                                viewport = { width: 800, height: 1000, rotation: 0, transform: [1, 0, 0, -1, 0, 1000] };
                            }
                            console.log(`[downloadCbReportCB] Viewport for page ${pageNum}: ${viewport.width}x${viewport.height}`);
                            const pageCanvas = document.createElement("canvas");
                            const context = pageCanvas.getContext("2d");
                            pageCanvas.width = Math.floor(viewport.width);
                            pageCanvas.height = Math.floor(viewport.height);
                            console.log(`[downloadCbReportCB] Page ${pageNum} canvas buffer: ${pageCanvas.width}x${pageCanvas.height}`);
                            //  Keep the actual pixel width, not shrinking to 100%
                            pageCanvas.style.width = pageCanvas.width + "px";
                            pageCanvas.style.height = pageCanvas.height + "px";
                            pageCanvas.style.margin = "0 auto 12px auto";
                            pageCanvas.style.display = "block";
                            pageCanvas.style.border = "1px solid #ccc";
                            pageCanvas.style.background = "#fff";
                            // Add label
                            const label = document.createElement("div");
                            label.innerText = `Page ${pageNum} of ${pdf.numPages}`;
                            label.style.textAlign = "center";
                            label.style.margin = "6px 0";
                            label.style.fontSize = "12px";
                            label.style.color = "#666";
                            pdfContainer.appendChild(label);
                            pdfContainer.appendChild(pageCanvas);
                            const renderTask = page.render({
                                canvasContext: context,
                                viewport: viewport
                            });
                            renderTask.promise.then(function () {
                                console.log(`[downloadCbReportCB]  Page ${pageNum} rendered. Final canvas size: ${pageCanvas.width}x${pageCanvas.height}`);
                                apz.stopLoader();
                            }).catch(err => {
                                console.error("[downloadCbReportCB]  Error rendering page", pageNum, err);
                                  apz.stopLoader();
                            });
                        }).catch(err => {
                            console.error("[downloadCbReportCB]  Error loading page", pageNum, err);
                              apz.stopLoader();
                        });
                    }
                }).catch(err => {
                    console.error("[downloadCbReportCB]  Error loading PDF:", err);
                    ApzCOB.fnDisplayMsg("Error loading document.", "E");
                      apz.stopLoader();
                });
            }
        } else {
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
              apz.stopLoader();
        }
    } catch (e) {
        apz.stopLoader();
        console.error("Exception in downloadCbReportCB:", e);
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
    }
}
apz.app.LoanDisbursementList.getProductDescription = function(productId) {
    const product = KendraApp.ProductResponse.find(item => item.productDtls && item.productDtls.productId === productId);
    return product ? product.productDtls.description : null;
}
var passbookType = '',
    viewPassbook = false;
apz.app.LoanDisbursementList.downloadPassbook = function(param) {
    passbookType = param;
    viewPassbook = true;
    var par, frequency;
    if (custData?.selectedApp?.addInfo && JSON.parse(custData.selectedApp.addInfo).APR !== '') {
        par = JSON.parse(custData.selectedApp.addInfo).APR + '%'
    } else {
        par = (KendraLoans?.custFetchLoanAppRes?.cbResponse?.resPayload) ? JSON.parse(KendraLoans.custFetchLoanAppRes.cbResponse.resPayload).eir +
            '%' : '-'
    }
    frequency = custData?.customerDtls?.loanDtls?.repayFrequency?.idDesc ?? '-';
    var date, dateContent = KendraLoans?.custFetchLoanAppRes?.precloserLoanResponse ? JSON.parse(KendraLoans.custFetchLoanAppRes
        .precloserLoanResponse.responsePayload) : ''
    date = KendraApp.disbursedApp?.linkedActivities[0]?.body.effectiveDate ?? ApzCOB.dateYYYYMMDDformat();
    // if (dateContent.hasOwnProperty('linkedActivities')) {
    //     date = dateContent?.linkedActivities[0]?.body.effectiveDate ?? ''
    // } else {
    //     date = KendraLoans?.custFetchLoanAppRes?.precloserLoanResponse?.apiReqTs?(KendraLoans?.custFetchLoanAppRes?.precloserLoanResponse?.apiReqTs).substring(0, 10):'';
    // }
    var interestRate = KendraLoans?.custFetchLoanAppRes?.cbResponse?.resPayload ? parseInt(JSON.parse(KendraLoans.custFetchLoanAppRes.cbResponse
        .resPayload).roi) : '';
    apz.startLoader();
    var request = {
        "apiRequest": {
            "interfaceName": "GeneratePassbook",
            "appId": "APZCBO",
            "userId": LoggedInUserDetails.userID,
            "requestObj": {
                "loanId": passbookLoanId ?? '',
                "applicationId": passbookApplicationId ?? '',
                "memberId": custData?.customerId ?? '-',
                "memberName": custData?.customerName ?? '-',
                "kendraName": custData?.kendraName ?? '-',
                "productName": apz.app.LoanDisbursementList.getProductDescription(custData?.customerDtls?.loanDtls?.product),
                "loanPurpose": custData?.customerDtls?.loanDtls?.purpose?.purposeDesc ?? '-',
                "moratorium": '1 -Installment for Principal',
                "disbursementDate": date != '' ? ApzCOB.dateformatter(date, "d M Y") : '-',
                "spouseName": custData?.customerDtls?.kycDtls?.maritalStatus === 'MARRIED' ? custData?.customerDtls?.loanDtls?.nomineeDtls
                    ?.nomineeName : '-',
                "loanAmt": custData?.amount ? 'Rs ' + custData?.amount : '-',
                "roi": (interestRate != '' ? interestRate + '%' : '-') + ' / ' + (par ?? '-'),
                "phone": custData?.customerDtls?.mobileNum ?? '-',
                "processingFee": (custData?.customerDtls?.loanDtls?.chargeAndBreakupDtls?.aprxLoanCharges) ? 'Rs ' + custData?.customerDtls
                    ?.loanDtls?.chargeAndBreakupDtls?.aprxLoanCharges : '-',
                "insurancePremiumMember": custData?.customerDtls?.loanDtls?.insurDtls?.applicant_insurance_amt ? 'Rs ' + custData
                    ?.customerDtls?.loanDtls?.insurDtls?.applicant_insurance_amt : '-',
                "insurancePremiumSpouse": custData?.customerDtls?.loanDtls?.insurDtls?.spouse_insurance_amt ? 'Rs ' + custData?.customerDtls
                    ?.loanDtls?.insurDtls?.spouse_insurance_amt : '-',
                "termOfLoan": (custData?.customerDtls?.loanDtls.term ?? '-') + '(' + frequency + ')',
                "type": apz.deviceType === 'WEB' ? 'download' : 'view'
            }
        }
    }
    ApzCOB.serverBuildParam(gAppId, 'GeneratePassbook', 'N', 'N', request, 'Y', apz.app.LoanDisbursementList.downloadPassbookCB);
}
var generatePassbookRes, base64String;
apz.app.LoanDisbursementList.downloadPassbookCB = function(params) {
    apz.stopLoader();
    console.log(params);
    try {
        apz.stopLoader();
        if (ApzCOB.handleServiceCallBacks(params)) {
            if (!apz.isNull(params.res.APZCBO__GeneratePassbook_Res.apiResponse.ResponseHeader.ResponseCode)) {
                generatePassbookRes = params.res.APZCBO__GeneratePassbook_Res.apiResponse.ResponseBody.responseObj
                base64String = generatePassbookRes
                if (base64String.length <= 1000) {
                    ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
                    return;
                }
                if (base64String !== '') {
                    if (passbookType === 'ViewPassbook') {
                        $('#' + LoanDisbursementScrId + "gr_row_187").addClass('sno')
                        $('#' + LoanDisbursementScrId + "docMianRow").removeClass('sno');
                        var byteCharacters = atob(base64String);
                        var byteNumbers = new Array(byteCharacters.length);
                        for (var i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        var byteArray = new Uint8Array(byteNumbers);
                        var blob = new Blob([byteArray], {
                            type: 'application/pdf'
                        });
                        var pdfUrl = URL.createObjectURL(blob);
                        var pdfContainer = document.getElementById(LoanDisbursementScrId + "reportPassBook");
                        if (!pdfContainer) {
                            console.error("Error: HTML container element not found!");
                            return;
                        }
                        if (apz.deviceType === 'WEB') {
                            fetch(pdfUrl).then(response => response.text()).then(html => {
                                pdfContainer.innerHTML = `<embed 
                                                    src="${pdfUrl}" 
                                                    type="application/pdf" 
                                                    style="width: 100%; height: 600px; overflow: auto;border: none;" />`;
                            }).catch(error => {
                                ApzCOB.fnDisplayMsg("Error loading document.", "E");
                            });
                        } else {
                                pdfContainer.style.cssText = `
                                max-width: 100%;          /* Prevent content from exceeding container */
                                max-height: 600px;        /* Limit height */
                                overflow: auto;           /* Enable scrolling */
                                border: 1px solid #ccc;   /* Optional border for clarity */
                                padding: 10px;            /* Add some space */
                                background-color: white;  /* Ensure background */
                            `;
                            fetch(pdfUrl).then(response => response.text()).then(html => {
                                pdfContainer.innerHTML = html;
                            }).catch(error => {
                                ApzCOB.fnDisplayMsg("Error loading document.", "E");
                            });
                        }
                    } else if (passbookType === 'DownloadPassbook') {
                        var byteCharacters = atob(base64String);
                        var byteNumbers = new Array(byteCharacters.length);
                        for (var i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        var byteArray = new Uint8Array(byteNumbers);
                        var blob = new Blob([byteArray], {
                            type: 'application/pdf'
                        });
                        var link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        var id = passbookApplicationId ?? passbookLoanId;
                        link.download = "Passbook_" + id + ".pdf";
                        link.click();
                        URL.revokeObjectURL(link.href);
                    } else {
                        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
                    }
                } else {
                    ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_INVALID_REPORT_MSG"), "E");
                }
            } else {
                viewPassbook = false;
                apz.stopLoader();
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
            }
        } else {
            viewPassbook = false;
            apz.stopLoader();
            ApzCOB.fnDisplayMsg(params.res.APZCBO__GeneratePassbook_Res.apiResponse.ResponseHeader.ResponseMessage, "E");
        }
    } catch (e) {
        viewPassbook = false;
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
    }
}
apz.app.LoanDisbursementList.CustomerDtls = function(pthis) {
    event.preventDefault();
    event.stopPropagation();
    let rowNo = $(pthis).attr('rowno');
    viewCustomer = true;
    var selData =  apz.data.scrdata.LoanDi__CustomersList_Res.Customer[rowNo]
    //KendraApp.selectedCustomer = selData;
    let selectedData = {};
    selectedData.scr = 'LoanDisbursementList'
    selectedData.childScrId = apz.currAppId;
    viewCustomer = true;
    window.isViewCustFromDisbursemet = true
    selectedDataFromLoanDisbursementList = selectedData;
    ApzCOB.FetchCustomerDetails(selData.customerId);
    //ApzCOB.fetchCustomerIdDetails(selData.customerId);
}

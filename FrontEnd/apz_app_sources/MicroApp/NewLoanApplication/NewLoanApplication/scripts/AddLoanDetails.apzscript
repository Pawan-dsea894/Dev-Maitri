var selLoanProdDesc = "",
    selectedAppObj = {},
    selLoanProdObj = {},
    disburseModeArr = [],
    tempPurposeResponse = [],
    tempSubPurposeResponse = [],
    repaymentFreqOpt = [],
    disbModeOpt = [],
    defAmtArr = [],
    maxAmtArr = [],
    minAmtArr = [],
    termArr = [],
    vintage, maxAmt, minAmt, defAmt, term,
    defaultAmount,
    memCheckBox = false,
    spouseCheckBox = false,
    reIncome = false,
    spouseFlag = false,
    insurAmt = 0,
    totPreCloAmt = 0,
    lnAmount = 0,
    lnOutstandingAmt=0,
    insurArr = [],
    upgrFlag = false,
    totalAmt = 0,
    insFlag = false;
CbDetailsArr = [];
var isAllowedEL = false;
var isDraftWithEmi = false;
var draftCustData = '';
var incomeAppId;
var isDraftApplication = false,isDraftAllLoan = false,isDraftNewLoan=false;
var isFirstProductCall = true,
    isFirstPurposeCall = true,
    isFirstFrequencyCall = true;
    isFirstDisbursementModeCall = true;
var isApplicationFromCalculator = false,isApplicationFromMemberCalculator = false;    
var eligibleAmt = 0,
    purp = "",
    subPurp = "";
addLoanDetailsObj = {
    'scrDataStep1': {},
    'selEligibleLoanDtls': {}
};
screenId = "NEWLOA__AddLoanDetails__";
var searchData = [];
var mandFields = [screenId + "memCheckBox", screenId + "loanAmount", screenId + "purpAndSubpurp", screenId + "repayFreq",
    screenId + "disbMode", screenId + "insurProviderDpd", screenId + "nomineeName", screenId + "nomineeReationDpd"
];
var incomeDtlsField = [{
    key: "Business",
    value: ""
}, {
    key: "Agriculture",
    value: ""
}, {
    key: "Salary",
    value: ""
}, {
    key: "Wage",
    value: ""
}, {
    key: "Pension",
    value: ""
}, {
    key: "Rental Income",
    value: ""
}, {
    key: "Wlfare Benefits",
    value: ""
}, {
    key: "Remittances",
    value: ""
}, {
    key: "Any Other Income",
    value: ""
}];
var custAgeLimit,spouseAgeLimit,custEligibleWeeks,spouseEligibleWeeks;
window.isClose = false;
window.backReject = false;
window.KendraApp.Transpayload = {};
window.isCBsuccess=false;
window.tempDisbCashMode = "";
window.checkCashELafterAddQuestionary = false;
apz.app.onLoad_AddLoanDetails = function(params) {
     window.KendraApp.remarks='NA';
     if (window.isDraft && window.isLoanCreateFromCalculator) {
       if (KendraApp?.LoanCalculatorObj && Object.keys(KendraApp.LoanCalculatorObj).length > 0) {
         isDraftWithEmi = true;
         window.isDraft = false;
       }
     }
    if (window.isDraft && !isDraftWithEmi) {
        window.isDraft = false;
        isDraftApplication = true;
        isDraftAllLoan = window.isDraftFromAllLoan
        isDraftNewLoan = window.isDraftFromNewLoan
        window.isDraftFromAllLoan = false;
        window.isDraftFromNewLoan = false;
        draftCustData = params?.data ? params?.data : '';
        KendraApp.currentLoanAppRequest.applicationdtls = params.data;
        if(draftCustData === ''){
            draftCustData = params;
            KendraApp.currentLoanAppRequest.applicationdtls = params;
        }
        if (typeof draftCustData?.addInfo === "string") {
            incomeAppId = JSON.parse(draftCustData?.addInfo).incomeAppId
        }else{
            incomeAppId = draftCustData?.addInfo?.incomeAppId
        }
        if (!apz.isNull(incomeAppId && IncomeApp.flow === 'fromDraft')) {
            $('#' + screenId + 'stage1').addClass('sno');
            $('#' + screenId + 'stage2').removeClass('sno');
            $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
            KendraApp.selectedCustomer.income = draftCustData.customerDtls.income;
        }
    }
    custAgeLimit = ApzCOB.GetCommonCodes("AGELIMIT").agelimit.custAgeLimit
    spouseAgeLimit = ApzCOB.GetCommonCodes("AGELIMIT").agelimit.spouseAgeLimit
    selectedAppObj = KendraApp.selectedCustomer;
    if (!ApzCOB.chkprevscrPageBC(apz.childScr)) {
        ApzCOB.addscrPageBC(apz.childScr);
    }
    vintage = 'Vintage ' + KendraApp.selectedCustomer.custVintage + ' Years';
    //document.getElementById("NEWLOA__AddLoanDetails__plus").style.pointerEvents = 'auto';
    //document.getElementById("NEWLOA__AddLoanDetails__plus").style.opacity = '0.5';
    defaultAmount = apz.getElmValue(screenId + "loanAmount");
    gApzCOB.insurDetails = ApzCOB.GetCommonCodes("GLFEES").Fees;
    if(!apz.isNull(ApzCOB.GetCommonCodes("LOVLIST"))){
       window.LOV_LIST = ApzCOB.GetCommonCodes("LOVLIST"); 
    }
    if (selectedAppObj.maritalStatus === 'MARRIED') {
        selectedAppObj.earnings.forEach(function(el, i) {
            if (selectedAppObj.earnings[i].memRelation === 'SPOUSE') {
                apz.setElmValue(screenId + "nomineeName", selectedAppObj.earnings[i].name);
            }
        })
    }
}
apz.app.onShown_AddLoanDetails = function() {
    // let age = ApzCOB.calculateAge(ApzCOB.confDateFormatter(Number(KendraApp.selectedCustomer.depDob)));
    apz.app.AddLoanDetails.paintDetails();
    document.getElementById(screenId + 'sucRefId').classList.add('sno');
    document.getElementById(screenId + 'conappId').classList.add('sno');
    if (isDraftApplication) {
        $('#NEWLOA__AddLoanDetails__el_txt_333_ul').removeClass('sno');
        $("#NEWLOA__AddLoanDetails__el_txt_333_txtcnt").text(draftCustData?.applicationId??'')
        $('#NEWLOA__AddLoanDetails__conappId').removeClass('sno');
        $("#NEWLOA__AddLoanDetails__conappId_txtcnt").text(draftCustData?.applicationId??'')
        apz.app.AddLoanDetails.paintDraftAppDtls();
    }
    if(window.isLoanCreateFromCalculator){
        window.isLoanCreateFromCalculator = false;
        isApplicationFromCalculator = true;
        if(window.isCalcFromCustToLoanInput){
            window.isCalcFromCustToLoanInput = false;
            isApplicationFromMemberCalculator = true
        }
        apz.app.AddLoanDetails.paintEmiClaculatorDtls();
    }
}
apz.app.AddLoanDetails.paintEmiClaculatorDtls = function() {
    if (Object.keys(KendraApp.LoanCalculatorObj).length != 0) {
            apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode.forEach(function(j, i) {
            if (apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode[i].description === KendraApp?.LoanCalculatorObj?.product) {
                $('#' + screenId + 'loanProductCheckBox_' + i).prop('checked', true);
                $('#' + screenId + 'loanProductList_row_' + i).addClass('active');
                apz.app.AddLoanDetails.paintLoanProduct();
            } else {
                $('#' + screenId + 'loanProductCheckBox_' + i).prop('checked', false);
                $('#' + screenId + 'loanProductList_row_' + i).removeClass('active');
            }
        })
        if(isAllowedEL){
            isAllowedEL = false;
            return
        }
        apz.app.AddLoanDetails.paintRepayFrequency()
        let prodExists = apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode.some(opt => opt.description === KendraApp?.LoanCalculatorObj?.product);
        let freqExists = repaymentFreqOpt.some(opt => opt.idDesc === KendraApp?.LoanCalculatorObj?.breakupDtls?.fequency);
        if(freqExists){
            repaymentFreqOpt.forEach(function(j, i) {
                if (repaymentFreqOpt[i].idDesc === KendraApp?.LoanCalculatorObj?.breakupDtls?.fequency) {
                    $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', true);
                    $('#' + screenId + 'repayFreqList_row_' + i).addClass('active');
                    repayFreq = $('#NEWLOA__ModalFieldsIntf__o__repaymentFreqNode__idDesc_' + i).text();
                    addLoanDetailsObj.scrDataStep1.repayFrequency = repaymentFreqOpt[i];
                    apz.setElmValue(screenId + "repayFreq", repayFreq);
                } else {
                    $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', false);
                    $('#' + screenId + 'repayFreqList_row_' + i).removeClass('active');
                }
            });
        }
        if(!prodExists && !freqExists){
            isFirstProductCall = false;
            ApzCOB.fnDisplayMsg("The selected customer is NQA, which has different products. Please select from the existing products. Also, the selected frequency does not match. Please select again.", 'I');
        }else if(!prodExists){
            isFirstProductCall = false;
            ApzCOB.fnDisplayMsg("The selected customer is NQA, which has different products. Please select from the existing products.", 'I');
        }else if(!freqExists){
            ApzCOB.fnDisplayMsg('Selected frequency doesn’t match. Please select', "I")
        }
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", KendraApp?.LoanCalculatorObj?.loanAmount);
    }
}
apz.app.AddLoanDetails.paintDraftAppDtls = function() {
    var productId = draftCustData?.customerDtls?.loanDtls?.productId
    const product = KendraApp.ProductResponse.find(item => item.productDtls && item.productDtls.productId === productId);
    var productDesc =  product ? product.productDtls.description : productId;
    apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode.forEach(function(j, i) {
        if (apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode[i].description === productDesc) {
            $('#' + screenId + 'loanProductCheckBox_' + i).prop('checked', true);
            $('#' + screenId + 'loanProductList_row_' + i).addClass('active');
            apz.app.AddLoanDetails.paintLoanProduct();
        } else {
            $('#' + screenId + 'loanProductCheckBox_' + i).prop('checked', false);
            $('#' + screenId + 'loanProductList_row_' + i).removeClass('active');
        }
    })
    apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", draftCustData.amount);
        var purpose, subPurpose, repayFreq, insuranceProvider,nomineeReationDpd;
        //apz.setElmValue(screenId + "loanAmount", KendraApp.currentLoanAppRequest.applicationdtls.amount);
        //KendraApp.selectedAmt = parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount);
        apz.app.AddLoanDetails.updateLoanAmount()
        apz.app.AddLoanDetails.loadPuposeDetails()
        tempPurposeResponse.forEach(function(j, i) {
            if (draftCustData?.customerDtls?.loanDtls?.purpose?.purposeDesc === tempPurposeResponse[i]
                .purposeDesc) {
                $('#' + screenId + 'purposeList_row_' + i).addClass('active');
                purpose = $('#' + screenId + "purposeList_row_" + i).text();
            } else {
                $('#' + screenId + 'purposeList_row_' + i).removeClass('active');
            }
        })
        $('#NEWLOA__AddLoanDetails__purposeList_row_0').click()
        tempSubPurposeResponse.forEach(function(j, i) {
            if (tempSubPurposeResponse[i] === draftCustData?.customerDtls?.loanDtls?.purpose
                .productSubPurpose) {
                $('#' + screenId + 'subPurposeCheckbox_' + i).prop('checked', true);
                subPurpose = $('#NEWLOA__SubPurpose__o__SubPurposeNode__subPurposeIdDesc_' + i).text();
            } else {
                $('#' + screenId + 'subPurposeCheckbox_' + i).prop('checked', false);
            }
        });
        // apz.app.AddLoanDetails.loadRepaymentFrequency()
        apz.app.AddLoanDetails.paintRepayFrequency()
        repaymentFreqOpt.forEach(function(j, i) {
            if (repaymentFreqOpt[i].idDesc === draftCustData.customerDtls.loanDtls.repayFrequency.idDesc) {
                $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', true);
                $('#' + screenId + 'repayFreqList_row_' + i).addClass('active');
                repayFreq = $('#NEWLOA__ModalFieldsIntf__o__repaymentFreqNode__idDesc_' + i).text();
                addLoanDetailsObj.scrDataStep1.repayFrequency = repaymentFreqOpt[i];
            } else {
                $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', false);
                $('#' + screenId + 'repayFreqList_row_' + i).removeClass('active');
            }
        });
        apz.app.AddLoanDetails.loadInsurance();
        apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.insurance.forEach(function(j, i) {
            if (j.desc === draftCustData?.customerDtls?.loanDtls?.insurDtls?.insuranceProvider) {
                $('#' + screenId + 'insCheckBox_' + i).prop('checked', true);
                $('#' + screenId + 'insList_row_' + i).addClass('active');
                insuranceProvider = $('#NEWLOA__ModalFieldsIntf__o__insurance__desc_'+i+'_txtcnt').text();
            } else {
                $('#' + screenId + 'insCheckBox_' + i).prop('checked', false);
                $('#' + screenId + 'insList_row_' + i).removeClass('active');
            }
        });
        apz.app.AddLoanDetails.loadNominee();
        LOV_LIST.nomineeReation.forEach(function(j, i) {
            if (j.desc === draftCustData?.customerDtls?.loanDtls?.nomineeDtls?.relationWithMember) {
                $('#' + screenId + 'nomineeCheckBox_' + i).prop('checked', true);
                $('#' + screenId + 'nomList_row_' + i).addClass('active');
                nomineeReationDpd = $('#NEWLOA__ModalFieldsIntf__o__nomineeList__desc_'+i+'_txtcnt').text();
            } else {
                $('#' + screenId + 'nomineeCheckBox_' + i).prop('checked', false);
                $('#' + screenId + 'nomList_row_' + i).removeClass('active');
            }
        });
        apz.app.AddLoanDetails.paintPurposeSubpurpose()
        //apz.setElmValue(screenId + "purpAndSubpurp", purpose + " : " + subPurpose);
        apz.setElmValue(screenId + "repayFreq", repayFreq);
        addLoanDetailsObj.scrDataStep1.nomineeDtls = {
                  relationWithMemberCode: draftCustData?.customerDtls?.loanDtls?.nomineeDtls?.relationWithMemberCode??'',
                  relationWithMember: draftCustData?.customerDtls?.loanDtls?.nomineeDtls?.relationWithMember??'',
                };
        apz.setElmValue(screenId + "insurProviderDpd", insuranceProvider);
        apz.setElmValue(screenId + "nomineeReationDpd", nomineeReationDpd);
        apz.setElmValue(screenId + "nomineeName", draftCustData?.customerDtls?.loanDtls?.nomineeDtls?.nomineeName); 
        if(draftCustData.productType === 'EL'){
            apz.app.AddLoanDetails.loadLoanDisbMode();
            disbModeOpt.forEach(function(k,i){
                if(k.idDesc === draftCustData?.customerDtls?.loanDtls?.disburseMode?.idDesc){
                    $('#' + screenId + 'disbModeCheckbox_' + i).prop('checked', true);
                    $('#' + screenId + 'disbModeList_row_' + i).addClass('active');
                }else{
                    $('#' + screenId + 'disbModeCheckbox_' + i).prop('checked', false);
                    $('#' + screenId + 'disbModeList_row_' + i).removeClass('active');
                }
            })
            apz.app.AddLoanDetails.paintDisbursementMode();
            if (typeof repayFreq === 'undefined') {
                apz.setElmValue(screenId + "repayFreq", KendraApp.selectedKendra.meetingFrequency);
            }
        }       
}
apz.app.AddLoanDetails.paintDetails = function() {
    if (isDraftApplication && !apz.isNull(incomeAppId)) {
        apz.startLoader();
    }
    KendraApp.activeLoanDtls = [];
    if (selectedAppObj.loanDtls.length > 0) {
        selectedAppObj.loanDtls.forEach(loan => {
            KendraApp.ProductList.forEach(prod => {
                if (loan.product == prod.productDtls.productId) {
                    loan.productType = prod.productDtls.productType;
                    loan.shortDesc = prod.productDtls.shortDesc;
                    loan.productId = prod.productDtls.productId;
                    loan.description = prod.productDtls.description;
                    loan.maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(loan.lnMatDate), "dd/mm/yy");
                    loan.isCompulsory = false; // Assuming it's optional
                }
            });
            var loanAmount=parseFloat(parseFloat(loan.outstandingPrincipal)+ parseFloat(loan
                    .overdueInterest) + parseFloat(loan.overduePrincipal)).toFixed(2);
            lnOutstandingAmt=parseFloat(parseFloat(lnOutstandingAmt)+ parseFloat(loanAmount)).toFixed(2);
            KendraApp.activeLoanDtls.push(loan);
        });
    }
    apz.app.AddLoanDetails.paintCustDetails();
    apz.app.AddLoanDetails.loadRelationshipDpd();
    if (KendraApp.selectedCustomer.maxAmountLimit == '0') {
        $('#' + screenId + 'sc_col_1085').addClass('sno');
        $('#' + screenId + 'sc_col_694').addClass('sno');
        $('#' + screenId + 'sc_col_1087').addClass('sno');
    }
    setTimeout(function() {
        apz.app.AddLoanDetails.loadNominee();
        if (isDraftApplication) {
            if (!apz.isNull(incomeAppId)) {
                // $('#' + screenId + 'stage1').addClass('sno');
                // $('#' + screenId + 'stage2').removeClass('sno');
                apz.app.AddLoanDetails.next()
                $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
            }
        }else{
            addLoanDetailsObj.scrDataStep1.nomineeDtls = {};
        if (KendraApp.selectedCustomer.maritalStatus == 'MARRIED') {
            if (window.loanProduct === 'Emergency Loan') {
                addLoanDetailsObj.scrDataStep1.nomineeDtls = {
                    "relationWithMemberCode": "",
                    "relationWithMember": "",
                    "nomineeName": ""
                };
            } else {
                apz.app.AddLoanDetails.onClickNom();
            }
        } else {
            if (window.loanProduct === 'Emergency Loan') {
                addLoanDetailsObj.scrDataStep1.nomineeDtls = {
                    "relationWithMemberCode": "",
                    "relationWithMember": "",
                    "nomineeName": ""
                };
            } else {
                apz.app.AddLoanDetails.onClickNom();
            }
        }
    }
    }, 500);
}
apz.app.AddLoanDetails.loadPuposeDetails = function() {
    var tempPurposeArray = [];
    tempPurposeResponse = KendraApp.ProductList.filter(val => (val.productDtls.description === selLoanProdDesc))[0].productDtls.prodPurpose
    if (tempPurposeResponse.length > 0) {
        tempPurposeResponse.forEach(function(j, k) {
            var tempPurposeObj = {
                "purposeId": j.purpose,
                "purposeIdDesc": j.purposeDesc
            }
            tempPurposeArray.push(tempPurposeObj);
        });
        apz.data.scrdata.NEWLOA__Purpose_Res = {};
        apz.data.scrdata.NEWLOA__Purpose_Res.purposeNode = tempPurposeArray;
        apz.data.loadData("Purpose", 'NEWLOA');
    }
}
apz.app.AddLoanDetails.onClickPupose = function(pthis) {
    apz.setElmValue(screenId + 'searchData', '');
    apz.app.AddLoanDetails.clearSubPurposeData();
    let rowNo = $(pthis).attr("rowno");
    let selPurposeDesc = $('#' + screenId + 'purposeList_row_' + rowNo).text();
    let tempSubPurposeArray = [];
    //tempPurposeResponse = selectedAppObj.eligibleLoan.filter(val => (val.shortDesc === selLoanProdDesc))[0].prodPurpose;
    tempPurposeResponse = KendraApp.ProductList.filter(val => (val.productDtls.description === selLoanProdDesc))[0].productDtls.prodPurpose
    tempSubPurposeResponse = tempPurposeResponse.filter(val => (val.purposeDesc === selPurposeDesc))[0].productSubPurpose;
    $.each(tempPurposeResponse, function(i) {
        if (parseInt(rowNo) === i) {
            $('#' + screenId + 'purposeList_row_' + i).addClass('active');
        } else {
            $('#' + screenId + 'purposeList_row_' + i).removeClass('active');
        }
    });
    if (typeof tempSubPurposeResponse === 'string') {
        tempSubPurposeResponse = [tempSubPurposeResponse];
    }
    if (tempSubPurposeResponse.length > 1) {
        ApzCOB.shuffleArr(tempSubPurposeResponse);
    }
    if (tempSubPurposeResponse.length > 0) {
        tempSubPurposeResponse.forEach(function(e) {
            let tempSubPurposeObj = {
                "subPurposeId": e,
                "subPurposeIdDesc": e
            }
            tempSubPurposeArray.push(tempSubPurposeObj);
        });
        apz.data.scrdata.NEWLOA__SubPurpose_Res = {};
        apz.data.scrdata.NEWLOA__SubPurpose_Res.SubPurposeNode = tempSubPurposeArray;
        searchData = apz.data.scrdata.NEWLOA__SubPurpose_Res.SubPurposeNode;
        if (tempSubPurposeArray.length > 4) {
            apz.setElmValue(screenId + 'searchData', '');
            $("#" + screenId + "searchRow").removeClass('sno');
        } else {
            $("#" + screenId + "searchRow").addClass('sno');
        }
        $("#" + screenId + 'subPurposeList').removeClass('sno');
        $("#" + screenId + 'noRecDiv').addClass('sno')
        apz.data.loadData("SubPurpose", 'NEWLOA');
        $.each(tempSubPurposeResponse, function(i) {
            $('#' + screenId + 'subPurposeCheckbox_' + i).prop('disabled', false);
        });
    }
}
apz.app.AddLoanDetails.onClickSubPupose = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    $.each(tempSubPurposeResponse, function(i) {
        if (parseInt(rowNo) === i) {
            $('#' + screenId + 'subPurposeCheckbox_' + i).prop('checked', true);
        } else {
            $('#' + screenId + 'subPurposeCheckbox_' + i).prop('checked', false);
        }
    });
}
apz.app.AddLoanDetails.onClickLoanProduct = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    $.each(apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode, function(m) {
        if (parseInt(rowNo) === m) {
            $('#' + screenId + 'loanProductCheckBox_' + m).prop('checked', true);
            $('#' + screenId + 'loanProductList_row_' + m).addClass('active');
        } else {
            $('#' + screenId + 'loanProductCheckBox_' + m).prop('checked', false);
            $('#' + screenId + 'loanProductList_row_' + m).removeClass('active');
        }
    });
}
apz.app.AddLoanDetails.onClickRepayFrequency = function(pthis) {
    let rowNo = 0;
    if (!apz.isNull(pthis)) {
        rowNo = $(pthis).attr("rowno");
    }
    $.each(repaymentFreqOpt, function(i) {
        if (parseInt(rowNo) === i) {
            $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', true);
            $('#' + screenId + 'repayFreqList_row_' + i).addClass('active');
        } else {
            $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', false);
            $('#' + screenId + 'repayFreqList_row_' + i).removeClass('active');
        }
    });
}
apz.app.AddLoanDetails.onClickDisbursementMode = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    $.each(disbModeOpt, function(i) {
        if (parseInt(rowNo) === i) {
            $('#' + screenId + 'disbModeCheckbox_' + i).prop('checked', true);
            $('#' + screenId + 'disbModeList_row_' + i).addClass('active');
        } else {
            $('#' + screenId + 'disbModeCheckbox_' + i).prop('checked', false);
            $('#' + screenId + 'disbModeList_row_' + i).removeClass('active');
        }
    })
}
apz.app.AddLoanDetails.loadRepaymentFrequency = function() {
    var tempRepaymentFreqArray = [],
        tempRepaymentFreqResponse = [];
    tempRepaymentFreqResponse = KendraApp.ProductList.filter(val => (val.productDtls.description === selLoanProdDesc));
    if (tempRepaymentFreqResponse.length > 0) {
        var repaymentFreq = tempRepaymentFreqResponse[0].productDtls.freq;
        repaymentFreqOpt = repaymentFreq.split(",");
        repaymentFreqOpt.forEach(function(f) {
            let tempPayFreqObj = {
                "id": apz.app.AddLoanDetails.fetchFrequncyVal(f),
                "idDesc": f
            }
            if (KendraApp.selectedKendra.meetingFrequency == 'BIWEEKLY' && tempPayFreqObj.idDesc != 'WEEKLY') {
                tempRepaymentFreqArray.push(tempPayFreqObj);
            } else if (KendraApp.selectedKendra.meetingFrequency == 'FOUR.WEEKLY' && (tempPayFreqObj.idDesc != 'WEEKLY' && tempPayFreqObj
                    .idDesc != 'BIWEEKLY')) {
                tempRepaymentFreqArray.push(tempPayFreqObj);
            } else if (KendraApp.selectedKendra.meetingFrequency == 'WEEKLY') {
                tempRepaymentFreqArray.push(tempPayFreqObj);
            }
        });
        apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res = {};
        apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.repaymentFreqNode = tempRepaymentFreqArray;
        apz.data.loadData("ModalFieldsIntf", 'NEWLOA');
        repaymentFreqOpt = tempRepaymentFreqArray;
        selData = apz.getElmValue('NEWLOA__AddLoanDetails__repayFreq');
        apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.repaymentFreqNode.forEach((d, idx) => {
            if (selData === d.idDesc) {
                $("#NEWLOA__ModalFieldsIntf__o__repaymentFreqNode__idDesc_" + idx).prop("checked", true);
            }
        })
    }
}
apz.app.AddLoanDetails.loadLoanDisbMode = function() {
    /*var tempDisbModeNodeArray = [];
    if (productDtls.length > 0) {
        var repaymentFreq = productDtls.freq;
        repaymentFreq = repaymentFreq.split("#");
        repaymentFreq.forEach(function(j, k) {
            let tempDisbModeObj = {
                "id": j,
                "idDesc": j
            }
            tempDisbModeNodeArray.push(tempDisbModeObj);
        });
        apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res = {};
        apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.disbModeNode = tempDisbModeNodeArray;
        apz.data.loadData("ModalFieldsIntf", 'NEWLOA');
    }*/
    if (window.loanProduct === "Emergency Loan") {
        disbModeOpt = JSON.parse('[{"id":1,"idDesc":"CASH"},{"id":2,"idDesc":"NEFT"}]');
    } else {
        disbModeOpt = JSON.parse('[{"id":1,"idDesc":"CASH"},{"id":2,"idDesc":"NEFT"},{"id":3,"idDesc":"IMPS"}]');
    }
    apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res = {};
    apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.disbModeNode = disbModeOpt;
    apz.data.loadData("ModalFieldsIntf", 'NEWLOA');
    $.each(disbModeOpt, function(i) {
        $('#' + screenId + 'disbModeCheckbox_' + i).prop('disabled', false);
    });
}
apz.app.AddLoanDetails.paintCustDetails = function() {
    apz.setElmValue(screenId + "custName", selectedAppObj.customerName);
    apz.setElmValue(screenId + "userprof", selectedAppObj.customerName.slice(0, 1));
    apz.setElmValue(screenId + "groupId", selectedAppObj.customerId);
    apz.setElmValue(screenId + "maxLoanLimit", "₹ " + selectedAppObj.maxAmountLimit);
    apz.setElmValue(screenId + "vintage1", vintage);
    apz.setElmValue(screenId + "groupID1", selectedAppObj.groupId);
    apz.setElmValue(screenId + "tenure", "NA");
    apz.setElmValue(screenId + "loanProcessFee", "NA");
    apz.setElmValue(screenId + "approxLoanAmt", "NA");
    apz.setElmValue(screenId + "loanAmt", "NA");
    apz.setElmValue(screenId + "approxLoanCharges", "NA");
    apz.setElmValue(screenId + "insurCharges", "NA");
    apz.setElmValue(screenId + "gstAmt", "NA");
    apz.setElmValue(screenId + "approxWeeklyInstall", "NA");
    if (selectedAppObj.maritalStatus === 'MARRIED') {
        var spouseName = selectedAppObj.depname.split(',')[selectedAppObj.memRelation.split(',').indexOf('SPOUSE')] === undefined ? "" :
            selectedAppObj.depname.split(',')[selectedAppObj.memRelation.split(',').indexOf('SPOUSE')];
        spouseFlag = spouseName === '' ? false : true;
        apz.setElmValue(screenId + "nomineeName", spouseName);
    }
    apz.app.AddLoanDetails.loadLoanProducts();
    /*if (apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode.length > 0) {
        apz.setElmValue(screenId + "loanProdInput", apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode[0].shortDesc);
        $('#' + screenId + 'loanProductCheckBox_' + 0).prop('checked', true);
        $('#' + screenId + 'loanProductList_row_' + 0).addClass('active');
        apz.app.AddLoanDetails.onChangeLoanProduct(apz.getElmValue(screenId + "loanProdInput"));
    }*/
}
apz.app.AddLoanDetails.paintActiveLoanDetails = function(stage) {
    let tempArray = [];
    KendraApp.activeLoanDtls = [];
    if (selectedAppObj.loanDtls.length > 0) {
        selectedAppObj.loanDtls.forEach(loan => {
            KendraApp.ProductList.forEach(prod => {
                if (loan.product == prod.productDtls.productId) {
                    loan.productType = prod.productDtls.productType;
                    loan.shortDesc = prod.productDtls.shortDesc;
                    loan.productId = prod.productDtls.productId;
                    loan.description = prod.productDtls.shortDesc;
                }
            });
            var wks = ApzCOB.findMaturityWeek(loan.lnMatDate);
            var maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(loan.lnMatDate), "dd/mm/yy");
            var remainingInstallment =  ApzCOB.calculateRemainingInstallments(loan.lnValueDate, loan.lnMatDate, loan.freq, todayStr = null);
            var loanAmt=loan.approvedAmt;
            if (apz.isNull(loan.approvedAmt)) {
                loanAmt=loan.amount;
            }
            let tempObj = {
                "loanType": loan.shortDesc,
                "maturityDate": maturityDate,
                "maturityWks": `${maturityDate} (${remainingInstallment})`,
                "loanId": loan.loanId,
                "isCompulsory":false,
                "description": loan.description,
                "loanAmount": "₹ " +loanAmt,
                /*"dueAmount": ((ApzCOB.getTotalDueAmount(loan.loanId) === 0) ? "₹ " + parseInt(loan.amount) + ' ( ₹ ' + parseInt(loan
                    .overdueInterest) + parseInt(loan.overduePrincipal) + ' )' : ApzCOB.getTotalDueAmount(loan.loanId))*/
                "dueAmount": "₹ " + Math.round(parseFloat(loan.outstandingPrincipal)) + ' ( ₹ ' + Math.round((parseFloat(loan
                    .overdueInterest)) + Math.round(parseFloat(loan.overduePrincipal))) + ' )'
            }
            tempArray.push(tempObj);
            KendraApp.activeLoanDtls.push(loan);
        });
        apz.data.scrdata.NEWLOA__ViewActiveLoanDetails_Res = {};
        if (stage === 'stage1') {
            apz.data.scrdata.NEWLOA__ViewActiveLoanDetails_Res.ViewActiveLoanDetailsNode = tempArray;
            if ($("#" + screenId + "activeLoanDtls").hasClass("sno")) {
                $('#' + screenId + 'activeLoanDtls').removeClass('sno');
                $('#NEWLOA__AddLoanDetails__el_txt_344_txtcnt').text('Maturity Date (Remaining Installments)');
            } else {
                $('#' + screenId + 'activeLoanDtls').addClass('sno');
            }
        } else if (stage === 'stage2') {
            apz.data.scrdata.NEWLOA__ViewActiveLoanDetails_Res.ActiveLoanConfirmDetails = tempArray;
            if ($("#" + screenId + "activeconLoanList").hasClass("sno")) {
                $('#' + screenId + 'activeconLoanList').removeClass('sno');
                $('#NEWLOA__AddLoanDetails__el_txt_390_txtcnt').text('Maturity Date (Remaining Installments)');
            } else {
                $('#' + screenId + 'activeconLoanList').addClass('sno');
            }
        } else {
            apz.data.scrdata.NEWLOA__ViewActiveLoanDetails_Res.ActiveLoanSummaryDetails = tempArray;
            if ($("#" + screenId + "activesumLoanList").hasClass("sno")) {
                $('#' + screenId + 'activesumLoanList').removeClass('sno');
                $('#NEWLOA__AddLoanDetails__el_txt_455_txtcnt').text('Maturity Date (Remaining Installments)');
            } else {
                $('#' + screenId + 'activesumLoanList').addClass('sno');
            }
        }
        apz.data.loadData("ViewActiveLoanDetails", 'NEWLOA');
    } else {
        ApzCOB.fnDisplayMsg("No Existing Loans Available", "I");
    }
}
apz.app.AddLoanDetails.loadLoanProductDpd = function() {
    let DropLoanProduct = []
    DropLoanProduct = selectedAppObj.eligibleLoan;
    let tempArr1 = [];
    $.each(DropLoanProduct, function(i, k) {
        var obj = {};
        obj.desc = k.shortDesc;
        obj.val = i;
        tempArr1.push(obj);
    });
    tempArr1.unshift({
        "val": '-1',
        "desc": ApzCOB.getDescfromLitCode("LIT_COMM_MSG_PLEASE_SELECT")
    });
    apz.populateDropdown(document.getElementById(screenId + "loanProductDpd"), tempArr1);
}
//apz.app.AddLoanDetails.onChangeLoanProduct = function(pthis) {
apz.app.AddLoanDetails.onChangeLoanProduct = function(prodDesc) {
     isAllowedEL = false;
    let age = ApzCOB.ageCalculator(KendraApp.selectedCustomer.depDob);
    /*selLoanProdDesc = prodDesc;
    let selLoanProdArray = selectedAppObj.eligibleLoan.filter(val => (val.shortDesc === selLoanProdDesc));
    if (selLoanProdArray.length > 0) {
        selLoanProdObj = selLoanProdArray[0];
        if (apz.isNull(selLoanProdObj.intRate)) {
            selLoanProdObj.intRate = 23;
        }
        addLoanDetailsObj.selEligibleLoanDtls = selLoanProdObj;
        let aprxLnAmt = selLoanProdObj.caglAmt - (parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.intRate, selLoanProdObj.caglAmt)) + parseInt(
            ApzCOB.calAmtInPercentage(selLoanProdObj.insurancePercentage, selLoanProdObj.caglAmt)));
        apz.setElmValue(screenId + "loanAmount", '₹' + ApzCOB.fn_FormatAmount(selLoanProdObj.caglAmt));
        apz.setElmValue(screenId + "tenure", parseInt(selLoanProdObj.term.slice(0, -1)) + " Weeks");
        apz.setElmValue(screenId + "intRate", selLoanProdObj.intRate + "%");
        apz.setElmValue(screenId + "loanProcessFee", "₹ " + ApzCOB.fn_FormatAmount(parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.intRate,
            selLoanProdObj.caglAmt))));
        if (selLoanProdObj.spouseInsurance === "YES") {
            $("#NEWLOA__AddLoanDetails__sc_col_676").removeClass("sno");
        } else {
            $("#NEWLOA__AddLoanDetails__sc_col_676").addClass("sno");
        }
        apz.app.AddLoanDetails.paintInsuranceDetails(selLoanProdArray);
        apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(ApzCOB.calAmtInPercentage(selLoanProdObj.insurancePercentage,
            selLoanProdObj.caglAmt)));
        apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(selLoanProdObj.caglAmt));
        apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + ApzCOB.fn_FormatAmount((parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj
            .intRate, selLoanProdObj.caglAmt)) + parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.insurancePercentage,
            selLoanProdObj.caglAmt)))));
        apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
        apz.app.AddLoanDetails.clearPurposeSubpurposeData();
    }*/
    selLoanProdDesc = prodDesc;
    if (selLoanProdDesc === "Emergency Loan") {
            var isAllowed=false;
            if (KendraApp.selectedCustomer.loanDtls.length < 0) {
                ApzCOB.fnDisplayMsg("Customer doesn't have active loan to avail new Emergency loan.", "E");
                 apz.setElmValue(screenId + "loanProdInput", '');
                 isAllowedEL = true;
                return;
            } else {
                KendraApp.selectedCustomer.loanDtls.forEach((item) => {
                    if (item.product != "GL.EMERG.LOAN" && item.product != "GL.EMERGENCY.LN") {
                        isAllowed=true;
                    }
                    /*if (parseFloat(item.overduePrincipal) > 0) {
                        ApzCOB.fnDisplayMsg("To avail Emergency Loan, Customer should not have existing loan overdue.", "E");
                        return;
                    }*/
                });
            }
            if(!isAllowed){
                ApzCOB.fnDisplayMsg("Customer doesn't have active loan to avail new Emergency loan.", "E");
                 apz.setElmValue(screenId + "loanProdInput", '');
                 isAllowedEL = true;
                return;
            }
            KendraApp.selectedCustomer.loanDtls.forEach((item) => {
                if (item.product == "GL.EMERG.LOAN" || item.product == "GL.EMERGENCY.LN") {
                    ApzCOB.fnDisplayMsg("Customer already having active emergency loan. Not eligible for new EL loan.", "E");
                     apz.setElmValue(screenId + "loanProdInput", '');
                     isAllowedEL = true;
                    return;
                }
            });
            var parCount = ApzCOB.findOverdueCustomers(KendraApp.selectedCustomer);
            if (parCount !== 0) {
               ApzCOB.fnDisplayMsg("PAR customer is not eligible to avail new EL loan.", "E");
                apz.setElmValue(screenId + "loanProdInput", '');
                isAllowedEL = true;
               return;
            } 
            if (KendraApp.selectedCustomer.custVintage <= 1) {
                isAllowed = false;
                KendraApp.selectedCustomer.loanDtls.forEach((item) => {
                    if (item.product === "GL.IGL.PRAGATI" || item.product === "GL.IGL.PRAGATI.PLUS" || item.product === "GL.IGL.PRGTI.RESTR.1Y" || item
                        .product === "GL.PRAGATI.SUPL.PLUS" || item.product === "GL.PRAGATI.SUPLMNTRY" || item.product === "GL.IGL.VISH.LN") {
                        const today = new Date(); // Current date
                        var loanDate=ApzCOB.plaintoDateformat(item.lnValueDate, '-')
                        const pastDate = new Date(loanDate); // Date to compare
                        const differenceInMilliseconds = today - pastDate;
                        const millisecondsPerWeek = 7 * 24 * 60 * 60 * 1000; // Milliseconds in a week
                        const weeksBetween = Math.floor(differenceInMilliseconds / millisecondsPerWeek);
                        if (weeksBetween >= 6) {
                            isAllowed = true;
                        }
                    }
                });
                if (!isAllowed) {
                    ApzCOB.fnDisplayMsg("Customer vintage is not meeting to avail new Emergency loan.", "E");
                    apz.setElmValue(screenId + "loanProdInput", '');
                    return;
                }
            }
    }
    let selLoanProdArray = KendraApp.ProductResponse.filter(val => (val.productDtls.description === selLoanProdDesc));
    if (selLoanProdArray.length > 0) {
        selLoanProdObj = selLoanProdArray[0];
        defAmtArr = selLoanProdObj.productDtls.amountDefault.split(',');
        maxAmtArr = selLoanProdObj.productDtls.amountMax.split(',');
        minAmtArr = selLoanProdObj.productDtls.amountMin.split(',');
        termArr = selLoanProdObj.productDtls.term.split(',');
        if (defAmtArr.length > 1) {
            defAmt = parseInt(defAmtArr[0], 10);
            maxAmt = parseInt(maxAmtArr[maxAmtArr.length - 1], 10);
            minAmt = parseInt(minAmtArr[0], 10);
            term = parseInt(termArr[0].slice(0, -1));
        } else {
            defAmt = parseInt(selLoanProdObj.productDtls.amountDefault, 10);
            maxAmt = parseInt(selLoanProdObj.productDtls.amountMax, 10);
            minAmt = parseInt(selLoanProdObj.productDtls.amountMin, 10);
            term = parseInt(selLoanProdObj.productDtls.term.slice(0, -1));
        }
        if (apz.isNull(selLoanProdObj.productDtls.intRate)) {
            selLoanProdObj.productDtls.intRate = 23;
        }
        
        window.feeCharge = +selLoanProdObj.productDtls.feeCharge;
        window.gstValue = +selLoanProdObj.productDtls.gst;
        window.memInsurance = selLoanProdObj.productDtls.memInsurance;
        apz.app.AddLoanDetails.updatecheckBox(defAmt)
        addLoanDetailsObj.selEligibleLoanDtls = selLoanProdObj.productDtls;
        let aprxLnAmt = defAmt - (+ApzCOB.calGSTAmount(defAmt,window.gstValue,window.feeCharge) + +ApzCOB.calProcessingFees(defAmt,window.feeCharge) + insurAmt);
        if(isApplicationFromCalculator && KendraApp.selectedCustomer.custStatus!='NQA'){
            defAmt = KendraApp?.LoanCalculatorObj?.loanAmount ?? defAmt;
        }
        KendraApp.selectedAmt = parseInt(defAmt);
        apz.setElmValue(screenId + "loanAmount", ApzCOB.fn_FormatAmount(defAmt));
        if (selLoanProdDesc === "Emergency Loan") {
            $('#NEWLOA__AddLoanDetails__disbMode').val('');
            disburseModeArr = selLoanProdObj.productDtls.disbursementType.split(',')
            $('#NEWLOA__AddLoanDetails__disbMode_button').prop('disabled', false);
            $('#NEWLOA__AddLoanDetails__disbMode').prop('disabled', false);
            var inputElement = document.getElementById('NEWLOA__AddLoanDetails__disbMode');
            inputElement.setAttribute('placeholder', 'Please Select');
            $('#NEWLOA__AddLoanDetails__repayFreq').prop('disabled', true);
            $('#NEWLOA__AddLoanDetails__repayFreq_button').prop('disabled', true);
            apz.setElmValue(screenId + "repayFreq", KendraApp.selectedKendra.meetingFrequency);
            tempPurposeResponse = KendraApp.ProductList.filter(val => (val.productDtls.description === selLoanProdDesc))[0].productDtls.prodPurpose;
            if (tempPurposeResponse.length == 1) {
                apz.app.AddLoanDetails.loadPuposeDetails();
                setTimeout(function() {
                    apz.app.AddLoanDetails.loadPurpose();
                }, 500);
            }
            //apz.app.AddLoanDetails.paintRepayFrequency();
        } else {
            disburseModeArr = selLoanProdObj.productDtls.disbursementType.split(',')
            if (disburseModeArr.length == 1) {
                apz.setElmValue(screenId + "disbMode", disburseModeArr[0]);
            } else {
                apz.setElmValue(screenId + "disbMode", disburseModeArr[0]);
            }
            $('#NEWLOA__AddLoanDetails__disbMode_button').prop('disabled', true);
            $('#NEWLOA__AddLoanDetails__disbMode').prop('disabled', true);
            $('#NEWLOA__AddLoanDetails__purpAndSubpurp_button').prop('disabled', false);
            $('#NEWLOA__AddLoanDetails__purpAndSubpurp').prop('disabled', false);
             $('#NEWLOA__AddLoanDetails__repayFreq').prop('disabled', false);
            $('#NEWLOA__AddLoanDetails__repayFreq_button').prop('disabled', false);
        }
        apz.setElmValue(screenId + "tenure", term + " Weeks");
        apz.setElmValue(screenId + "intRate", selLoanProdObj.productDtls.intRate + "%");
        apz.setElmValue(screenId + "loanProcessFee", "₹ " + ApzCOB.calProcessingFees(defAmt,window.feeCharge));
        if (selLoanProdObj.productDtls.spouseInsurance === "YES" && selectedAppObj.maritalStatus === 'MARRIED' && (age < 65 && age > 18)) {
            $("#NEWLOA__AddLoanDetails__sc_col_676").removeClass("sno");
        } else {
            if (!apz.isNull(selLoanProdObj.productDtls.insLnamount)) {
                if (parseInt(selLoanProdObj.productDtls.insLnamount) <= parseInt(defAmt) && selectedAppObj.maritalStatus === 'MARRIED' && (age < 65 && age >
                        18)) {
                    $("#NEWLOA__AddLoanDetails__sc_col_676").removeClass("sno");
                } else {
                    $("#NEWLOA__AddLoanDetails__sc_col_676").addClass("sno");
                }
            } else {
                $("#NEWLOA__AddLoanDetails__sc_col_676").addClass("sno");
            }
            //$("#NEWLOA__AddLoanDetails__sc_col_676").addClass("sno");
        }
        
           if (window.memInsurance !== "YES") {
               $("#NEWLOA__AddLoanDetails__ct_frm_82").addClass("sno");
               $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', false);
               $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', true);
           } else {
               $("#NEWLOA__AddLoanDetails__ct_frm_82").removeClass("sno");
               apz.app.AddLoanDetails.paintInsuranceDetails(selLoanProdArray);
           }
        
        /*apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls
            .insurancePercentage, defAmt)));*/
        apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(defAmt));
        apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(defAmt,window.gstValue,window.feeCharge) + +ApzCOB
            .calProcessingFees(defAmt,window.feeCharge) + insurAmt).toString()));
        apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
        apz.setElmValue(screenId + "gstAmt", "₹ " + ApzCOB.calGSTAmount(defAmt,window.gstValue,window.feeCharge));
        apz.setElmValue(screenId + "approxWeeklyInstall", "₹ " + ApzCOB.fn_FormatAmount(ApzCOB.calApproxWeekInstallment(selLoanProdObj.productDtls
            .intRate, defAmt, (term / apz.app.AddLoanDetails.fetchFrequncyVal(apz.getElmValue(screenId + "repayFreq"))))));
        if (selLoanProdDesc !== "Emergency Loan") {
            apz.app.AddLoanDetails.clearPurposeSubpurposeData();
        }
        defaultAmount = defAmt; //apz.getElmValue(screenId + "loanAmount");
        let lnDefaultAmt = document.getElementById("NEWLOA__AddLoanDetails__loanAmount");
        lnAmount = parseInt(lnDefaultAmt.value.replace(/[₹,]/g, ''));
    }
    apz.app.AddLoanDetails.resetLoan();
     $('#' + screenId + 'spouseCheckBox').prop('checked', false)
    if(isDraftApplication){
        if(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls.Spouse === 'Y'){
         $('#' + screenId + 'spouseCheckBox').prop('checked', true)   
        }
    }
    apz.app.AddLoanDetails.memberInsurCheck();
    if (selLoanProdDesc === "Emergency Loan") {
        apz.app.AddLoanDetails.paintRepayFrequency();
    }
};
apz.app.AddLoanDetails.loadPurpose = function() {
    apz.setElmValue(screenId + 'searchData', '');
    apz.app.AddLoanDetails.clearSubPurposeData();
    rowNo = 0;
    let selPurposeDesc = $('#' + screenId + 'purposeList_row_' + 0).text();
    let tempSubPurposeArray = [];
    //tempPurposeResponse = selectedAppObj.eligibleLoan.filter(val => (val.shortDesc === selLoanProdDesc))[0].prodPurpose;
    tempPurposeResponse = KendraApp.ProductList.filter(val => (val.productDtls.description === selLoanProdDesc))[0].productDtls.prodPurpose
    tempSubPurposeResponse = tempPurposeResponse.filter(val => (val.purposeDesc === selPurposeDesc))[0].productSubPurpose;
    if (typeof tempSubPurposeResponse === 'string') {
        tempSubPurposeResponse = [tempSubPurposeResponse];
    }
    if (tempSubPurposeResponse.length == 1) {
        $('#' + screenId + 'purposeList_row_' + i).addClass('active');
        tempSubPurposeResponse.forEach(function(e) {
            let tempSubPurposeObj = {
                "subPurposeId": e,
                "subPurposeIdDesc": e
            }
            tempSubPurposeArray.push(tempSubPurposeObj);
        });
        apz.data.scrdata.NEWLOA__SubPurpose_Res = {};
        apz.data.scrdata.NEWLOA__SubPurpose_Res.SubPurposeNode = tempSubPurposeArray;
        $("#" + screenId + "searchRow").addClass('sno');
        $("#" + screenId + 'subPurposeList').removeClass('sno');
        $("#" + screenId + 'noRecDiv').addClass('sno')
        apz.data.loadData("SubPurpose", 'NEWLOA');
        $.each(tempSubPurposeResponse, function(i) {
            $('#' + screenId + 'subPurposeCheckbox_' + i).prop('disabled', false);
        });
        addLoanDetailsObj.scrDataStep1.purpose = JSON.parse(JSON.stringify(tempPurposeResponse[0]));
        var purpose = $('#' + screenId + "purposeList_row_" + 0).text();
        var subPurpose = $('#NEWLOA__SubPurpose__o__SubPurposeNode__subPurposeIdDesc_' + 0).text();
        $('#' + screenId + 'subPurposeCheckbox_' + 0).prop('checked', true)
        addLoanDetailsObj.scrDataStep1.productSubPurpose = JSON.parse(JSON.stringify(tempSubPurposeResponse[0]));
        apz.setElmValue(screenId + "purpAndSubpurp", purpose + " : " + subPurpose);
    }
}
apz.app.AddLoanDetails.paintInsuranceDetails = function(selLoanProdArr) {
    let insurProviderArr = selLoanProdArr[0].productDtls.insuranceProvider;
    insurProviderArr = insurProviderArr.split(",");
    let tempArr1 = [];
    $.each(insurProviderArr, function(i, k) {
        var obj = {};
        obj.desc = k;
        obj.val = i;
        tempArr1.push(obj);
    });
    tempArr1.unshift({
        "val": '-1',
        "desc": ApzCOB.getDescfromLitCode("LIT_COMM_MSG_PLEASE_SELECT")
    });
    apz.populateDropdown(document.getElementById(screenId + "insurProviderDpd"), tempArr1);
}
apz.app.AddLoanDetails.loadRelationshipDpd = function() {
    //let tempArr1 = JSON.parse('[{"val":1,"desc":"Son"},{"val":2,"desc":"Daughter"},{"val":3,"desc":"Guardian"}]');
    let tempArr1 = LOV_LIST.nomineeReation;
    /*tempArr1.unshift({
        "val": '-1',
        "desc": ApzCOB.getDescfromLitCode("LIT_COMM_MSG_PLEASE_SELECT")
    });*/
    apz.populateDropdown(document.getElementById(screenId + "nomineeReationDpd"), tempArr1);
}
// apz.app.AddLoanDetails.loadLoanProducts = function() {
//     var tempLoanPrdArray = [];
//     tempLoanPrdArray = selectedAppObj.eligibleLoan;
//     if (tempLoanPrdArray.length > 0) {
//         /*tempLoanPrdArray.forEach(function(j, k) {
//             var tempLoanObj = {
//                 "productType": j.productType,
//                 "shortDesc": j.shortDesc,
//                 "productId": j.productId,
//                 "product": j.product
//             }
//             tempPurposeArray.push(tempLoanObj);
//         });*/
//         apz.data.scrdata.NEWLOA__LoanProduct_Res = {};
//         apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode = tempLoanPrdArray;
//         apz.data.loadData("LoanProduct", 'NEWLOA');
//     }
// }
apz.app.AddLoanDetails.loadLoanProducts = function() {
    var tempLoanPrdArray = [],
        filteredLoanPrdArray;
    const excludedDescriptions = [];
    KendraApp.ProductResponse.forEach(function(j, i) {
        if (KendraApp.ProductResponse[i].productDtls.productType != 'IGL' || KendraApp.ProductResponse[i].productDtls.description ===
            'Grameen Vishesh Supplementary Loan' || KendraApp.ProductResponse[i].productDtls.description === 'Grameen Vishesh Loan') {
            excludedDescriptions.push(KendraApp.ProductResponse[i].productDtls.description)
        }
    })
    const iglProducts = ["Grameen Vishesh Loan", "Grameen Vishesh Supplementary Loan"];
    if (KendraApp.ProductResponse.length > 0) {
        KendraApp.ProductResponse.forEach(function(j, k) {
            var tempLoanObj = {
                "description": j.productDtls.description
            }
            tempLoanPrdArray.push(tempLoanObj);
        });
        apz.data.scrdata.NEWLOA__LoanProduct_Res = {};
        if (KendraApp.selectedCustomer.custStatus === 'NQA') {
            filteredLoanPrdArray = tempLoanPrdArray.filter(item => excludedDescriptions.includes(item.description));
        } else {
            filteredLoanPrdArray = tempLoanPrdArray.filter(item => !iglProducts.includes(item.description));
        }
        if (window.reIncomeAssessment) {
            //window.reIncomeAssessment = false;
            filteredLoanPrdArray = tempLoanPrdArray.filter(item => iglProducts.includes(item.description));
        }
        apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode = filteredLoanPrdArray;
        apz.data.loadData("LoanProduct", 'NEWLOA');
    }
}
apz.app.AddLoanDetails.launchLoanProductModal = function(pthis) {
    apz.app.AddLoanDetails.loadLoanProducts();
    ApzCOB.toggleModal(screenId + "loanProductModal");
}
apz.app.AddLoanDetails.launchLoanCBDetailsModal = function(pthis) {
    apz.app.AddLoanDetails.loadLoanCBDetails();
    ApzCOB.toggleModal(screenId + "CBDetailsModal");
}
apz.app.AddLoanDetails.launchPurposeModal = function(pthis) {
    if (apz.app.AddLoanDetails.validateLoanProduct()) {
        apz.app.AddLoanDetails.loadPuposeDetails();
        ApzCOB.toggleModal(screenId + "purposeModal");
        $('#NEWLOA__AddLoanDetails__purposeList_row_0').click()
    }
}
apz.app.AddLoanDetails.launchFrequencyModal = function(pthis) {
    if (apz.app.AddLoanDetails.validateLoanProduct()) {
        apz.app.AddLoanDetails.loadRepaymentFrequency();
        ApzCOB.toggleModal(screenId + "frequencyModal");
    }
}
apz.app.AddLoanDetails.launchDisbModeModal = function(pthis) {
    if (apz.app.AddLoanDetails.validateLoanProduct()) {
        apz.app.AddLoanDetails.loadLoanDisbMode();
        ApzCOB.toggleModal(screenId + "disbModeModal");
    }
}
apz.app.AddLoanDetails.launchInsuranceModal = function(pthis) {
    if (apz.app.AddLoanDetails.validateLoanProduct()) {
        apz.app.AddLoanDetails.loadInsurance();
        ApzCOB.toggleModal(screenId + "insuranceModal");
    }
}
apz.app.AddLoanDetails.launchNomineeModal = function(pthis) {
    // if (apz.app.AddLoanDetails.validateLoanProduct()) {
    apz.app.AddLoanDetails.loadNominee();
    ApzCOB.toggleModal(screenId + "nomineeModal");
    //}
}
apz.app.AddLoanDetails.loadInsurance = function() {
    let insurProviderArr = selLoanProdObj.productDtls.insuranceProvider;
    insurProviderArr = insurProviderArr.split(",");
    let tempArr1 = [];
    $.each(insurProviderArr, function(i, k) {
        var obj = {};
        obj.desc = k;
        obj.val = i;
        tempArr1.push(obj);
    });
    for (let i = tempArr1.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));  
        [tempArr1[i], tempArr1[j]] = [tempArr1[j], tempArr1[i]]; 
    }
    /*tempArr1.unshift({
        "val": '-1',
        "desc": ApzCOB.getDescfromLitCode("LIT_COMM_MSG_PLEASE_SELECT")
    });*/
    apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res = {};
    apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.insurance = tempArr1;
    apz.data.loadData("ModalFieldsIntf", 'NEWLOA');
}
apz.app.AddLoanDetails.loadNominee = function() {
    //let tempArr1 = JSON.parse('[{"val":1,"desc":"Son"},{"val":2,"desc":"Daughter"},{"val":3,"desc":"Guardian"}]');
    let tempArr1 = LOV_LIST.nomineeReation;
    apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res = {};
    apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.nomineeList = tempArr1;
    apz.data.loadData("ModalFieldsIntf", 'NEWLOA');
}
//apz.app.AddLoanDetails.onClickRepayFrequency(this);
apz.app.AddLoanDetails.onClickIns = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    $.each(apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.insurance, function(i) {
        if (parseInt(rowNo) === i) {
            $('#' + screenId + 'insCheckBox_' + i).prop('checked', true);
            $('#' + screenId + 'insList_row_' + i).addClass('active');
        } else {
            $('#' + screenId + 'insCheckBox_' + i).prop('checked', false);
            $('#' + screenId + 'insList_row_' + i).removeClass('active');
        }
    });
}
apz.app.AddLoanDetails.onClickNom = function(pthis) {
    //let rowNo = $(pthis).attr("rowno");
    let rowNo = 0;
    if (!apz.isNull(pthis)) {
        rowNo = $(pthis).attr("rowno");
    }
    $.each(LOV_LIST.nomineeReation, function(i, m) {
        if (apz.isNull(pthis)) {
            if (m.desc === 'Spouse' && spouseFlag) {
                $('#' + screenId + 'nomineeCheckBox_' + i).prop('checked', true);
                $('#' + screenId + 'nomList_row_' + i).addClass('active');
                apz.setElmValue(screenId + "nomineeReationDpd", m.desc);
                addLoanDetailsObj.scrDataStep1.nomineeDtls = {
                    "relationWithMemberCode": m.val,
                    "relationWithMember": m.desc
                };
                spouseFlag = false;
            }
        } else if (parseInt(rowNo) === i) {
            $('#' + screenId + 'nomineeCheckBox_' + i).prop('checked', true);
            $('#' + screenId + 'nomList_row_' + i).addClass('active');
        } else {
            $('#' + screenId + 'nomineeCheckBox_' + i).prop('checked', false);
            $('#' + screenId + 'nomList_row_' + i).removeClass('active');
        }
    });
}
apz.app.AddLoanDetails.confirmIns = function() {
    let selectedIns = "";
    $.each(apz.data.scrdata.NEWLOA__ModalFieldsIntf_Res.insurance, function(i) {
        if ($('#' + screenId + 'insCheckBox_' + i).prop('checked')) {
            selectedIns = $('#NEWLOA__ModalFieldsIntf__o__insurance__desc_' + i).text();
        }
    });
    apz.setElmValue(screenId + "insurProviderDpd", selectedIns);
    ApzCOB.toggleModal(screenId + "insuranceModal");
}
apz.app.AddLoanDetails.confirmNominee = function() {
    let nominee = "";
    let nomDet = {};
    $.each(LOV_LIST.nomineeReation, function(i) {
        if ($('#' + screenId + 'nomineeCheckBox_' + i).prop('checked')) {
            nominee = $('#NEWLOA__ModalFieldsIntf__o__nomineeList__desc_' + i).text();
            nomDet = LOV_LIST.nomineeReation[i];
        }
    });
    addLoanDetailsObj.scrDataStep1.nomineeDtls = {
        "relationWithMemberCode": nomDet.val,
        "relationWithMember": nominee
    };
    apz.setElmValue(screenId + "nomineeReationDpd", nominee);
    ApzCOB.toggleModal(screenId + "nomineeModal");
}
apz.app.AddLoanDetails.next = function() {
    var validation = false;
     mandFields = [screenId + "memCheckBox", screenId + "loanAmount", screenId + "purpAndSubpurp", screenId + "repayFreq",
         screenId + "disbMode", screenId + "insurProviderDpd", screenId + "nomineeName", screenId + "nomineeReationDpd"
     ];
    spouseCheckBox = $('#' + screenId + 'spouseCheckBox').is(":checked")
    memCheckBox = $('#' + screenId + 'memCheckBox').is(":checked")
     let updatedMandList = mandFields;
    if (!$("#" + screenId + 'memCheckBox').prop('checked')) {
        updatedMandList = mandFields.filter(item => item !== "NEWLOA__AddLoanDetails__insurProviderDpd");
    }
    if (!memCheckBox && spouseCheckBox) {
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_MEM_NOT_SEL"), "E");
        $('#' + screenId + 'spouseCheckBox').prop('checked', false);
        $("#" + screenId + 'spouseInsChargeDiv').addClass('sno');
        return;
    }
    if (apz.app.AddLoanDetails.validateLoanProduct() && ApzCOB.customeValidateFields(updatedMandList)) {
        validation = true;
        var disbobj = {};
        if (window.loanProduct === "Emergency Loan") {
            disbobj = window.DisbModeEL;
            addLoanDetailsObj.scrDataStep1.disbMode = disbobj;
        } else {
            if (disburseModeArr[0] == 'NEFT') {
                disbobj.id = 2;
            } else if (disburseModeArr[0] == 'CASH') {
                disbobj.id = 1;
            } else {
                disbobj.id = 3;
            }
            disbobj.idDesc = disburseModeArr[0];
            addLoanDetailsObj.scrDataStep1.disbMode = disbobj;
        }
        
        addLoanDetailsObj.scrDataStep1.appId = KendraApp.selectedCustomer.customerId + ApzCOB.generateRandomNumber();
        addLoanDetailsObj.scrDataStep1.loanProd = $('#' + screenId + "loanProdInput").val();
        addLoanDetailsObj.scrDataStep1.loanAmt = parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount")));
        addLoanDetailsObj.scrDataStep1.term = term + 'W';
        addLoanDetailsObj.scrDataStep1.maxAmountLimit = selectedAppObj?.maxAmountLimit||'';
        addLoanDetailsObj.scrDataStep1.interestRate = selLoanProdObj.productDtls.intRate;
        addLoanDetailsObj.scrDataStep1.loanProcessingFee = ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls.intRate, KendraApp.selectedAmt);
        addLoanDetailsObj.scrDataStep1.approxWeeklyInstallAmt = ApzCOB.calApproxWeekInstallment(selLoanProdObj.productDtls.intRate, KendraApp
            .selectedAmt, (term / apz.app.AddLoanDetails.fetchFrequncyVal(apz.getElmValue(screenId + "repayFreq"))));
        var aprxloanamount;
        var aprxloancharges;
        var totalAmount
        if (window.loanProduct === 'Emergency Loan') {
            aprxloanamount = window.loanAmtEL
            aprxloancharges = window.upfrontCharges;
            totalAmount = aprxloanamount - aprxloancharges
        } else {
            aprxloanamount = (parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount"))) - (+ApzCOB.calGSTAmount(lnAmount,window.gstValue,window.feeCharge) + +
                ApzCOB.calProcessingFees(lnAmount,window.feeCharge) + insurAmt)).toString();
            aprxloancharges = ApzCOB.fn_unFormatAmount(ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(lnAmount,window.gstValue,window.feeCharge) + +ApzCOB.calProcessingFees(
                lnAmount,window.feeCharge))));
            totalAmount = aprxloanamount
        }
        addLoanDetailsObj.scrDataStep1.insurDtls = {
            "member": $('#' + screenId + 'memCheckBox').prop('checked') ? 'Y' : 'N',
            "Spouse": $('#' + screenId + 'spouseCheckBox').prop('checked') ? 'Y' : 'N',
            "applicant_insurance_amt": $('#' + screenId + 'memCheckBox').prop('checked') ? insurArr.length === 0 ? 0 : insurArr[0]
                .Borrower_Insurance : '',
            "spouse_insurance_amt": $('#' + screenId + 'spouseCheckBox').prop('checked') ? insurArr.length === 0 ? 0 : insurArr[0]
                .Spouse_Insurance : '',
            "insuranceProvider": $('#' + screenId + 'memCheckBox').prop('checked') ?$('#' + screenId + "insurProviderDpd").val():'',
            //"insurCharges": ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls.insurancePercentage, KendraApp.selectedAmt)
            "insurCharges": insurAmt.toString()
        };
        addLoanDetailsObj.scrDataStep1.nomineeDtls.nomineeName = $('#' + screenId + "nomineeName").val() || "";
        const nomineeDtls = addLoanDetailsObj?.scrDataStep1?.nomineeDtls || {};
        const hasNomineeInfo = nomineeDtls.relationWithMemberCode && nomineeDtls.relationWithMember;
        if(isDraftApplication && !hasNomineeInfo){
            addLoanDetailsObj.scrDataStep1.nomineeDtls.relationWithMemberCode = KendraApp?.currentLoanAppRequest?.applicationdtls?.customerDtls?.loanDtls?.nomineeDtls?.relationWithMemberCode || ""
            addLoanDetailsObj.scrDataStep1.nomineeDtls.relationWithMember = KendraApp?.currentLoanAppRequest?.applicationdtls?.customerDtls?.loanDtls?.nomineeDtls?.relationWithMember || ""
        }
        addLoanDetailsObj.scrDataStep1.purpose.productSubPurpose = addLoanDetailsObj.scrDataStep1.productSubPurpose;
        addLoanDetailsObj.scrDataStep1.chargeAndBreakupDtls = {
            "loanAmt": parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount"))),
            "GST": ApzCOB.calGSTAmount(lnAmount,window.gstValue,window.feeCharge),
            "addInfo1": parseFloat(ApzCOB.calGSTAmount(lnAmount,window.gstValue,window.feeCharge)) + +parseFloat(ApzCOB.calProcessingFees(lnAmount,window.feeCharge)) + parseFloat(insurAmt),
            /*"aprxLoanCharges": (parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls.intRate, KendraApp.selectedAmt)) + parseInt(
                ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls.insurancePercentage, KendraApp.selectedAmt))).toString(),
            "aprxLoanCharges": ApzCOB.fn_unFormatAmount(ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(defAmt) + +ApzCOB.calProcessingFees(
                defAmt)))),*/
            "aprxLoanCharges": aprxloancharges,
            "loanProcessingFee": ApzCOB.calProcessingFees(lnAmount,window.feeCharge),
            /*"aprxLoanAmt": (KendraApp.selectedAmt - (parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls.intRate, KendraApp
                .selectedAmt)) + parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls.insurancePercentage, KendraApp
                .selectedAmt)))).toString(),*/
            "aprxLoanAmt": totalAmount,
            "aprxInstallmentAmt": addLoanDetailsObj.scrDataStep1.approxWeeklyInstallAmt,
            "iscbUpdated":false
        }
        //ApzCOB.launchMicroApp("NEWLOA", "LoanConfrimDetails", "APZCBO__BaseScreens__BaseDIV", KendraApp.selectedCustomer);
        //apz.app.AddLoanDetails.paintconfirmDetails();
        /*if (KendraApp.selectedCustomer.income.length == 0) {
            var obj = {
                "customerId": KendraApp.selectedCustomer.customerId,
                "totIncome": "400000",
                "totExpense": "100000",
                "assesmentDt": "20240308"
            }
            KendraApp.selectedCustomer.income.push(obj)
        }*/
        KendraApp.currentLoanAppRequest = {};
        KendraApp.selectedCustomer.addLoanDetailsObj = addLoanDetailsObj;
        KendraApp.selectedCustomer.addLoanDetailsObj.selEligibleLoanDtls.loanAmt = parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId +
            "loanAmount")));
        KendraApp.currentLoanAppRequest = ApzCOB.prepareSingleLoanRequest();
        //customer / spouse age Validation 
        if (KendraApp.selectedCustomer.maritalStatus === 'MARRIED') {
            custEligibleWeeks = Math.floor(ApzCOB.eligibleWeeks(KendraApp.selectedCustomer.dob, 'customer'));
            spouseEligibleWeeks = Math.floor(ApzCOB.eligibleWeeks(KendraApp.selectedCustomer.depDob, ''));
            var spouseChecked = $('#' + screenId + 'spouseCheckBox').is(":checked");
            if (custEligibleWeeks === 0) {
                ApzCOB.fnDisplayMsg("Age of customer is greater than 65 years", "E");
                return false;
            }
            if (custEligibleWeeks >= term) {
                if (spouseEligibleWeeks <= term && spouseChecked) {
                    ApzCOB.fnDisplayMsg("Insurance not valid for spouse age", "E");
                    return false;
                }
            } else {
                ApzCOB.fnDisplayMsg("Customer age is not eligible for selected tenure, Application can be submitted with lesser tenure", "E");
                return false;
            }
        } else {
            custEligibleWeeks = Math.floor(ApzCOB.eligibleWeeks(KendraApp.selectedCustomer.dob, 'customer'));
            if (custEligibleWeeks < term) {
                ApzCOB.fnDisplayMsg("Customer age is not eligible for selected tenure, Application can be submitted with lesser tenure", "E");
                return false;
            }
        }
        if (validation) {
            apz.app.AddLoanDetails.insurRequired()
            if (insurReq || totalAmt === 0) {
                // ApzCOB.createLoan();
                window.isDraftStage1 = true;
                apz.app.AddLoanDetails.saveData();
                window.KendraApp.remarks='The Loan inputted by '+LoggedInUserDetails.userID +' ('+currentUserRole +')';
                ApzCOB.saveLoan();
                //isDraftApplication = false;
                apz.app.AddLoanDetails.paintconfirmDetails();
            } else {
                ApzCOB.toggleModal(screenId + "interesetRateIncModal");
            }
        }
        if (window.reIncomeAssessment) {
            window.reIncomeAssessment = false;
            //IncomeApp.status = 'APPROVED';
        }
    }
    //ApzCOB.launchMicroApp("NEWLOA", "LoanConfrimDetails", "APZCBO__BaseScreens__BaseDIV", KendraApp.selectedCustomer);
    //apz.app.AddLoanDetails.paintconfirmDetails();
}
apz.app.AddLoanDetails.memberInsurCheck = function(pthis) {
    if (pthis) {
        if ($("#" + pthis.id).prop('checked')) {
            $("#" + screenId + 'insuranceInfoDiv').removeClass('sno');
            $("#" + screenId + 'insuranceCharDiv').addClass('sno');
            $("#" + screenId + 'memInsChargeDiv').removeClass('sno');
        } else {
            $("#" + screenId + 'insuranceInfoDiv').addClass('sno');
            $("#" + screenId + 'insuranceCharDiv').addClass('sno');
            $("#" + screenId + 'memInsChargeDiv').addClass('sno');
            $("#" + screenId + 'spouseInsChargeDiv').addClass('sno');
        }
    }
    var loanAmt = parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount")));
    memCheckBox = $('#' + screenId + 'memCheckBox').is(":checked")
    spouseCheckBox = $('#' + screenId + 'spouseCheckBox').is(":checked")
    insurArr = gApzCOB.insurDetails.filter(arr => (arr.Loan_Amount === loanAmt && (term + 'W') === arr.Tenure));
    /*if (!memCheckBox && !spouseCheckBox){
        insurArr = [];
        totalAmt = 0;
    }*/
    totalAmt = 0;
    if (insurArr.length > 0) {
           var spouseAmt = insurArr[0].Spouse_Insurance;
           var memAmt = insurArr[0].Borrower_Insurance;
        if (memCheckBox && spouseCheckBox) {
            insurAmt = insurArr[0].Spouse_Insurance + insurArr[0].Borrower_Insurance;
            apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
            apz.setElmValue(screenId + "memInsChargeLoan",  ApzCOB.fn_FormatAmount(memAmt));
            apz.setElmValue(screenId + "spouseInsChargeLoan",  ApzCOB.fn_FormatAmount(spouseAmt));
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
        } else if (memCheckBox) {
            insurAmt = insurArr[0].Borrower_Insurance;
            apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
            apz.setElmValue(screenId + "memInsChargeLoan",  ApzCOB.fn_FormatAmount(memAmt));
            apz.setElmValue(screenId + "spouseInsChargeLoan",  "0");
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
        } else if (spouseCheckBox) {
            $("#" + screenId + 'spouseInsChargeDiv').removeClass('sno');
            insurAmt = insurArr[0].Spouse_Insurance;
            apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
            apz.setElmValue(screenId + "spouseInsChargeLoan",  ApzCOB.fn_FormatAmount(spouseAmt));
             apz.setElmValue(screenId + "memInsChargeLoan",  "0");
        } else {
            insurAmt = 0;
            apz.setElmValue(screenId + "insurCharges", "NA");
            apz.setElmValue(screenId + "memInsChargeLoan", "0");
            apz.setElmValue(screenId + "spouseInsChargeLoan", "0");
        }
        var prevAmt = totalAmt;
        totalAmt = insurArr[0].Spouse_Insurance + insurArr[0].Borrower_Insurance;
        if (prevAmt == 0 && totalAmt != 0) {
            if(memCheckBox){
              insurAmt = insurArr[0].Borrower_Insurance;  
            }            
        }
    } else {
        insurAmt = 0;
        apz.setElmValue(screenId + "insurCharges", "NA");
    }
    //totalAmt = insurArr[0].Spouse_Insurance + insurArr[0].Borrower_Insurance;
      if (totalAmt === 0) {
        $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', false);
        $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', true);
        $('#NEWLOA__AddLoanDetails__spouseCheckBox').prop('checked', false);
        $('#NEWLOA__AddLoanDetails__ct_frm_82').addClass('sno');
        insFlag = true;
    } else if (selLoanProdObj.productDtls.memInsurance =='NO'){
        insurArr=[];
        insurAmt = 0;
        $('#NEWLOA__AddLoanDetails__ct_frm_82').addClass('sno');
        $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', true);
    } else {
        $('#NEWLOA__AddLoanDetails__ct_frm_82').removeClass('sno');
        $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
    }
    let aprxLnAmt = loanAmt - (+ApzCOB.calGSTAmount(loanAmt,window.gstValue,window.feeCharge) + +ApzCOB.calProcessingFees(loanAmt,window.feeCharge) + insurAmt);
    apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(loanAmt,window.gstValue,window.feeCharge) + +ApzCOB.calProcessingFees(
        loanAmt,window.feeCharge) + insurAmt).toString()));
    apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
}
apz.app.AddLoanDetails.spouseInsurCheck = function(pthis) {
    var loanAmt = parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount")));
    spouseCheckBox = $('#' + screenId + 'spouseCheckBox').is(":checked")
    memCheckBox = $('#' + screenId + 'memCheckBox').is(":checked")
    insurArr = gApzCOB.insurDetails.filter(arr => (arr.Loan_Amount === loanAmt && (term + 'W') === arr.Tenure));
    if (insurArr.length > 0) {
        var spouseAmt = insurArr[0].Spouse_Insurance;
        var memAmt = insurArr[0].Borrower_Insurance;
        if (memCheckBox && spouseCheckBox) {
            insurAmt = insurArr[0].Spouse_Insurance + insurArr[0].Borrower_Insurance;
            $("#" + screenId + 'spouseInsChargeDiv').removeClass('sno');
            apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
            apz.setElmValue(screenId + "memInsChargeLoan",   ApzCOB.fn_FormatAmount(memAmt));
            apz.setElmValue(screenId + "spouseInsChargeLoan",  ApzCOB.fn_FormatAmount(spouseAmt));
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', true);
        } else if (memCheckBox) {
            insurAmt = insurArr[0].Borrower_Insurance;
            apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
            apz.setElmValue(screenId + "memInsChargeLoan",  ApzCOB.fn_FormatAmount(memAmt));
            apz.setElmValue(screenId + "spouseInsChargeLoan", "0");
            $("#" + screenId + 'spouseInsChargeDiv').addClass('sno');
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
        } else if (spouseCheckBox) {
            if (!memCheckBox) {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_MEM_NOT_SEL"), "E");
                $('#' + screenId + 'spouseCheckBox').prop('checked', false);
                return;
            }
            insurAmt = insurArr[0].Spouse_Insurance;
            apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
            $("#" + screenId + 'spouseInsChargeDiv').removeClass('sno');
            apz.setElmValue(screenId + "memInsChargeLoan", "0");
            apz.setElmValue(screenId + "spouseInsChargeLoan", ApzCOB.fn_FormatAmount(spouseAmt));
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', true);
        } else {
            insurAmt = 0;
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
            apz.setElmValue(screenId + "insurCharges", "NA");
            apz.setElmValue(screenId + "memInsChargeLoan", "0");
            apz.setElmValue(screenId + "spouseInsChargeLoan", "0");
        }
    } else {
        insurAmt = 0;
        $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
        apz.setElmValue(screenId + "insurCharges", "NA");
        apz.setElmValue(screenId + "memInsChargeLoan", "0");
        apz.setElmValue(screenId + "spouseInsChargeLoan", "0");
    }
    let aprxLnAmt = loanAmt - (+ApzCOB.calGSTAmount(loanAmt,window.gstValue,window.feeCharge) + +ApzCOB.calProcessingFees(loanAmt,window.feeCharge) + insurAmt);
    apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(loanAmt,window.gstValue,window.feeCharge) + +ApzCOB.calProcessingFees(
        loanAmt,window.feeCharge) + insurAmt).toString()));
    apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
}
var insurReq = false;
apz.app.AddLoanDetails.insurRequired = function() {
    memCheckBox = $('#' + screenId + 'memCheckBox').is(":checked")
    spouseCheckBox = $('#' + screenId + 'spouseCheckBox').is(":checked")
    if (memCheckBox || spouseCheckBox) {
        insurReq = true;
    } else {
        insurReq = false;
    }
    if (interestRate) {
        insurReq = true;
    }
}
var interestRate = false;
apz.app.AddLoanDetails.OnclickInteresetRateIncModal = function(pthis) {
    var id = pthis.id;
    if (id === 'NEWLOA__AddLoanDetails__yes') {
        insurReq = true;
        interestRate = true;
        ApzCOB.toggleModal(screenId + "interesetRateIncModal");
    } else if (id === 'NEWLOA__AddLoanDetails__no') {
        interestRate = false;
        ApzCOB.toggleModal(screenId + "interesetRateIncModal");
    }
}
apz.app.AddLoanDetails.clearPurposeSubpurposeData = function() {
    apz.data.scrdata.NEWLOA__Purpose_Res = {};
    apz.data.loadData("Purpose", 'NEWLOA');
    apz.data.scrdata.NEWLOA__SubPurpose_Res = {};
    apz.data.loadData("SubPurpose", 'NEWLOA');
}
apz.app.AddLoanDetails.clearSubPurposeData = function() {
    apz.data.scrdata.NEWLOA__SubPurpose_Res = {};
    apz.data.loadData("SubPurpose", 'NEWLOA');
}
apz.app.AddLoanDetails.paintPurposeSubpurpose = function() {
    let purpose = "",
        subPurpose = "";
    $.each(tempPurposeResponse, function(i) {
        if ($('#' + screenId + 'purposeList_row_' + i).hasClass('active')) {
            purpose = $('#' + screenId + "purposeList_row_" + i).text();
            addLoanDetailsObj.scrDataStep1.purpose = JSON.parse(JSON.stringify(tempPurposeResponse[i]));
        }
    });
    $.each(tempSubPurposeResponse, function(i) {
        if ($('#' + screenId + 'subPurposeCheckbox_' + i).prop('checked')) {
            subPurpose = $('#NEWLOA__SubPurpose__o__SubPurposeNode__subPurposeIdDesc_' + i).text();
            addLoanDetailsObj.scrDataStep1.productSubPurpose = JSON.parse(JSON.stringify(tempSubPurposeResponse[i]));
        }
    });
    apz.setElmValue(screenId + "purpAndSubpurp", purpose + " : " + subPurpose);
    if (isDraftApplication) {
        if (!isFirstPurposeCall) {
            ApzCOB.toggleModal(screenId + "purposeModal");
        } else {
            isFirstPurposeCall = false; // set to false so that next time it goes inside
        }
    } else {
        ApzCOB.toggleModal(screenId + "purposeModal");
    }
    purp = purpose;
    subPurp = subPurpose;
}
   apz.app.AddLoanDetails.paintRepayFrequency = function() {
        let repayFreq = KendraApp.selectedKendra.meetingFrequency;
        if (selLoanProdDesc != "Emergency Loan") {
            repayFreq = "";
            $.each(repaymentFreqOpt, function(i) {
                if ($('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked')) {
                    repayFreq = $('#NEWLOA__ModalFieldsIntf__o__repaymentFreqNode__idDesc_' + i).text();
                    addLoanDetailsObj.scrDataStep1.repayFrequency = repaymentFreqOpt[i];
                }
            });
            // if(isDraftApplication){
            //     repaymentFreqOpt.forEach(function(j, i) {
            //         if (repaymentFreqOpt[i].idDesc === draftCustData?.customerDtls?.loanDtls?.repayFrequency?.idDesc) {
            //             $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', true);
            //             $('#' + screenId + 'repayFreqList_row_' + i).addClass('active');
            //             repayFreq = $('#NEWLOA__ModalFieldsIntf__o__repaymentFreqNode__idDesc_' + i).text();
            //             addLoanDetailsObj.scrDataStep1.repayFrequency = repaymentFreqOpt[i];
            //         } else {
            //             $('#' + screenId + 'repayFreqCheckbox_' + i).prop('checked', false);
            //             $('#' + screenId + 'repayFreqList_row_' + i).removeClass('active');
            //         }
            //     });
            //     if (!isFirstFrequencyCall) {
            //         ApzCOB.toggleModal(screenId + "frequencyModal");
            //     } else {
            //         isFirstFrequencyCall = false; // set to false so that next time it goes inside
            //     }
            // }else{
            //     ApzCOB.toggleModal(screenId + "frequencyModal");
            // }
             if (isDraftApplication || isApplicationFromCalculator) {
               if (!isFirstFrequencyCall) {
                 ApzCOB.toggleModal(screenId + "frequencyModal");
               } else {
                 isFirstFrequencyCall = false; // set to false so that next time it goes inside
               }
             } else {
               ApzCOB.toggleModal(screenId + "frequencyModal");
             }
            apz.setElmValue(screenId + "repayFreq", repayFreq);
            //ApzCOB.toggleModal(screenId + "frequencyModal");
        }
        if (selLoanProdDesc === "Emergency Loan") {
            var lnAmtInputEL = document.getElementById("NEWLOA__AddLoanDetails__loanAmount");
            //var lnAmount = parseInt(lnAmtInput.value.replace(/,/g, ''), 10);
            lnAmountEL = parseInt(lnAmtInputEL.value.replace(/[₹,]/g, ''));
            if (repayFreq === 'WEEKLY' && lnAmountEL === 1000) {
                document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 28';
            } else if ((repayFreq === 'BIWEEKLY' || repayFreq === 'BI-WEEKLY') && lnAmountEL === 1000){
                document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 33';
            } else if (repayFreq === 'WEEKLY' && lnAmountEL === 2000) {
                document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 91';
            } else if ((repayFreq === 'BI-WEEKLY' || repayFreq === 'BIWEEKLY') && lnAmountEL === 2000) {
                document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 101';
            }
            var UpFrontFeeCharge;
            var InterestRate;
            if (lnAmountEL === 1000 && repayFreq === 'WEEKLY') {
                UpFrontFeeCharge = UpfrontCharges[0].upfrontFee;
                InterestRate = UpfrontCharges[0].interest_Fee;
                apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
                apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
                let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
                apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            } else if (lnAmountEL === 1000 && (repayFreq === 'BI-WEEKLY' ||repayFreq === 'BIWEEKLY' )) {
                UpFrontFeeCharge = UpfrontCharges[1].upfrontFee;
                InterestRate = UpfrontCharges[1].interest_Fee;
                apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
                apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
                let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
                apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            } else if (lnAmountEL === 2000 && repayFreq === 'WEEKLY') {
                UpFrontFeeCharge = UpfrontCharges[2].upfrontFee;
                InterestRate = UpfrontCharges[2].interest_Fee;
                apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
                apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
                let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
                apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            } else if (lnAmountEL === 2000 && (repayFreq === 'BI-WEEKLY' ||repayFreq === 'BIWEEKLY' )) {
                UpFrontFeeCharge = UpfrontCharges[3].upfrontFee;
                InterestRate = UpfrontCharges[3].interest_Fee;
                apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
                apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
                let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
                apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            }
            if (repayFreq === "WEEKLY") {
                addLoanDetailsObj.scrDataStep1.repayFrequency = {id: 0, idDesc: 'WEEKLY'};
                document.getElementById('NEWLOA__AddLoanDetails__gstAmt_txtcnt').innerText = '₹ 100';
            } else if (repayFreq === 'BIWEEKLY' || repayFreq === 'BI-WEEKLY') {
                addLoanDetailsObj.scrDataStep1.repayFrequency = {id: 1, idDesc: 'BI-WEEKLY'}
                document.getElementById('NEWLOA__AddLoanDetails__gstAmt_txtcnt').innerText = '₹ 200';
            }
            
            
            window.upfrontCharges = UpFrontFeeCharge;
            window.loanAmtEL = lnAmountEL;
        }
    }
apz.app.AddLoanDetails.paintLoanProduct = function() {
    let loanProdVal = "";
    $.each(apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode, function(i) {
        if ($('#' + screenId + 'loanProductCheckBox_' + i).prop('checked')) {
            loanProdVal = $('#NEWLOA__LoanProduct__o__loanProductNode__description_' + i).text();
            addLoanDetailsObj.scrDataStep1.loanProductVal = apz.data.scrdata.NEWLOA__LoanProduct_Res.loanProductNode[i];
        }
    })
    $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', true);
    if (isDraftApplication) {
        if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls.member === 'Y') {
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', true);
        } else if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls.member === 'N') {
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', false);
        } else {
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', true);
        }
    }
    apz.setElmValue(screenId + "loanProdInput", loanProdVal);
    apz.app.AddLoanDetails.onChangeLoanProduct(loanProdVal);
    if(isDraftApplication || isApplicationFromCalculator){
        if(!isFirstProductCall){
            ApzCOB.toggleModal(screenId + "loanProductModal");
        } else {
            isFirstProductCall = false; // set to false so that next time it goes inside
        }
    }else{
        ApzCOB.toggleModal(screenId + "loanProductModal");
    }
    window.loanProduct = loanProdVal;
    if (window.loanProduct === "Emergency Loan") {
        $('#NEWLOA__AddLoanDetails__ct_frm_83').addClass('sno');
        document.getElementById('NEWLOA__AddLoanDetails__el_txt_352_txtcnt').innerText = 'Upfront Charges (Including GST)';
        document.getElementById('NEWLOA__AddLoanDetails__el_txt_715_txtcnt').innerText = 'Approx Installment Amount';
        // $('#NEWLOA__AddLoanDetails__ct_frm_82').addClass('sno');
    } else {
        document.getElementById('NEWLOA__AddLoanDetails__el_txt_352_txtcnt').innerText = 'Loan Processing Fees';
        document.getElementById('NEWLOA__AddLoanDetails__el_txt_715_txtcnt').innerText = 'GST';
        $('#NEWLOA__AddLoanDetails__ct_frm_83').removeClass('sno');
        //  $('#NEWLOA__AddLoanDetails__ct_frm_82').removeClass('sno');
    }
}
apz.app.AddLoanDetails.fetchFrequncyVal = function(freqDesc) {
    if (!apz.isNull(freqDesc)) {
        switch (freqDesc) {
            case "FOUR.WEEKLY":
                return 4;
            case "BIWEEKLY":
                return 2;
            default:
                return 1;
        }
    }
}
apz.app.AddLoanDetails.paintDisbursementMode = function() {
    let disbMode = "";
    $.each(disbModeOpt, function(i) {
        if ($('#' + screenId + 'disbModeCheckbox_' + i).prop('checked')) {
            disbMode = $('#NEWLOA__ModalFieldsIntf__o__disbModeNode__idDesc_' + i).text();
            addLoanDetailsObj.scrDataStep1.disbMode = disbModeOpt[i];
            window.DisbModeEL = addLoanDetailsObj.scrDataStep1.disbMode;
        }
    });
    tempDisbCashMode = disbMode;
    apz.setElmValue(screenId + "disbMode", disbMode);
    if (isDraftApplication) {
        if (!isFirstDisbursementModeCall) {
            ApzCOB.toggleModal(screenId + "disbModeModal");
        } else {
            isFirstDisbursementModeCall = false; // set to false so that next time it goes inside
        }
    } else {
        ApzCOB.toggleModal(screenId + "disbModeModal");
    }
}
apz.app.AddLoanDetails.paintconfirmDetails = function() {
    //KendraApp.selectedCustomer.addLoanDetailsObj = addLoanDetailsObj;
    // KendraApp.selectedCustomer.vintageYear = 'Vintage ' + Math.round(KendraApp.selectedCustomer.vintage / 365) + ' Years';
    KendraApp.selectedCustomer.vintageYear = 'Vintage ' + KendraApp.selectedCustomer.custVintage + ' Years';
    //apz.setElmValue(screenId + "conappId", "#" + KendraApp.AppCreateResObj.applicationId);
    var refNo = KendraApp.selectedCustomer.customerId + ApzCOB.generateRandomNumber();
    window.customerMobNum = KendraApp.selectedCustomer.mobileNum;
    apz.setElmValue(screenId + "conappId", "#" + refNo);
    apz.setElmValue(screenId + "conuserprof", KendraApp.selectedCustomer.customerName.slice(0, 1));
    apz.setElmValue(screenId + "conCustName", KendraApp.selectedCustomer.customerName);
    apz.setElmValue(screenId + "congroupID", KendraApp.selectedCustomer.groupId);
    apz.setElmValue(screenId + "conCustID", KendraApp.selectedCustomer.customerId);
    apz.setElmValue(screenId + "conloanLimit", KendraApp?.selectedCustomer?.maxAmountLimit?ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.maxAmountLimit):'');
    apz.setElmValue(screenId + "conVintageYear", KendraApp.selectedCustomer.vintageYear);
    apz.setElmValue(screenId + "condob", ApzCOB.dateformatter(ApzCOB.dateStringToDate(KendraApp.selectedCustomer.dob), "d M'y"));
    apz.setElmValue(screenId + "conmaritialStatus", KendraApp.selectedCustomer.maritalStatus);
    if (KendraApp.selectedCustomer.maritalStatus === 'MARRIED') {
        $("#" + screenId + 'sc_row_505').removeClass('sno');
        $("#" + screenId + 'sc_row_510').removeClass('sno');
        apz.setElmValue(screenId + "conSpouseDOB", KendraApp.selectedCustomer.depname + ',' + ApzCOB.dateformatter(ApzCOB.dateStringToDate(
            KendraApp.selectedCustomer.depDob), "d M'y"));
        apz.setElmValue(screenId + "spouseKyc", KendraApp.selectedCustomer.depDocType + " (" + KendraApp.selectedCustomer.depDocId + ") ");
    } else {
        $("#" + screenId + 'sc_row_505').addClass('sno');
        $("#" + screenId + 'sc_row_510').addClass('sno');
    }
    /*apz.setElmValue(screenId + "conSpouseDOB", KendraApp.selectedCustomer.earnings[0].name + ',' + ApzCOB.dateformatter(ApzCOB.dateStringToDate(
        KendraApp.selectedCustomer.earnings[0].dob), "d M'y"));*/
    // apz.setElmValue(screenId + "conmobNo", KendraApp.selectedCustomer.mobileNum);
    apz.setElmValue(screenId + "memberKyc", KendraApp.selectedCustomer.primaryType + " (" + KendraApp.selectedCustomer.primaryId + ") ");
    apz.setElmValue(screenId + "conaccNo", KendraApp.selectedCustomer.bankAccNo);
    apz.setElmValue(screenId + "conbankifsc", KendraApp.selectedCustomer.bankName + ", " + KendraApp.selectedCustomer.bankIfscCode);
    apz.setElmValue(screenId + "conbranch", KendraApp.selectedCustomer.bankBranchName);
    // apz.setElmValue(screenId + "conincome", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totIncome));
    // apz.setElmValue(screenId + "conexpense", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totExpense));
    // apz.setElmValue(screenId + "contotalIncome", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totIncome - KendraApp
    //     .selectedCustomer.income[0].totExpense));
    if (KendraApp.selectedCustomer.earnings.length === 0) {
        $('#NEWLOA__AddLoanDetails__sc_row_519').addClass('sno');
    } else {
        $('#NEWLOA__AddLoanDetails__sc_row_519').removeClass('sno');
        var memberstext = 'Earning members in the family (' + KendraApp.selectedCustomer.earnings.length + ')';
        apz.setElmValue(screenId + "memberscount", memberstext);
        var memberstext = 'Earning members in the family (' + KendraApp.selectedCustomer.earnings.length + ')';
        apz.setElmValue(screenId + "memberscount", memberstext);
        var membersname = '';
        if (KendraApp.selectedCustomer.earnings.length == 0) {
            membersname = KendraApp.selectedCustomer.earnings[0].name + ' (' + KendraApp.selectedCustomer.earnings[0].memRelation + ')'
        } else {
            KendraApp.selectedCustomer.earnings.forEach(function(el, i) {
                if (i == KendraApp.selectedCustomer.earnings.length - 1) {
                    membersname += KendraApp.selectedCustomer.earnings[i].name + ' (' + KendraApp.selectedCustomer.earnings[i]
                        .memRelation + ')';
                } else if (i == 0) {
                    membersname = KendraApp.selectedCustomer.earnings[i].name + ' (' + KendraApp.selectedCustomer.earnings[i]
                        .memRelation + '),';
                } else {
                    membersname += KendraApp.selectedCustomer.earnings[i].name + ' (' + KendraApp.selectedCustomer.earnings[i]
                        .memRelation + '),';
                }
            });
        }
        apz.setElmValue(screenId + "membersname", membersname);
    }
    apz.setElmValue(screenId + "conloanAmt", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.chargeAndBreakupDtls
        .loanAmt));
    apz.setElmValue(screenId + "memberInsAmt", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls.applicant_insurance_amt ? KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls.applicant_insurance_amt : "0"));
    apz.setElmValue(screenId + "spouseInsAmt", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls.spouse_insurance_amt ? KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls.spouse_insurance_amt : "0"));
    apz.setElmValue(screenId + "conloanIns", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls
        .insurCharges));
    var processFee = parseFloat(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.chargeAndBreakupDtls.aprxLoanCharges);
    /*apz.setElmValue(screenId + "conloanFee", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.chargeAndBreakupDtls
        .aprxLoanCharges));*/
    if(window.loanProduct === 'Emergency Loan'){
        $('#NEWLOA__AddLoanDetails__el_txt_435').text('Upfront charges');
    }
    apz.setElmValue(screenId + "conloanFee", ApzCOB.fn_FormatAmount(processFee));
    apz.setElmValue(screenId + "conloanFinalAmt", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1
        .chargeAndBreakupDtls.aprxLoanAmt));
    //member income details 
    if (KendraApp.selectedCustomer.income && KendraApp.selectedCustomer.income.length > 0) {
        // Data is present
        $('#' + screenId + 'ct_frm_119').removeClass('sno');
        $('#' + screenId + 'membIncDetailsOne').addClass('sno');
        $('#' + screenId + 'addIncomeRow').addClass('sno');
        var earningMembers = KendraApp.selectedCustomer.income.length;
        var totalFamilyIncome = 0;
        var yearlyExpenses = 0;
        KendraApp.selectedCustomer.income.forEach(function(item) {
            totalFamilyIncome += parseInt(item.totIncome);
            yearlyExpenses += parseInt(item.totExpense);
        });
        apz.setElmValue(screenId + "earningMemb", `Earning members in the family (${earningMembers})`);
        apz.setElmValue(screenId + "totalFamilyIncome", ApzCOB.fn_FormatAmount(totalFamilyIncome));
        apz.setElmValue(screenId + "yearlyExp", ApzCOB.fn_FormatAmount(yearlyExpenses));
        // Set the income-related values only if income data exists
        apz.setElmValue(screenId + "conincome", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totIncome));
        apz.setElmValue(screenId + "conexpense", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totExpense));
        apz.setElmValue(screenId + "contotalIncome", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totIncome - KendraApp
            .selectedCustomer.income[0].totExpense));
        //apz.app.AddLoanDetails.updateIncomeDet();
    } else {
        // No income data is present
        $('#' + screenId + 'ct_frm_119').addClass('sno');
        $('#' + screenId + 'membIncDetailsOne').removeClass('sno');
        $('#' + screenId + 'addIncomeRow').removeClass('sno');
        var earningMembers = 0;
        var totalFamilyIncome = 0;
        var yearlyExpenses = 0;
    }
    apz.app.AddLoanDetails.updateIncomeDet();
    $('#' + screenId + 'stage1').addClass('sno');
    $('#' + screenId + 'stage3').addClass('sno');
    $('#' + screenId + 'stage4').addClass('sno');
    $('#' + screenId + 'stage2').removeClass('sno');
    window.isDraftStage2 = true;
    apz.app.AddLoanDetails.addMobileNum();
}
apz.app.AddLoanDetails.PendingloanRequest = function(loanReq) { //Request for transfer
    ApzCOB.prepareSingleLoanRequest(loanReq);
};
apz.app.AddLoanDetails.addMobileNum = function() {
    if (KendraApp.selectedCustomer.mobileNum) {
        apz.setElmValue(screenId + "conmobNo", KendraApp.selectedCustomer.mobileNum);
        $('#' + screenId + 'conmobNo').removeClass('sno');
        $('#' + screenId + 'el_btn_29').removeClass('sno');
        $('#' + screenId + 'ct_frm_105').removeClass('sno');
        $('#' + screenId + 'addMobile_ul').addClass('sno');
        $('#' + screenId + 'sc_row_825').addClass('sno');
    } else {
        $('#' + screenId + 'conmobNo').addClass('sno');
        $('#' + screenId + 'el_btn_29').addClass('sno');
        $('#' + screenId + 'ct_frm_105').addClass('sno');
        $('#' + screenId + 'addMobile_ul').removeClass('sno');
        $('#' + screenId + 'sc_row_825').removeClass('sno');
    }
    if (KendraApp.selectedKendra.officeData.consentType == "Manual" || selLoanProdObj.productDtls.consentType == "Manual") {
        $('#' + screenId + 'ct_frm_105').removeClass('sno');
        $('#' + screenId + 'sc_row_825').addClass('sno');
    }
    apz.app.AddLoanDetails.checkMobileNumExit()
}
apz.app.AddLoanDetails.checkMobileNumExit = function() {
    if (!apz.isObjectEmpty(window.IncomeApp.payLoad) && KendraApp.selectedCustomer.mobileNum) {
        if (IncomeApp.status === 'APPROVED' || IncomeApp.status === 'PENDINGBYRPC') {
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);
            apz.app.AddLoanDetails.saveData();
        } else {
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
        }
    }else{
        $('#' + screenId + 'ct_frm_105').addClass('sno');
    }
}
apz.app.AddLoanDetails.CBcheckold = function() {
    //KendraApp.currentLoanAppRequest = {};
    //KendraApp.currentLoanAppRequest = ApzCOB.prepareSingleLoanRequest();
    apz.app.AddLoanDetails.CBcheckCB();
    document.getElementById(screenId + 'sucRefId').classList.remove('sno');
}
apz.app.AddLoanDetails.CBcheckCB = function() {
    apz.setElmValue(screenId + "sucCustName", KendraApp.selectedCustomer.customerName);
    apz.setElmValue(screenId + "sumuserprof", KendraApp.selectedCustomer.customerName.slice(0, 1));
    apz.setElmValue(screenId + "sucGroup", KendraApp.selectedCustomer.groupId);
    apz.setElmValue(screenId + "sucCustId", KendraApp.selectedCustomer.customerId);
    apz.setElmValue(screenId + "sucVintage", KendraApp.selectedCustomer?.vintageYear);
    apz.setElmValue(screenId + "sucLoanlimt", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.maxAmountLimit));
    apz.setElmValue(screenId + "sucProductName", KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls?.description
.toUpperCase());
    apz.setElmValue(screenId + "sucAppliedAmt", ApzCOB.fn_FormatAmount(KendraApp.currentLoanAppRequest.applicationdtls.amount));
    apz.app.AddLoanDetails.setAttributeValues("attrOne", cbResponse.Derived_Attribute_1);
    apz.app.AddLoanDetails.setAttributeValues("attrTwo", cbResponse.Derived_Attribute_2);
    apz.app.AddLoanDetails.setAttributeValues("attrThree", cbResponse.Derived_Attribute_3);
    apz.app.AddLoanDetails.setAttributeValues("attrFour", cbResponse.Derived_Attribute_4);
    /*apz.setElmValue(screenId + "sucElAmt", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.chargeAndBreakupDtls
        .loanAmt));*/
    apz.setElmValue(screenId + "sucRefId", "#" + KendraApp.AppCreateResObj.applicationId);
    $('#' + screenId + 'stage1').addClass('sno');
    $('#' + screenId + 'stage2').addClass('sno');
    $('#' + screenId + 'stage3').removeClass('sno');
    $('#' + screenId + 'stage4').addClass('sno');
}
apz.app.AddLoanDetails.setAttributeValues = function(attributeName, derivedAttribute) {
    if (derivedAttribute) {
        let attrValAndDesc = derivedAttribute.split(":");
        if (attrValAndDesc.length > 0) {
            apz.setElmValue(screenId + attributeName + "Val", attrValAndDesc[0] || '');
        } else {
            apz.setElmValue(screenId + attributeName + "Val", '');
        }
        if (attrValAndDesc.length > 1) {
            apz.setElmValue(screenId + attributeName + "Desc", attrValAndDesc[1] || '');
        } else {
            apz.setElmValue(screenId + attributeName + "Desc", '');
        }
    } else {
        apz.setElmValue(screenId + attributeName + "Val", '');
        apz.setElmValue(screenId + attributeName + "Desc", '');
    }
}
apz.app.AddLoanDetails.edit = function(stage) { //Delete scheduled transfer flow
    stagestep = stage;
    if (stagestep === 'stage1' && isDraftApplication === true) {
        if(isApplicationFromCalculator){
                $('#APZCBO__BaseScreens__STAGE1').addClass('sno')
                ApzCOB.fnDisplayMsg("Are you sure you want to save the application", "C", apz.app.AddLoanDetails.cancelCB);
                $(".ajs-button.ajs-ok").text("Yes");
                $(".ajs-button.ajs-cancel").text("No");
                return;
        }
        if(isDraftNewLoan){
            $('#APZCBO__BaseScreens__STAGE1').addClass('sno')
            ApzCOB.launchMicroApp("NEWLOA", "NewLoanApplication", "APZCBO__BaseScreens__BaseDIV", KendraApp.selectedKendra)
            $('#Income__MonthlyHouseHoldExp__inComeSuc').removeClass('sno');
            return
        }else{
            $('#APZCBO__BaseScreens__STAGE1').addClass('sno');
            $('#APZCBO__BaseScreens__BaseDIV').removeClass('sno');
            window.isDraftBackNavigation = true;
            //ApzCOB.launchMicroApp('Audit', 'LoanApplicationPending', 'APZCBO__BaseScreens__BaseDIV', draftCustData);
            ApzCOB.launchMicroApp("Audit", "AllLoanApplication", 'APZCBO__BaseScreens__BaseDIV', KendraApp.currentLoanAppRequest.applicationdtls);
            //$('#Income__MonthlyHouseHoldExp__inComeSuc').removeClass('sno');
            return
        }
        //window.isDraft = true;
    }
    if (stagestep === 'stage1' && isKendraDtlsToAddLoan === true) {
        isKendraDtlsToAddLoan = false
        isAddLoanToKendraDtls = true
        //KendraDetailscrId = 'Kendra__KendraDetails__';
        ApzCOB.launchMicroApp('Kendra', 'KendraDetails', 'APZCBO__BaseScreens__BaseDIV', KendraApp.selectedKendra);
        $('#APZCBO__BaseScreens__STAGE1').addClass('sno');
        return
    }
    if (stagestep === 'stage1') {
        $('#APZCBO__BaseScreens__STAGE1').addClass('sno')
        if(isApplicationFromCalculator){
                ApzCOB.fnDisplayMsg("Are you sure you want to save the application", "C", apz.app.AddLoanDetails.cancelCB);
                $(".ajs-button.ajs-ok").text("Yes");
                $(".ajs-button.ajs-cancel").text("No");
                return;
        }
        ApzCOB.launchMicroApp("NEWLOA", "NewLoanApplication", "APZCBO__BaseScreens__BaseDIV", KendraApp.selectedKendra)
    } else if (stagestep === 'stage2') {
        $('#' + screenId + 'stage1').removeClass('sno');
        $('#' + screenId + 'stage2').addClass('sno');
        $('#' + screenId + 'stage3').addClass('sno');
        $('#' + screenId + 'stage4').addClass('sno');
        if (IncomeApp.flow === 'fromApp' && !upgrFlag) {
            $('#APZCBO__BaseScreens__BaseDIV').addClass('sno')
            $('#APZCBO__BaseScreens__STAGE1').removeClass('sno')
        }
    } else {
        if (backReject) {
            apz.app.AddLoanDetails.rejectApp();
        } else if (cbResponse.Final_Decision === 'REJECT') {
            ApzCOB.fnDisplayMsg("Do you want to cancel the application?", "C", apz.app.AddLoanDetails.reject);
        } else if(cbResponse.Final_Decision === 'Approved' || cbResponse.Final_Decision === 'Approved with Pre-closure'){
            //  ApzCOB.fnDisplayMsg("Do you want to cancel the application?", "C", apz.app.AddLoanDetails.reject);
        }else {
            $('#' + screenId + 'stage1').addClass('sno');
            $('#' + screenId + 'stage2').removeClass('sno');
            $('#' + screenId + 'stage3').addClass('sno');
            $('#' + screenId + 'stage4').addClass('sno');
        }
    }
    if (stagestep === 'stage2' && reIncome === true) {
        window.reIncomeAssessment = true;
    }else{
        window.reIncomeAssessment = false;
    }
    //ApzRMB.fnDisplayMsg('Do you want to cancel the application?', 'C', apz.app.AddLoanDetails.editCallBack);
};
apz.app.AddLoanDetails.cancelCB = function(params) {
    if (params.choice === true) {
        // isApplicationFromCalculator = false;
        // window.isLoanCreateFromCalculator = true
        // ApzCOB.launchMicroApp("NEWLOA", "NewLoanApplication", "APZCBO__BaseScreens__BaseDIV", KendraApp.selectedKendra)
        if(isApplicationFromMemberCalculator){
             isApplicationFromMemberCalculator = false;
                // let obj={
                //     'scr':'NewLoanApplication',
                //     'childScrId':'NEWLOA'
                // }
                // ApzCOB.launchMicroApp("Custom", "CustomerDetails", "APZCBO__BaseScreens__BaseDIV", obj);
                window.isBackToCalculation = true;
                ApzCOB.launchMicroApp('Calcu', 'LoanEmiCalculator', 'APZCBO__BaseScreens__BaseDIV', 'CustomerDetails');
        }else{
             isApplicationFromCalculator = false;
             window.isLoanCreateFromCalculator = true
            ApzCOB.launchMicroApp("NEWLOA", "NewLoanApplication", "APZCBO__BaseScreens__BaseDIV", KendraApp.selectedKendra)
        }
    } else {
        KendraApp.LoanCalculatorObj={};
        ApzCOB.launchMicroApp('Dashbo', 'dashboard', gAppId + '__BaseScreens__BaseDIV', '');
    }
}
apz.app.AddLoanDetails.onClickOfBack = function(params) {
    console.log(params);
    if (params.choice === true) {
        window.newLoan = true;
        ApzCOB.launchMicroApp('Dashbo', 'dashboard', gAppId + '__BaseScreens__BaseDIV', '');
        //.dashboardAppListAPI();
    }
}
apz.app.AddLoanDetails.rejectRequest = function(stage) {
    window.CRTworkflow = {
        "currentRole": "KM",
        "action": "REJECT",
        "workflowId": "LOANINPUT",
        "stage": "USERCHECK",
        "remarks": stage
    }
    var applicationDetails = [];
    applicationDetails.push({
        "applicationId": selectedAppList[selectedAppList.length - 1].applicationId,
        "versionNum": selectedAppList[selectedAppList.length - 1].versionNo
    });
    var req = {
        "apiRequest": {
            "appId": gAppId,
            "interfaceName": "KMActionPostCBCheck",
            "requestObj": {
                "workflow": window.CRTworkflow,
                "createdBy": LoggedInUserDetails.userID,
                // "applicationId": userRole === 'CRT' ? KendraApp.crtObj.applicationId : KendraApp.AppCreateResObj.applicationId,
                "applicationId": "",
                "applicationStatus": 'Move to BM',
                "appId": gAppId,
                "cbApproveManual": "N",
                "versionNum": "",
                "applicationDetailList": applicationDetails
            }
        }
    }
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstartTimer("WorkflowUpdate", req);
        apz.app.BaseScreens.UElogevent("WorkflowUpdate", req);
    }
    ApzCOB.serverBuildParam(gAppId, 'KMActionPostCBCheck', 'N', 'N', req, 'Y', apz.app.AddLoanDetails.rejectRequestCB);
}
apz.app.AddLoanDetails.rejectRequestCB = function(params) {
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstopTimer("WorkflowUpdate ", params.req);
    }
    if (ApzCOB.handleServiceCallBacks(params)) {
        if (params.res.APZCBO__KMActionPostCBCheck_Res.apiResponse.ResponseHeader.ResponseCode == "0") {
            // to-do 
        } else {
            apz.stopLoader();
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
        }
    } else {
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E", ApzCOB.ReloadApp);
    }
    apz.stopLoader();
}
apz.app.AddLoanDetails.deleteApplicationRequest = function(params) {
    if (params.choice === true) {
        var currentAppId = KendraApp.AppCreateResObj.applicationId;
        let reqObj = {
            "apiRequest": {
                "appId": apz.appId,
                "interfaceId": "DeleteApplication",
                "userId": LoggedInUserDetails.userID,
                "requestObj": {
                    "applicationId": currentAppId
                }
            }
        }
        ApzCOB.serverBuildParam(gAppId, "DeleteApplication", "N", "N", reqObj, false, apz.app.AddLoanDetails.deleteApplicationRequestCB);
    } else {
        return;
    }
}
apz.app.AddLoanDetails.deleteApplicationRequestCB = function(params) {
    try {
        if (params.status && apz.isNull(params.errors)) {
            if (params.res.APZCBO__DeleteApplication_Res.apiResponse.ResponseHeader.hasOwnProperty("ResponseCode")) {
                if (params.res.APZCBO__DeleteApplication_Res.apiResponse.ResponseHeader.ResponseCode === "0") {
                    window.newLoan = true;
                    ApzCOB.launchMicroApp('Dashbo', 'dashboard', gAppId + '__BaseScreens__BaseDIV', '');
                    //ApzCOB.dashboardAppListAPI();
                }
            }
        }
    } catch (e) {
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
    }
}
apz.app.AddLoanDetails.activeloanlistconfirm = function() {
    if ($('#' + screenId + 'activeconLoanList').is(':visible')) {
        $('#' + screenId + 'activeconLoanList').addClass('sno');
    } else {
        let tempArray = [];
        if (KendraApp.selectedCustomer.loanDtls.length > 0) {
            $('#' + screenId + 'activeconLoanList').removeClass('sno');
        } else {
            $('#' + screenId + 'activeconLoanList').addClass('sno');
            ApzCOB.fnDisplayMsg("No Existing Loans Available", "I");
        }
    }
}
apz.app.AddLoanDetails.activeloanlistsummary = function() {
    if ($('#' + screenId + 'activesumLoanList').is(':visible')) {
        $('#' + screenId + 'activesumLoanList').addClass('sno');
    } else {
        let tempArray = [];
        if (KendraApp.selectedCustomer.loanDtls.length > 0) {
            $('#' + screenId + 'activesumLoanList').removeClass('sno');
        } else {
            $('#' + screenId + 'activesumLoanList').addClass('sno');
            ApzCOB.fnDisplayMsg("No Existing Loans Available", "I");
        }
    }
}
apz.app.AddLoanDetails.validateLoanProduct = function() {
    var loanProductVal = apz.getElmValue("NEWLOA__AddLoanDetails__loanProdInput");
    if ("" === loanProductVal || "-1" === loanProductVal) {
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_LOAN_PRODUCT_ERROR_MSG"), "E");
        return false;
    } else {
        return true;
    }
}
apz.app.AddLoanDetails.onclickLoanAmount = function(pthis) {
    if (apz.app.AddLoanDetails.validateLoanProduct()) {
        //nothing to do
    } else {
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", "");
    }
}
apz.app.AddLoanDetails.onblurLoanAmount = function(pthis) {
    //var id = pthis.id;defaultAmount
    var id = $("#" + pthis.id).val();
    var loanAmt = parseInt(id.replace(/[₹,]/g, ''));
    let originalLoanAmount = parseInt(defAmt, 10);
    if (loanAmt > maxAmt) {
        ApzCOB.fnDisplayMsg("loan amount is more than maximum amount", 'I');
    } else if (loanAmt < minAmt) {
        ApzCOB.fnDisplayMsg("loan amount is less than minimum amount", 'I');
    }
    /*if (loanAmt % 1000 === 0) {
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(loanAmt));
    } else {
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", defaultAmount);
    }
    if (loanAmt > maxAmt) {
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(maxAmt));
    } else if (loanAmt < minAmt) {
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(minAmt));
    }*/
    if (loanAmt >= maxAmt) {
        document.getElementById("NEWLOA__AddLoanDetails__plus").style.pointerEvents = 'none';
        document.getElementById("NEWLOA__AddLoanDetails__plus").style.opacity = '0.5';
    } else {
        document.getElementById("NEWLOA__AddLoanDetails__plus").style.pointerEvents = 'auto';
        document.getElementById("NEWLOA__AddLoanDetails__plus").style.opacity = '1';
    }
    if (loanAmt <= minAmt) {
        document.getElementById("NEWLOA__AddLoanDetails__minus").style.pointerEvents = 'none';
        document.getElementById("NEWLOA__AddLoanDetails__minus").style.opacity = '0.5';
    } else {
        document.getElementById("NEWLOA__AddLoanDetails__minus").style.pointerEvents = 'auto';
        document.getElementById("NEWLOA__AddLoanDetails__minus").style.opacity = '1';
    }
    if (loanAmt % 1000 === 0) {
        if (loanAmt >= minAmt && loanAmt <= maxAmt) {
            apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(loanAmt));
        } else {
            apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(originalLoanAmount));
            document.getElementById("NEWLOA__AddLoanDetails__minus").style.pointerEvents = 'auto';
            document.getElementById("NEWLOA__AddLoanDetails__minus").style.opacity = '1';
            document.getElementById("NEWLOA__AddLoanDetails__plus").style.pointerEvents = 'auto';
            document.getElementById("NEWLOA__AddLoanDetails__plus").style.opacity = '1';
        }
    } else {
        apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(originalLoanAmount));
    }
    apz.app.AddLoanDetails.updateLoanAmount();
}
apz.app.AddLoanDetails.addSubtLoanAmount = function(pthis) {
    var id = pthis.id;
    // var loamAmt = selLoanProdObj.productDtls.amountDefault;
    // var originalLoanAmount = selLoanProdObj.productDtls.amountDefault
    let loanAmtInput = document.getElementById("NEWLOA__AddLoanDetails__loanAmount");
    let loanAmount = parseInt(loanAmtInput.value.replace(/[₹,]/g, ''));
    KendraApp.selectedAmt = parseInt(loanAmount);
    let originalLoanAmount = parseInt(defAmt, 10);
    // let maxAmt = parseInt(selLoanProdObj.productDtls.amountMax, 10);
    // let minAmt = parseInt(selLoanProdObj.productDtls.amountMin, 10);
    if (id === 'NEWLOA__AddLoanDetails__plus') {
        loanAmount += 1000
        if (loanAmount >= maxAmt) {
            loanAmount = maxAmt; // Ensure maximum amount is amountMax
            document.getElementById("NEWLOA__AddLoanDetails__plus").style.pointerEvents = 'none';
            document.getElementById("NEWLOA__AddLoanDetails__plus").style.opacity = '0.5';
        }
    } else if (id === 'NEWLOA__AddLoanDetails__minus') {
        loanAmount -= 1000
        if (loanAmount <= minAmt) {
            loanAmount = minAmt; // Ensure minimum amount is amountMin
            document.getElementById("NEWLOA__AddLoanDetails__minus").style.pointerEvents = 'none';
            document.getElementById("NEWLOA__AddLoanDetails__minus").style.opacity = '0.5';
        }
    }
    //loanAmtInput.value = loanAmount.toLocaleString();
    apz.setElmValue("NEWLOA__AddLoanDetails__loanAmount", ApzCOB.fn_FormatAmount(loanAmount));
    if (loanAmount < maxAmt) {
        document.getElementById("NEWLOA__AddLoanDetails__plus").style.pointerEvents = 'auto';
        document.getElementById("NEWLOA__AddLoanDetails__plus").style.opacity = '1';
    }
    if (loanAmount > minAmt) {
        document.getElementById("NEWLOA__AddLoanDetails__minus").style.pointerEvents = 'auto';
        document.getElementById("NEWLOA__AddLoanDetails__minus").style.opacity = '1';
    }
    apz.app.AddLoanDetails.updateLoanAmount();
    if (selLoanProdDesc === "Emergency Loan") {
        apz.app.AddLoanDetails.paintRepayFrequency();
    }
}
apz.app.AddLoanDetails.updateLoanAmount = function() {
    let repayFreq = KendraApp.selectedKendra.meetingFrequency;
    if (selLoanProdDesc === "Emergency Loan") {
        var lnAmtInputEL = document.getElementById("NEWLOA__AddLoanDetails__loanAmount");
        //var lnAmount = parseInt(lnAmtInput.value.replace(/,/g, ''), 10);
        lnAmountEL = parseInt(lnAmtInputEL.value.replace(/[₹,]/g, ''));
        if (repayFreq === 'WEEKLY' && lnAmountEL === 1000) {
            document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 28';
        } else if ((repayFreq === 'BIWEEKLY' || repayFreq === 'BI-WEEKLY') && lnAmountEL === 1000) {
            document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 33';
        } else if (repayFreq === 'WEEKLY' && lnAmountEL === 2000) {
            document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 91';
        } else if ((repayFreq === 'BI-WEEKLY' || repayFreq === 'BIWEEKLY') && lnAmountEL === 2000) {
            document.getElementById('NEWLOA__AddLoanDetails__loanProcessFee_txtcnt').innerText = '₹ 101';
        }
        
          if (defAmtArr.length > 1) {
            switch (defAmtArr.length) {
                case 5:
                    if (lnAmountEL <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[2]) {
                        term = parseInt(termArr[2].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[3]) {
                        term = parseInt(termArr[3].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[4]) {
                        term = parseInt(termArr[4].slice(0, -1));
                    }
                    break;
                case 4:
                    if (lnAmountEL <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[2]) {
                        term = parseInt(termArr[2].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[3]) {
                        term = parseInt(termArr[3].slice(0, -1));
                    }
                    break;
                case 3:
                    if (lnAmountEL <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[2]) {
                        term = parseInt(termArr[2].slice(0, -1));
                    }
                    break;
                case 2:
                    if (lnAmountEL <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmountEL <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    }
                    break;
            }
        }
         apz.setElmValue(screenId + "tenure", term + " Weeks");
        var UpFrontFeeCharge;
        var InterestRate;
        if (lnAmountEL === 1000 && repayFreq === 'WEEKLY') {
            UpFrontFeeCharge = UpfrontCharges[0].upfrontFee;
            InterestRate = UpfrontCharges[0].interest_Fee;
            apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
            apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
            let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
            apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(lnAmountEL));
        } else if (lnAmountEL === 1000 && (repayFreq === 'BI-WEEKLY' || repayFreq === 'BIWEEKLY')) {
            UpFrontFeeCharge = UpfrontCharges[1].upfrontFee;
            InterestRate = UpfrontCharges[1].interest_Fee;
            apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
            apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
            let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
            apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(lnAmountEL));
        } else if (lnAmountEL === 2000 && repayFreq === 'WEEKLY') {
            UpFrontFeeCharge = UpfrontCharges[2].upfrontFee;
            InterestRate = UpfrontCharges[2].interest_Fee;
            apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
            apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
            let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
            apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(lnAmountEL));
        } else if (lnAmountEL === 2000 && (repayFreq === 'BI-WEEKLY' || repayFreq === 'BIWEEKLY')) {
            UpFrontFeeCharge = UpfrontCharges[3].upfrontFee;
            InterestRate = UpfrontCharges[3].interest_Fee;
            apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + UpFrontFeeCharge);
            apz.setElmValue(screenId + "gstAmt", "₹ " + (UpFrontFeeCharge - InterestRate));
            let aprxLnAmt = lnAmountEL - (UpFrontFeeCharge + insurAmt);
            apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
            apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(lnAmountEL));
        }
        if (repayFreq === "WEEKLY") {
            addLoanDetailsObj.scrDataStep1.repayFrequency = {
                id: 0,
                idDesc: 'WEEKLY'
            };
            document.getElementById('NEWLOA__AddLoanDetails__gstAmt_txtcnt').innerText = '₹ 100';
        } else if (repayFreq === 'BIWEEKLY' || repayFreq === 'BI-WEEKLY') {
            addLoanDetailsObj.scrDataStep1.repayFrequency = {
                id: 1,
                idDesc: 'BI-WEEKLY'
            }
            document.getElementById('NEWLOA__AddLoanDetails__gstAmt_txtcnt').innerText = '₹ 200';
        }
        window.upfrontCharges = UpFrontFeeCharge;
        window.loanAmtEL = lnAmountEL;
      
    } else {
        let lnAmtInput = document.getElementById("NEWLOA__AddLoanDetails__loanAmount");
        //var lnAmount = parseInt(lnAmtInput.value.replace(/,/g, ''), 10);
        lnAmount = parseInt(lnAmtInput.value.replace(/[₹,]/g, ''));
        apz.app.AddLoanDetails.updatecheckBox(lnAmount)
        if (defAmtArr.length > 1) {
            switch (defAmtArr.length) {
                case 5:
                    if (lnAmount <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[2]) {
                        term = parseInt(termArr[2].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[3]) {
                        term = parseInt(termArr[3].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[4]) {
                        term = parseInt(termArr[4].slice(0, -1));
                    }
                    break;
                case 4:
                    if (lnAmount <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[2]) {
                        term = parseInt(termArr[2].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[3]) {
                        term = parseInt(termArr[3].slice(0, -1));
                    }
                    break;
                case 3:
                    if (lnAmount <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[2]) {
                        term = parseInt(termArr[2].slice(0, -1));
                    }
                    break;
                case 2:
                    if (lnAmount <= defAmtArr[0]) {
                        term = parseInt(termArr[0].slice(0, -1));
                    } else if (lnAmount <= defAmtArr[1]) {
                        term = parseInt(termArr[1].slice(0, -1));
                    }
                    break;
            }
        }
        let axLnAmt = lnAmount - (+ApzCOB.calGSTAmount(lnAmount, window.gstValue, window.feeCharge) + +ApzCOB.calProcessingFees(lnAmount, window
            .feeCharge) + insurAmt);
        // apz.setElmValue(screenId + "loanAmount", lnAmount);
        apz.setElmValue(screenId + "tenure", term + " Weeks");
        /*apz.setElmValue(screenId + "intRate", selLoanProdObj.productDtls.intRate + "%");*/
        /*apz.setElmValue(screenId + "loanProcessFee", "₹ " + ApzCOB.fn_FormatAmount(parseInt(ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls
            .intRate, lnAmount))));*/
        apz.setElmValue(screenId + "loanProcessFee", "₹ " + ApzCOB.calProcessingFees(lnAmount, window.feeCharge));
        /*apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(ApzCOB.calAmtInPercentage(selLoanProdObj.productDtls
            .insurancePercentage, lnAmount)));*/
        apz.setElmValue(screenId + "loanAmt", "₹ " + ApzCOB.fn_FormatAmount(lnAmount));
        apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(lnAmount, window.gstValue, window
            .feeCharge) + +ApzCOB.calProcessingFees(lnAmount, window.feeCharge) + insurAmt).toString()));
        apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(axLnAmt.toString()));
        apz.setElmValue(screenId + "gstAmt", "₹ " + ApzCOB.calGSTAmount(lnAmount, window.gstValue, window.feeCharge));
        /*apz.setElmValue(screenId + "approxWeeklyInstall", "₹ " + ApzCOB.fn_FormatAmount(ApzCOB.calApproxWeekInstallment(selLoanProdObj.productDtls
            .intRate, defAmt, (term / apz.app.AddLoanDetails.fetchFrequncyVal(apz.getElmValue(screenId + "repayFreq"))))));*/
        var loanAmt = parseInt(ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount")));
        insurArr = gApzCOB.insurDetails.filter(arr => (arr.Loan_Amount === loanAmt && (term + 'W') === arr.Tenure));
        if (selLoanProdObj.productDtls.memInsurance === "YES") {
            $("#NEWLOA__AddLoanDetails__ct_frm_82").removeClass("sno");
            $("#NEWLOA__AddLoanDetails__memCheckBox").prop("checked", true);
            if (isDraftApplication) {
                if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls.member === "Y") {
                    $("#NEWLOA__AddLoanDetails__memCheckBox").prop("checked", true);
                } else {
                    $("#NEWLOA__AddLoanDetails__memCheckBox").prop("checked", false);
                }
            }
            $("#NEWLOA__AddLoanDetails__memCheckBox").prop("disabled", false);
        }
        memCheckBox = $('#' + screenId + 'memCheckBox').is(":checked")
        spouseCheckBox = $('#' + screenId + 'spouseCheckBox').is(":checked")
        if (!memCheckBox && !spouseCheckBox) {
            insurArr = [];
        }
        if (insurArr.length > 0) {
            var spouseAmt = insurArr[0].Spouse_Insurance;
           var memAmt = insurArr[0].Borrower_Insurance;
            if (memCheckBox && spouseCheckBox) {
                insurAmt = insurArr[0].Spouse_Insurance + insurArr[0].Borrower_Insurance;
                apz.setElmValue(screenId + "memInsChargeLoan", ApzCOB.fn_FormatAmount(memAmt));
                apz.setElmValue(screenId + "spouseInsChargeLoan", ApzCOB.fn_FormatAmount(spouseAmt));
                 $("#" + screenId + 'spouseInsChargeDiv').removeClass('sno');
                  $("#" + screenId + 'memInsChargeDiv').removeClass('sno');
            } else if (memCheckBox) {
                insurAmt = insurArr[0].Borrower_Insurance;
                apz.setElmValue(screenId + "memInsChargeLoan", ApzCOB.fn_FormatAmount(memAmt));
                apz.setElmValue(screenId + "spouseInsChargeLoan",  "0");
                $("#" + screenId + 'spouseInsChargeDiv').addClass('sno');
                  $("#" + screenId + 'memInsChargeDiv').removeClass('sno');
            } else if (spouseCheckBox) {
                insurAmt = insurArr[0].Spouse_Insurance;
                 apz.setElmValue(screenId + "spouseInsChargeLoan", ApzCOB.fn_FormatAmount(spouseAmt));
                 apz.setElmValue(screenId + "memInsChargeLoan", "0");
                  $("#" + screenId + 'spouseInsChargeDiv').removeClass('sno');
                  $("#" + screenId + 'memInsChargeDiv').addClass('sno');
            } else {
                apz.setElmValue(screenId + "memInsChargeLoan", "0");
                apz.setElmValue(screenId + "spouseInsChargeLoan", "0");
                insurAmt = 0;
            }
            var prevAmt = totalAmt;
            totalAmt = insurArr[0].Spouse_Insurance + insurArr[0].Borrower_Insurance;
            if (prevAmt == 0 && totalAmt != 0) {
                insurAmt = insurArr[0].Borrower_Insurance;
            }
        } else {
            insurAmt = 0;
        }
        if (selLoanProdObj.productDtls.memInsurance == 'NO') {
            totalAmt = 0;
            insurAmt = 0;
        }
        if (isDraftApplication && KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls.member === "N") {
            totalAmt = 0;
            insurAmt = 0;
            $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', false);
            $('#NEWLOA__AddLoanDetails__spouseCheckBox').prop('checked', false);
            if ($("#NEWLOA__AddLoanDetails__memCheckBox").prop("checked")) {
              $("#" + screenId + "insuranceInfoDiv").removeClass("sno");
              $("#" + screenId + "insuranceCharDiv").addClass("sno");
              $("#" + screenId + 'memInsChargeDiv').removeClass('sno');
              $("#" + screenId + 'spouseInsChargeDiv').removeClass('sno');
            } else {
              $("#" + screenId + "insuranceInfoDiv").addClass("sno");
              $("#" + screenId + "insuranceCharDiv").addClass("sno");
            }
        }else{
            if (totalAmt > 0) {
                $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', true);
                $('#NEWLOA__AddLoanDetails__ct_frm_82').removeClass('sno');
                $('#NEWLOA__AddLoanDetails__memCheckBox').prop('disabled', false);
            } else {
                $('#NEWLOA__AddLoanDetails__memCheckBox').prop('checked', false);
                $('#NEWLOA__AddLoanDetails__spouseCheckBox').prop('checked', false);
                $('#NEWLOA__AddLoanDetails__ct_frm_82').addClass('sno');
            }
        }
        apz.setElmValue(screenId + "insurCharges", "₹ " + ApzCOB.fn_FormatAmount(insurAmt));
        let aprxLnAmt = loanAmt - (+ApzCOB.calGSTAmount(loanAmt, window.gstValue, window.feeCharge) + +ApzCOB.calProcessingFees(loanAmt, window
            .feeCharge) + insurAmt);
        apz.setElmValue(screenId + "approxLoanCharges", "(-) ₹ " + ApzCOB.fn_FormatAmount((+ApzCOB.calGSTAmount(loanAmt, window.gstValue, window
            .feeCharge) + +ApzCOB.calProcessingFees(loanAmt, window.feeCharge) + insurAmt).toString()));
        apz.setElmValue(screenId + "approxLoanAmt", "₹ " + ApzCOB.fn_FormatAmount(aprxLnAmt.toString()));
    }
}
apz.app.AddLoanDetails.mobConfirmModal = function() {
    //KendraLoans.custFetchLoanAppRes = undefined;
    otpDetails = {};
    var otptypeList = [];
    if (!apz.isNull(KendraApp.selectedKendra.officeData.consentType)) {
        otptypeList = KendraApp.selectedKendra.officeData.consentType.split(',')
    } else {
        otptypeList[0] = 'OTP'
    }
    window.userSkipedOTP=false;
    if (otptypeList[0] == 'Manual') {
        window.isloanOTP = false;
        otpDetails.isloanOTP = false;
        otpDetails.branchOTP = 'Manual';
        otpDetails.isloanproductOTP = selLoanProdObj.productDtls.consentType;
        otpDetails.OTPOptional = 'Manual';
        otpDetails.userSkipedCB = false;
        apz.app.AddLoanDetails.saveData();
        //KendraApp.currentLoanAppRequest.applicationdtls.addInfo.otpDetails = otpDetails;
        apz.startLoader();
        ApzCOB.saveLoan();
    } else {
        otpDetails.isloanOTP = true;
        otpDetails.branchOTP = otptypeList[0];
        otpDetails.isloanproductOTP = selLoanProdObj.productDtls.consentType;
        if (selLoanProdObj.productDtls.consentType == 'Both') {
            window.isSkipAvail = true;
            otpDetails.OTPOptional = 'Both';
            otpDetails.userSkipedCB = false;
            apz.setElmValue(screenId + "confirmMobileNum", '+91' + ' ' + selectedAppObj.mobileNum);
            ApzCOB.toggleModal(screenId + "mobConfirmModal");
        } else if (selLoanProdObj.productDtls.consentType == 'Manual') {
            window.isloanOTP = false;
            otpDetails.OTPOptional = 'Manual';
            otpDetails.userSkipedCB = false;
            apz.app.AddLoanDetails.saveData();
            //KendraApp.currentLoanAppRequest.applicationdtls.addInfo.otpDetails = otpDetails;
            apz.startLoader();
            ApzCOB.saveLoan();
        } else {
            window.isSkipAvail = false;
            otpDetails.OTPOptional = 'OTP';
            otpDetails.userSkipedCB = false;
            apz.setElmValue(screenId + "confirmMobileNum", '+91' + ' ' + selectedAppObj.mobileNum);
            ApzCOB.toggleModal(screenId + "mobConfirmModal");
        }
    }
}
apz.app.AddLoanDetails.CBcheck = function() {
    ApzCOB.toggleModal(screenId + "mobConfirmModal");
    var data = [];
    KendraApp.currentLoanAppRequest.applicationdtls.customerName = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.customerName;
    KendraApp.currentLoanAppRequest.applicationdtls.amount = ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount"));
    if (!apz.isNull(KendraApp.AppCreateResObj.applicationId)) {
        KendraApp.currentLoanAppRequest.applicationdtls.versionNo = KendraApp.AppCreateResObj.versionNo;
        KendraApp.currentLoanAppRequest.applicationdtls.applicationId = KendraApp.AppCreateResObj.applicationId;
    }
    if (IncomeApp?.status === 'APPROVED' || IncomeApp?.status === 'PENDINGBYRPC') {
        if (IncomeApp.payLoad.earnings.length != 0) {
            var earnings = [];
            if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings.length != 0) {
                earnings.push(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings[0])
            }
            // earnings = JSON.parse(JSON.stringify(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings));
            if (IncomeApp?.status == 'APPROVED') {
                IncomeApp?.payLoad?.earnings.forEach(function(o) {
                    if (!o.isExisting && IncomeApp.flow != 'fromDraft') {
                        var docName = 'VOTER-ID';
                        if (o.InputData.legaldocName == 'PAN' || o.InputData.legaldocName == 'PANCARD' || o.InputData.legaldocName ==
                            'Pan Card') {
                            docName = 'PAN-CARD'
                        } else if (o.InputData.legaldocName == 'VOTER' || o.InputData.legaldocName == 'VOTERID' || o.InputData
                            .legaldocName == 'VOTER-ID') {
                            docName = 'VOTER-ID';
                        } else {
                            docName = 'DRIVING-LICENCE';
                        }
                        var earnMemDetails = {
                            "customerId": KendraApp.selectedCustomer.customerId,
                            "name": o.InputData.name,
                            "dob": ApzCOB.formattedtoPlain(o.InputData.dob),
                            "memRelation": o.InputData.memRelation,
                            "legaldocId": o.InputData.legaldocId,
                            "legaldocName": docName,
                        };
                        earnings.push(earnMemDetails);
                    }
                });
            }
            KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings = earnings;
        }
        //KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings = KendraApp.selectedCustomer.earnings;
        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.income = KendraApp.selectedCustomer.income;
    }
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.kycDtls.mobileNum = KendraApp.selectedCustomer.mobileNum;
    KendraApp.selectedKendra.officeData.kmName = LoggedInUserDetails.loginResponse.userDet.name;
    KendraApp.selectedKendra.officeData.groupId = KendraApp.selectedCustomer.groupId;
    KendraApp.selectedKendra.officeData.caglAmt = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.caglAmt;
    if (!apz.isNull(IncomeApp?.applicationId)) {
        KendraApp.selectedKendra.officeData.incomeAppId = IncomeApp?.applicationId;
    }
    KendraApp.selectedKendra.officeData.isApprovedCRT=false;
    KendraApp.selectedKendra.officeData.isAmountUpdate=false;
    KendraApp.selectedKendra.officeData.FOIR='';
    KendraApp.selectedKendra.officeData.APR='';
    KendraApp.selectedKendra.officeData.isQuestionComplete='';
    KendraApp.selectedKendra.officeData.lnOutstandingAmt=lnOutstandingAmt;
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo = KendraApp.selectedKendra.officeData;
    var selectApproval=ApzCOB.fetchApprovallevel(KendraApp.currentLoanAppRequest.applicationdtls);
    var resultArr = [];
    if (selectApproval.RecommandRoleList && selectApproval.RecommandRoleList.length > 0) {
        for (var i = 0; i < selectApproval.RecommandRoleList.length; i++) {
            resultArr.push(selectApproval.RecommandRoleList[i].charAt(0));
        }
    }
    if (selectApproval.SanctionRoleList && selectApproval.SanctionRoleList.length > 0) {
        for (var j = 0; j < selectApproval.SanctionRoleList.length; j++) {
            resultArr.push(selectApproval.SanctionRoleList[j].charAt(0));
        }
    }
    var leader = 'B';
    if(resultArr.length !=0){
      leader=resultArr.join('');
    }
    KendraApp.currentLoanAppRequest.applicationdtls.leader=leader;
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo.reIncomeAssessment = reIncome ?? '';
    KendraApp.currentLoanAppRequest.applicationdtls.currentScreenId = 'CONFIRM';
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo.otpDetails = otpDetails;
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo.incomeStatus=IncomeApp?.status;
        data.push(KendraApp.currentLoanAppRequest.applicationdtls);
        var req = {
            "apiRequest": {
                "interfaceName": "SaveApplicationAndGenerateOTP",
                "appId": gAppId,
                "userId": LoggedInUserDetails.userID,
                "requestObj": {
                    "applicationdtls": data,
                    "actionType": "OTP_SEND",
                    "type": '',
                    "branchId": KendraApp.currentLoanAppRequest.applicationdtls.addInfo.branchId,
                    "mobileNo": KendraApp.selectedCustomer.mobileNum
                }
            }
        }
        apz.startLoader();
        req.apiRequest.workflowId = "SaveAppAndSendOTP";
        req.apiRequest.interfaceName = "SaveApplicationAndGenerateOTP";
        req.apiRequest.requestObj.userRole = currentUserRole;
        req.apiRequest.requestObj.appVersion = appVersion;
        req.apiRequest.requestObj.userName = LoggedInUserDetails.loginResponse.userDet.name;
        req.apiRequest.requestObj.userId = LoggedInUserDetails.userID;
        req.apiRequest.requestObj.remarks = 'The Loan CB check with OTP';
        window.KendraApp.Transpayload.req = req;
         if (!isConfirmCbCheck) {
             isConfirmCbCheck = true;
             ApzCOB.serverBuildParam(gAppId, "WorkFlowService", "N", "N", req, true, apz.app.AddLoanDetails.saveandCBCheckCB);
         }else{
           apz.stopLoader();
         }
};
var generateOtpResponse = '';
var otpResObj = '';
apz.app.AddLoanDetails.saveandCBCheckCB = function(params) {
    generateOtpResponse = params;
    try {
        if (ApzCOB.handleServiceCallBacks(params)) {
            if (!apz.isNull(params.res.APZCBO__WorkFlowService_Res.apiResponse.ResponseBody.responseObj)) {
                var otpRes = JSON.parse(params.res.APZCBO__WorkFlowService_Res.apiResponse.ResponseBody.responseObj);
                var appResponse = JSON.parse(otpRes.apiResponse.ResponseBody.responseObj).APZCBO__CreateLoanApplication;
                KendraApp.AppCreateResObj = JSON.parse(appResponse.apiResponse.ResponseBody.responseObj);
                KendraApp.currentLoanAppRequest.applicationdtls.applicationId = KendraApp.AppCreateResObj.applicationId;
                KendraApp.currentLoanAppRequest.applicationdtls.versionNo = KendraApp.AppCreateResObj.versionNo;
                //otpResObj = JSON.parse(otpRes.apiResponse.ResponseBody.responseObj);
                otpResObj = JSON.parse(otpRes.apiResponse.ResponseBody.responseObj).GenerateOTP;
                if (!apz.isNull(otpRes.apiResponse.ResponseBody.responseObj)) {
                    var generateRes = JSON.parse(otpRes.apiResponse.ResponseBody.responseObj).APZCBO__CreateLoanApplication.apiResponse
                        .ResponseBody.responseObj;
                    if (!apz.isNull(generateRes)) {
                        var appDetails = JSON.parse(generateRes);
                        if (!apz.isNull(appDetails.versionNo)) {
                            KendraApp.AppCreateResObj = appDetails;
                            KendraApp.currentLoanAppRequest.applicationdtls.versionNo = appDetails.versionNo;
                        }
                    }
                }
                window.KendraApp.Transpayload.otpResObj = otpResObj;
                window.KendraApp.Transpayload.Module = "LOAN";
                // apz.startLoader();
                var intf;
                if (IncomeApp.status === 'PENDINGBYRPC') {
                    intf = 'ValidateOTP'
                } else {
                    intf = "ValidateOTPAndCBCheck"
                }
                var req = {
                    "apiRequest": {
                        "interfaceName": intf,
                        "appId": gAppId,
                        "userId": LoggedInUserDetails.userID,
                        "requestObj": {
                            "applicationId": KendraApp.currentLoanAppRequest.applicationdtls.applicationId,
                            "versionNo": KendraApp.currentLoanAppRequest.applicationdtls.versionNo,
                            "schedulerEnabled": 'N',
                            "otp": '',
                            "RefNo": '',
                        }
                    }
                }
                req.apiRequest.workflowId = "ValidateOTP";
                req.apiRequest.interfaceName = intf;
                KendraApp.WorkflowRequest = req;
                var launchDiv = 'NEWLOA__AddLoanDetails__stage2';
                ApzCOB.LaunchAuthentication(launchDiv, '', "NEWLOA__AddLoanDetails__AuthenticateBaseDiv",
                    "apz.app.AddLoanDetails.cancelAuthentication", "apz.app.AddLoanDetails.validateCBCheckWorkflowCB", req, 'OTP',
                    "apz.app.AddLoanDetails.Failure");
                //apz.app.BaseScreens.loadOTP();
                // $('#APZCBO__BaseScreens__otpMob').text(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.kycDtls.mobileNum)
                //ApzCOB.toggleModal("APZCBO__BaseScreens__otpAuthModal");
            } else {
                apz.stopLoader();
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
            }
        } else {
            apz.stopLoader();
            ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
        }
    } catch (e) {
        apz.stopLoader();
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
    }
    apz.stopLoader();
    // apz.app.AddLoanDetails.CBcheckold();
    console.log("otpparams", params);
    isConfirmCbCheck = false;
}
apz.app.AddLoanDetails.validateOtp = function() {
    var req = {
        "apiRequest": {
            "interfaceName": "ValidateOTPAndCBCheck",
            "appId": gAppId,
            "userId": LoggedInUserDetails.userID,
            "requestObj": {
                "applicationId": KendraApp.currentLoanAppRequest.applicationdtls.applicationId,
                "versionNo": KendraApp.currentLoanAppRequest.applicationdtls.versionNo,
                "otp": otpResObj.otp,
                "RefNo": otpResObj.RefNo
            }
        }
    }
    apz.startLoader();
    req.apiRequest.workflowId = "ValidateOTP";
    req.apiRequest.interfaceName = "ValidateOTPAndCBCheck";
    KendraApp.WorkflowRequest = req;
    ApzCOB.serverBuildParam(gAppId, "WorkFlowService", "N", "N", req, true, apz.app.AddLoanDetails.validateOtpCB);
};
var cbcheckResponse = '';
apz.app.AddLoanDetails.validateOtpCB = function(params) {
    cbcheckResponse = params;
    // ApzCOB.toggleModal("APZCBO__BaseScreens__otpAuthModal");
    //ApzRMB.toggleModal("APZCBO__BaseScreens__otpAuthModal");
    apz.stopLoader();
    ApzCOB.toggleModal("APZCBO__BaseScreens__otpAuthModal");
    apz.app.AddLoanDetails.CBcheckold();
}
var cbResponse = '';
apz.app.AddLoanDetails.validateCBCheckWorkflowCB = function(params) {
    upgrFlag = false;
    cbcheckResponse = params;
    apz.stopLoader();
    if (ApzCOB.handleServiceCallBacks(params)) {
     try {
        if (IncomeApp.status === 'PENDINGBYRPC') {
            apz.app.AddLoanDetails.PendingByRpc(params);
        } else {
            if (!apz.isNull(params.res.APZCBO__WorkFlowService_Res.APZCBO__loanCBCheck.apiResponse.ResponseBody.responseObj)) {
                cbResponse = JSON.parse(params.res.APZCBO__WorkFlowService_Res.APZCBO__loanCBCheck.apiResponse.ResponseBody.responseObj)
                var approvedAmt = 0;
                if (!apz.isNull(cbResponse.Approved_Loan_Amount)) {
                    approvedAmt = cbResponse.Approved_Loan_Amount;
                }
                eligibleAmt = approvedAmt;
                if (cbResponse.IRIS_message == 'success' || cbResponse.IRIS_message == 'SUCCESS' ||cbResponse.IRIS_message == 'bureau_data_issue_spouse_node_corrected_success') {
                    if (cbResponse.Final_Decision === 'Approved' || cbResponse.Final_Decision === 'Approved with Pre-closure') {
                        apz.stopLoader();
                        $("#NEWLOA__AddLoanDetails__el_icn_43").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_icn_45").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_btn_32").addClass("sno");
                        if (parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount) > approvedAmt) {
                            backReject = true;
                            $('#NEWLOA__AddLoanDetails__ct_nav_23').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_21').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
                            $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__rejectAppBtnRow').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__proceedAppBtn').text("Proceed with ₹" + approvedAmt);
                            $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
                            apz.app.AddLoanDetails.CBcheckold();
                            apz.app.AddLoanDetails.paintpreLoanDetails();
                        } else if (approvedAmt > parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount)) {
                            let appliedAmt = parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount);
                            backReject = false;
                            $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_22').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_21').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', true);
                            $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__proceedAppBtnRow').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__appliedAppBtn').text("Proceed with ₹" + appliedAmt);
                            $('#NEWLOA__AddLoanDetails__upgradeAppBtn').text("Upgrade & Apply with ₹" + approvedAmt);
                            $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
                            apz.app.AddLoanDetails.CBcheckold();
                            apz.app.AddLoanDetails.paintpreLoanDetails();
                        } else {
                            //$("#NEWLOA__AddLoanDetails__el_icn_43").addClass("sno");
                            //$("#NEWLOA__AddLoanDetails__el_icn_45").addClass("sno");
                           // $("#NEWLOA__AddLoanDetails__el_btn_32").addClass("sno");
                            backReject = false;
                            $('#NEWLOA__AddLoanDetails__ct_nav_12').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_21').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__rejectAppBtnRow').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__proceedAppBtnRow').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
                            $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
                            apz.app.AddLoanDetails.CBcheckold();
                            window.isCBsuccess=true;
                            apz.app.AddLoanDetails.paintpreLoanDetails();
                        }
                    } else {
                        backReject = false;
                        $("#NEWLOA__AddLoanDetails__el_icn_43").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_icn_45").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_btn_32").addClass("sno");
                        var cbRate = '';
                        if (!apz.isNull(cbResponse.Rejection_reason)) {
                            cbRate = "Loan rejection reason - " + cbResponse.Rejection_reason;
                            $('#NEWLOA__AddLoanDetails__failedmsg_txtcnt').text(cbRate);
                            $('#NEWLOA__AddLoanDetails__failedmsg').removeClass('sno');
                        } else {
                            $('#NEWLOA__AddLoanDetails__failedmsg').addClass('sno');
                        }
                        $('#NEWLOA__AddLoanDetails__failedHeader_txtcnt').text('CB Loan Rejected');
                        $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__ct_nav_21').removeClass('sno');
                        $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', 'disabled')
                        apz.app.AddLoanDetails.CBcheckold();
                        apz.app.AddLoanDetails.paintpreLoanDetails();
                        selectedAppObj.loanDtls.forEach(function(loan, i) {
                            $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                        });
                        $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__el_btn_72_ul').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__el_btn_72').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__rejectAppBtnRow').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__proceedAppBtnRow').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__sc_row_866').removeClass('sno');
                    }
                    apz.setElmValue(screenId + "sucElAmt", ApzCOB.fn_FormatAmount(approvedAmt));
                    $('#NEWLOA__AddLoanDetails__sc_col_757').addClass('sno');
                } else {
                    $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__ct_nav_21').removeClass('sno');
                    $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__failedmsg').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', 'disabled');
                    $('#NEWLOA__AddLoanDetails__el_txt_468').addClass('sno');
                    selectedAppObj.loanDtls.forEach(function(loan, i) {
                        $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                    });
                    apz.app.AddLoanDetails.CBcheckold();
                    apz.app.AddLoanDetails.paintpreLoanDetails();
                    $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__el_btn_72_ul').removeClass('sno');
                    $('#NEWLOA__AddLoanDetails__el_btn_72').removeClass('sno');
                    apz.setElmValue(screenId + "sucElAmt", ApzCOB.fn_FormatAmount(approvedAmt));
                    $('#NEWLOA__AddLoanDetails__sc_col_757').addClass('sno');
                }
                   if (window.loanProduct === "Emergency Loan") {
                     if ((cbResponse.IRIS_message === 'success' || cbResponse.IRIS_message === 'SUCCESS' ||cbResponse.IRIS_message == 'bureau_data_issue_spouse_node_corrected_success') && (cbResponse.Final_Decision ===
                             'Approved' || cbResponse.Final_Decision === 'Approved with Pre-closure')) {
                         console.log("CB Passed")
                     } else {
                         apz.app.AddLoanDetails.reject();
                     }
                 }

                if (KendraApp.selectedCustomer.custStatus != 'NQA') {
                    if (cbResponse.Rejection_reason === 'Reject - Eligible for NQA, Do Re-income assessment') {
                        ApzCOB.fnDisplayMsg("Customer is eligible for Grameen Vishesh loan. Do you want to do Re-Income Assessment?", "C", apz.app
                            .AddLoanDetails.reIncomeAssCB);
                        $("#NEWLOA__AddLoanDetails__AuthenticateBaseDiv").remove();
                        $('#scr__NEWLOA__AddLoanDetails__main').append(`
                        <div id="NEWLOA__AddLoanDetails__AuthenticateBaseDiv" class="grb sno">
                        <div id="NEWLOA__AddLoanDetails__gr_col_117" class="gcb-col12" style="">
                        <div id="NEWLOA__AddLoanDetails__pl_pnl_112_div" style="" class="plt-simp">
                        <div id="NEWLOA__AddLoanDetails__ps_pls_120" class="pst-simp pri" style="">
                        <p>Placeholder Content for ps_pls_120</p>
                        </div>
                        </div>
                        </div>
                        </div>
        `);
                    } else {
                        window.reIncomeAssessment = false;
                    }
                } else {
                    window.reIncomeAssessment = false;
                }
            } else {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
            }
        }
     } catch (e) {
	   ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
	 }
    } else {
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
    }
    apz.stopLoader();
    // apz.app.AddLoanDetails.CBcheckold();
    //apz.app.AddLoanDetails.paintpreLoanDetails();
    $('#header').addClass('sno')
}
apz.app.AddLoanDetails.reIncomeAssCB = function(params) {
    if (params.choice === true) {
        window.reIncomeAssessment = true;
        reIncome = true;
        apz.app.AddLoanDetails.addIncomeDetails(this);
    } else if (params.choice === false) {
        apz.app.AddLoanDetails.reject();
    }
}
apz.app.AddLoanDetails.reject = function(param) {
    var remarks
    if(param?.choice === true){
        remarks = 'The Loan Rejected by '+LoggedInUserDetails.userID +' ('+currentUserRole +') ~ due to back navigation.';
    }else{
        if(param?.choice === false){
            return
        }else{
            remarks= 'The Loan Rejected by '+LoggedInUserDetails.userID +' ('+currentUserRole +') ~ post CB screen.'; 
        }
    }
    window.CRTworkflow = {
        "currentRole": "KM",
        "action": "REJECT",
        "workflowId": "LOANINPUT",
        "stage": "USERCHECK",
        "remarks": remarks
    }
    window.reject = true;
    KendraApp.crtObj.applicationId = KendraApp.currentLoanAppRequest.applicationdtls.applicationId;
    KendraApp.crtObj.versionNo = KendraApp.currentLoanAppRequest.applicationdtls.versionNo;
    window.cbApproveManual = 'N';
    window.crtRejectKM = true;
    ApzCOB.kmActionPostCBCheck();
}
apz.app.AddLoanDetails.onCRTReject = function() {
    if (window.loanProduct === 'Emergency Loan') {
        window.reject = false;
        window.crtRejectKM = false;
        $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
        $('#NEWLOA__AddLoanDetails__el_btn_72').removeClass('sno');
        $('#NEWLOA__AddLoanDetails__el_btn_72_ul').removeClass('sno');
    } else {
        window.reject = false;
        window.crtRejectKM = false;
        ApzCOB.fnDisplayMsg('Application rejected', 'E', apz.app.AddLoanDetails.onCRTRejectCB);
    }
}
apz.app.AddLoanDetails.onCRTRejectCB = function(params) {
    window.approve = true;
    if (params.choice === true) {
        window.newLoan = true;
        ApzCOB.launchMicroApp('Dashbo', 'dashboard', gAppId + '__BaseScreens__BaseDIV', '');
        //ApzCOB.dashboardAppListAPI();
    } else if (params.choice === false) {
        //
    }
}
apz.app.AddLoanDetails.PendingByRpc = function(params) {
    if (!apz.isNull(params.res.APZCBO__WorkFlowService_Res.apiResponse.ResponseBody.responseObj)) {
        cbResponse = JSON.parse(params.res.APZCBO__WorkFlowService_Res.apiResponse.ResponseBody.responseObj)
        if (cbResponse.Status === 'success') {
            apz.app.AddLoanDetails.appSubmit();
        }
    } else {
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
    }
}
apz.app.AddLoanDetails.Failure = function(params) {
    apz.stopLoader();
}
apz.app.AddLoanDetails.cancelAuthentication = function(params) {
    apz.stopLoader();
}
apz.app.AddLoanDetails.closeApp = function() {
    window.KendraApp.KendraResponse = JSON.parse(JSON.stringify(window.KendraApp.KendraResponsenew))
    // if (userRoleIfDeoAvailable.includes("DEO") && apz.deviceType === "WEB") {
    //     ApzCOB.fetchKendraDetailsDeoRole(window.LoggedInUserDetails.userID, window.ChangeRole);
    // } else {
        window.newLoan = true;
        ApzCOB.launchMicroApp('Dashbo', 'dashboard', gAppId + '__BaseScreens__BaseDIV', '');
        //ApzCOB.dashboardAppListAPI();
    //}
    // ApzCOB.launchMicroApp('Dashbo', 'dashboard', gAppId + '__BaseScreens__BaseDIV', '');
}
/**Update Income for Particular Application */
apz.app.AddLoanDetails.addIncomeDetails = function(pthis) {
    var productType;
    KendraApp.ProductResponse.forEach(function(k, i) {
        if (KendraApp.ProductResponse[i].productDtls.description === KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls
            .description) {
            productType = KendraApp.ProductResponse[i].productDtls.productType
        }
    })
    if (productType != 'IGL') {
        window.isUpdateIncome = true;
        window.houseHoldDetails = '';
        ApzCOB.fetchIncomeDetails()
    } else {
        apz.app.AddLoanDetails.IncomeDetailsUpdate()
    }
}
apz.app.AddLoanDetails.IncomeDetailsUpdate = function(params) {
    // var incomeData = params
    if (!KendraApp.selectedCustomer.isEarning) {
        KendraApp.selectedCustomer.earnings = [];
    }
    $('#APZCBO__BaseScreens__STAGE1').addClass('sno');
    IncomeApp.flow = 'fromApp'
    ApzCOB.launchMicroApp('Income', 'IncomeAssessment', 'APZCBO__BaseScreens__BaseDIV', '');
    // $('#' + screenId + 'ps_pls_79').addClass('sno');
    // $('#' + screenId + 'gr_col_68').addClass('sno');
    // $('#' + screenId + 'selfDeclareIncRow').removeClass('sno');
    // $('#' + screenId + 'el_txt_528').addClass('sno');
    // $('#' + screenId + 'addedDetailsRow_row').addClass('sno');
    // //KendraApp.selectedCustomer.vintageYear = 'Vintage ' + Math.round(KendraApp.selectedCustomer.vintage / 365) + ' Years';
    // KendraApp.selectedCustomer.vintageYear = 'Vintage ' + KendraApp.selectedCustomer.custVintage + ' Years';
    // apz.setElmValue(screenId + "updCustName", KendraApp.selectedCustomer.customerName);
    // apz.setElmValue(screenId + "updCustGroupID", KendraApp.selectedCustomer.groupId);
    // apz.setElmValue(screenId + "updCustID", KendraApp.selectedCustomer.customerId);
    // apz.setElmValue(screenId + "updVintage", KendraApp.selectedCustomer.vintageYear);
    // apz.setElmValue(screenId + "updCustPhone", KendraApp.selectedCustomer.mobileNum);
    // apz.setElmValue(screenId + "updMaritalStatus", KendraApp.selectedCustomer.maritalStatus);
    // apz.setElmValue(screenId + "updKyc", "N/A");
    // apz.setElmValue(screenId + "updDrivLicense", "N/A");
    // apz.data.scrdata.NEWLOA__IPaintIncDtls_Res = {};
    // apz.data.scrdata.NEWLOA__IPaintIncDtls_Res = incomeDtlsField;
    // apz.data.loadData("IPaintIncDtls", 'NEWLOA');
    // apz.app.AddLoanDetails.toggleAddDetailsVisibility();
}
apz.app.AddLoanDetails.toggleAddDetailsVisibility = function() {
    window.listItems = $('#' + screenId + 'ct_lst_25').find('li'); // Get all list items
    listItems.each(function() { // Loop through each list item
        var listItem = $(this);
        var checkbox = listItem.find('input[type="checkbox"]');
        var addButton = listItem.find('button[type="button"]');
        var anyCheckboxChecked = listItem.find('input[type="checkbox"]:checked').length >
        0; // Check if any checkbox within the list item is checked
        if (anyCheckboxChecked) { // Toggle the visibility of the "ADD DETAILS" button based on checkbox state
            addButton.show(); // Show the button if any checkbox is checked
        } else {
            addButton.hide(); // Hide the button if no checkbox is checked
        }
    });
};
// Function to handle checkbox click
apz.app.AddLoanDetails.onCLickCheckBoxList = function(checkbox) {
    window.listItem = $(checkbox).closest('li'); // Find the parent list item
    apz.app.AddLoanDetails.toggleAddDetailsVisibility(); // Toggle visibility of "ADD DETAILS" button
}
apz.app.AddLoanDetails.onAddDetailsClick = function(pthis) {
    var selectedLabel = "";
    for (var i = 0; i < listItem.length; i++) { // Loop through listItem to find the selected label
        var text = listItem[i].innerText.trim(); // Remove leading and trailing whitespace
        text = text.replace(/\n\t\n.*/, "");
        if (text !== "") {
            selectedLabel = text;
            break; // Exit the loop once the selected label is found
        }
    }
    $('#NEWLOA__AddLoanDetails__addDetailsOne_grp_lbl').text(selectedLabel); // Update the form label text with the selected label
    $('#' + screenId + 'selfDeclareIncRow').addClass('sno'); // Hide selfDeclareIncRow and show sourcesIncomeDtlsRow
    $('#' + screenId + 'sourcesIncomeDtlsRow').removeClass('sno');
}
apz.app.AddLoanDetails.addDetailsIncomeField = function() { // Get form input values
    let addDetailsOne = $('#' + screenId + 'addDetailsOne').val();
    let addDetailsTwo = $('#' + screenId + 'addDetailsTwo').val();
    let addDetailsThree = $('#' + screenId + 'addDetailsThree').val();
    // Perform form validation
    // if (!addDetailsOne || !addDetailsTwo || !addDetailsThree) {
    //     // Handle validation failure, display error message or prevent form submission
    //     alert("Please fill in all fields.");
    //     return;
    // }
    // Construct object with form data
    let formData = {
        addDetailsOne: addDetailsOne,
        addDetailsTwo: addDetailsTwo,
        addDetailsThree: addDetailsThree
    };
    apz.app.AddLoanDetails.updateListWithData(formData); // Update list with form data
};
apz.app.AddLoanDetails.updateListWithData = function(formData) { // Function to update list with form data
    $('#' + screenId + 'addedDetailsRow_row').addClass('sno'); // Hide all addedDetailsRow_row except the selected one
    listItem.find('#' + screenId + 'addedDetailsRow_row').removeClass('sno'); // Get the selected list item index
    let listItemIndex = listItem.attr('rowno'); // Update text content with formData
    let businessTypeText = $('#' + screenId + 'el_txt_635_' + listItemIndex + '_txtcnt');
    let tenureText = $('#' + screenId + 'el_txt_637_' + listItemIndex + '_txtcnt');
    let incomeText = $('#' + screenId + 'el_txt_639_' + listItemIndex + '_txtcnt');
    businessTypeText.text(formData.addDetailsOne || '');
    tenureText.text(formData.addDetailsTwo || '');
    incomeText.text(formData.addDetailsThree || ''); // Hide form screen and show previous screen
    $('#' + screenId + 'el_btn_62_' + listItemIndex).addClass('sno'); // Hide Add Details button
    $('#' + screenId + 'editRow_row').eq(listItemIndex).removeClass('sno');
    $('#' + screenId + 'sourcesIncomeDtlsRow').addClass('sno');
    $('#' + screenId + 'selfDeclareIncRow').removeClass('sno');
};
apz.app.AddLoanDetails.backNavigateIncomeDtls = function(pthis) {
    if ($('#' + screenId + 'el_txt_633:contains("Business Income Details")').is(':visible')) {
        $('#' + screenId + 'sourcesIncomeDtlsRow').addClass('sno');
        $('#' + screenId + 'selfDeclareIncRow').removeClass('sno');
    } else {
        $('#' + screenId + 'selfDeclareIncRow').addClass('sno');
        $('#' + screenId + 'ps_pls_79').removeClass('sno');
        $('#' + screenId + 'gr_col_68').removeClass('sno');
    }
}
apz.app.AddLoanDetails.updateDetailsField = function(pthis) {
    if (KendraApp.selectedCustomer.income && KendraApp.selectedCustomer.income.length > 0) {
        $('#' + screenId + 'ps_pls_79').addClass('sno');
        $('#' + screenId + 'gr_col_68').addClass('sno');
        $('#' + screenId + 'selfDeclareIncRow').removeClass('sno');
        $('#' + screenId + 'el_txt_528').addClass('sno');
        $('#' + screenId + 'addedDetailsRow_row').addClass('sno');
        //KendraApp.selectedCustomer.vintageYear = 'Vintage ' + Math.round(KendraApp.selectedCustomer.vintage / 365) + ' Years';
        KendraApp.selectedCustomer.vintageYear = 'Vintage ' + KendraApp.selectedCustomer.custVintage + ' Years';
        apz.setElmValue(screenId + "updCustName", KendraApp.selectedCustomer.customerName);
        apz.setElmValue(screenId + "updCustGroupID", KendraApp.selectedCustomer.groupId);
        apz.setElmValue(screenId + "updCustID", KendraApp.selectedCustomer.customerId);
        apz.setElmValue(screenId + "updVintage", KendraApp.selectedCustomer.vintageYear);
        apz.setElmValue(screenId + "updCustPhone", KendraApp.selectedCustomer.mobileNum);
        apz.setElmValue(screenId + "updMaritalStatus", KendraApp.selectedCustomer.maritalStatus);
        apz.setElmValue(screenId + "updKyc", "N/A");
        apz.setElmValue(screenId + "updDrivLicense", "N/A");
        apz.app.AddLoanDetails.updateListWithData();
    }
}
apz.app.AddLoanDetails.paintpreLoanDetails = function() {
    let tempArray = [];
    if (selectedAppObj.loanDtls.length > 0) {
        $('#' + screenId + 'preCloseDiv').removeClass('sno');
        selectedAppObj.loanDtls.forEach(loan => {
            KendraApp.ProductList.forEach(prod => {
                //console.log(prod.productDtls.productId,loan.product) 
                if (loan.product == prod.productDtls.productId) {
                    loan.productType = prod.productDtls.productType;
                    loan.shortDesc = prod.productDtls.shortDesc;
                    loan.productId = prod.productDtls.productId;
                }
            });
            var wks = ApzCOB.findMaturityWeek(loan.lnMatDate);
            var maturityDate = ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(loan.lnMatDate), "dd/mm/yy");
            let rawAmount = loan.outstandingPrincipal;
            //let unformattedAmount = ApzCOB.fn_unFormatAmount(rawAmount);
            let parsedAmount = Math.round(parseFloat(rawAmount));
            let dueAmount = "₹ " + parsedAmount;
            var loanAmt=loan.approvedAmt;
            if (apz.isNull(loan.approvedAmt)) {
                loanAmt=loan.amount;
            }
            let tempObj = {
                "loanType": loan.shortDesc,
                "maturityDate": ApzCOB.confDateFormatter(ApzCOB.dateStringToDate(loan.lnMatDate), "dd/mm/yy"),
                "maturityWks": wks + ' Wks ' + '(' + maturityDate + ')',
                //"loanId": loan.loanId,
                "dueAmount": dueAmount,
                "loanAmount": "₹ " +loanAmt
            }
            tempArray.push(tempObj);
            //KendraApp.activeLoanDtls.push(loan);
        });
        apz.data.scrdata.NEWLOA__PreCloseLoanDetails_Res = {};
        apz.data.scrdata.NEWLOA__PreCloseLoanDetails_Res.ViewActiveLoanDetailsNode = tempArray;
        apz.data.loadData("PreCloseLoanDetails", 'NEWLOA');
        totPreCloAmt = 0;
        if (KendraApp.currentLoanAppRequest.applicationdtls.addInfo.reIncomeAssessment) {
            selectedAppObj.loanDtls.forEach(function(loan, i) {
                $('#' + screenId + 'el_cbx_6_' + i).prop('checked', false);
                $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', false);
                $('#' + screenId + 'el_txt_474_' + i).addClass('sno');
                $('#' + screenId + 'el_txt_640_' + i).removeClass('sno');
            })
        }
        selectedAppObj.loanDtls.forEach(function(loan, i) {
            //if (KendraApp.selectedCustomer.custStatus != 'NQA') {
                //if (cbResponse.NQA_Flag === 'Yes' && cbResponse.Final_Decision === 'REJECT' && cbResponse.Rejection_reason === "Reject - Non-NQA Products, Re-apply with NQA eligible product") {
                if (KendraApp.selectedCustomer.addLoanDetailsObj.selEligibleLoanDtls.productId === 'GL.IGL.VISH.LN') {
                    if (["GL.IGL.PRAGATI", "GL.IGL.PRAGATI.PLUS", "GL.IGL.PRAGATI.RESTR","GL.IGL.PRAGATI.PLUS.2", "GL.IGL.VISH.LN"].includes(loan.productId)) {
                        $('#' + screenId + 'el_cbx_6_' + i).prop('checked', true);
                        $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].isCompulsory = true;
                        $('#' + screenId + 'el_txt_474_' + i).removeClass('sno');
                        $('#' + screenId + 'el_txt_640_' + i).addClass('sno');
                        totPreCloAmt = totPreCloAmt + Math.round(parseFloat(loan.outstandingPrincipal)) + Math.round(parseFloat(loan
                            .overdueInterest)) + Math.round(parseFloat(loan.overduePrincipal))
                    }
                } else if (KendraApp.selectedCustomer.addLoanDetailsObj.selEligibleLoanDtls.productId === 'GL.GRM.VISH.SUPPL') {
                    if (["GL.PRAGATI.SUPLMNTRY", "GL.PRAGATI.SUPL.PLUS", "GL.GRM.VISH.SUPPL"].includes(loan.productId)) {
                        $('#' + screenId + 'el_cbx_6_' + i).prop('checked', true);
                        $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].isCompulsory = true;
                        $('#' + screenId + 'el_txt_474_' + i).removeClass('sno');
                        $('#' + screenId + 'el_txt_640_' + i).addClass('sno');
                        totPreCloAmt = totPreCloAmt + Math.round(parseFloat(loan.outstandingPrincipal)) + Math.round(parseFloat(loan
                            .overdueInterest)) + Math.round(parseFloat(loan.overduePrincipal))
                    }
                } else {
                    var selectedProduct = KendraApp.ProductList.find(product => product.productDtls.productId === KendraApp.selectedCustomer.addLoanDetailsObj.selEligibleLoanDtls.productId);
                    var baseDescription = selectedProduct.productDtls.description;
                    var filteredProducts = KendraApp.ProductList.filter(product => {
                        // Log each product before filtering
                        return product.productDtls.description === baseDescription || product.productDtls.description === `${baseDescription}-M (MMFL)` || product.productDtls.description === `${baseDescription}- M (MMFL)`;
                    });
                    console.log("Checking Product:", filteredProducts);
                    if (filteredProducts.length != 0) {
                        filteredProducts.forEach(function(selectedProductList, j) {
                            if (loan.productId == filteredProducts[j].productDtls.productId) {
                                $('#' + screenId + 'el_cbx_6_' + i).prop('checked', true);
                                $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                                KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].isCompulsory = true;
                                $('#' + screenId + 'el_txt_474_' + i).removeClass('sno');
                                $('#' + screenId + 'el_txt_640_' + i).addClass('sno');
                                totPreCloAmt = totPreCloAmt + Math.round(parseFloat(loan.outstandingPrincipal)) + Math.round(parseFloat(loan.overdueInterest)) +
                                    Math.round(parseFloat(loan.overduePrincipal))
                            }
                        })
                    }
                    
                    /*if (loan.productId == KendraApp.selectedCustomer.addLoanDetailsObj.selEligibleLoanDtls.productId) {
                        $('#' + screenId + 'el_cbx_6_' + i).prop('checked', true);
                        $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].isCompulsory = true;
                        $('#' + screenId + 'el_txt_474_' + i).removeClass('sno');
                        $('#' + screenId + 'el_txt_640_' + i).addClass('sno');
                        totPreCloAmt = totPreCloAmt + Math.round(parseFloat(loan.outstandingPrincipal)) + Math.round(parseFloat(loan
                            .overdueInterest)) + Math.round(parseFloat(loan.overduePrincipal))
                    }*/
                }
            // } else {
            //     if (loan.productId == KendraApp.selectedCustomer.addLoanDetailsObj.selEligibleLoanDtls.productId) {
            //         $('#' + screenId + 'el_cbx_6_' + i).prop('checked', true);
            //         $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
            //         KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].isCompulsory = true;
            //         $('#' + screenId + 'el_txt_474_' + i).removeClass('sno');
            //         $('#' + screenId + 'el_txt_640_' + i).addClass('sno');
            //         totPreCloAmt = totPreCloAmt + Math.round(parseFloat(loan.outstandingPrincipal)) + Math.round(parseFloat(loan
            //             .overdueInterest)) + Math.round(parseFloat(loan.overduePrincipal))
            //     }
            // }
        });
        /*KendraApp.activeLoanDtls.forEach(function(el, i) {
            totPreCloAmt = totPreCloAmt + parseInt(el.overdueInterest) + parseInt(el.overduePrincipal)
        });*/
        if (KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.loanAmt < totPreCloAmt) {
            $('#NEWLOA__AddLoanDetails__preclosureAmtCheck').removeClass('sno');
            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', true);
        } else {
            $('#NEWLOA__AddLoanDetails__preclosureAmtCheck').addClass('sno');
            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
        }
    } else {
        $('#' + screenId + 'preCloseDiv').addClass('sno');
    }
    if (window.loanProduct === 'Emergency Loan') {
        $('#' + screenId + 'preCloseDiv').addClass('sno');
    } else {
        if (selectedAppObj.loanDtls.length > 0) {
            $('#' + screenId + 'preCloseDiv').removeClass('sno');
        }else{
            $('#' + screenId + 'preCloseDiv').removeClass('sno');
            $('#' + screenId + 'gr_row_83').addClass('sno');
            $('#' + screenId + 'noRecordDiv').removeClass('sno');
        }
    }
    if (window.isCBsuccess) {
        apz.app.AddLoanDetails.proceedLoan();
        setTimeout(function() {
            apz.app.AddLoanDetails.askQuestionnaire();
        }, 300);
    }
}
apz.app.AddLoanDetails.onclickPreClosureLoan = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    if ($('#' + screenId + 'el_cbx_6_' + rowNo).prop('checked') === true) {
        totPreCloAmt = totPreCloAmt + Math.round(parseFloat(selectedAppObj.loanDtls[rowNo].outstandingPrincipal)) + Math.round(parseFloat(
            selectedAppObj.loanDtls[rowNo].overdueInterest)) + Math.round(parseFloat(selectedAppObj.loanDtls[rowNo].overduePrincipal))
        if (KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.loanAmt < totPreCloAmt) {
            $('#NEWLOA__AddLoanDetails__preclosureAmtCheck').removeClass('sno');
            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', true);
        } else {
            $('#NEWLOA__AddLoanDetails__preclosureAmtCheck').addClass('sno');
            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
        }
    } else {
        totPreCloAmt = totPreCloAmt - Math.round(parseFloat(selectedAppObj.loanDtls[rowNo].outstandingPrincipal)) - Math.round(parseFloat(
            selectedAppObj.loanDtls[rowNo].overdueInterest)) - Math.round(parseFloat(selectedAppObj.loanDtls[rowNo].overduePrincipal))
        if (KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.loanAmt < totPreCloAmt) {
            $('#NEWLOA__AddLoanDetails__preclosureAmtCheck').removeClass('sno');
            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', true);
        } else {
            $('#NEWLOA__AddLoanDetails__preclosureAmtCheck').addClass('sno');
            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
        }
    }
};
apz.app.AddLoanDetails.appSubmit = function() {
    $('#' + screenId + 'stage1').addClass('sno');
    $('#' + screenId + 'stage2').addClass('sno');
    $('#' + screenId + 'stage3').addClass('sno');
    $('#' + screenId + 'stage4').removeClass('sno');
    apz.app.AddLoanDetails.paintData();
    setTimeout(function() {
        $('#' + screenId + 'successDtlsForm').removeClass('sno');
        apz.stopLoader();
    }, 2000);
}
apz.app.AddLoanDetails.paintData = function() {
    var customerName = KendraApp.selectedCustomer.customerName || "Unknown"; // Default value if customerName is null or undefined
    var approvedAmt = KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.chargeAndBreakupDtls.loanAmt ||
    "₹0"; // Default value if approvedAmt is null or undefined
    var product = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.shortDesc;
    $("#" + screenId + "succCustName").text(customerName + " (" + '₹' + ApzCOB.fn_FormatAmount(approvedAmt) + ' ' + product + " )");
    $("#" + screenId + "sucCustLoanId").text('#' + KendraApp.AppCreateResObj.applicationId)
    if (IncomeApp.status === 'PENDINGBYRPC') {
        $('#' + screenId + 'incMoveToRpc').removeClass('sno');
        $('#' + screenId + 'incMoveToRpc').text(
            "The income assessment is pending with RPC. Once it's approved, the loan will move to the sanction stage.");
    }
    apz.app.AddLoanDetails.moreDetails();
}
apz.app.AddLoanDetails.moreDetails = function() {
    var preclosedAmt = 0;
    var activeLoans = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls
    activeLoans.forEach(function(el, i) {
        if (activeLoans[i].status === "CLOSED") {
            var amt = Math.round(parseFloat(activeLoans[i].outstandingPrincipal)) + Math.round(parseFloat(activeLoans[i]
                .overdueInterest)) + Math.round(parseFloat(activeLoans[i].overduePrincipal));
            preclosedAmt = Math.round(parseFloat(preclosedAmt)) + Math.round(parseFloat(amt));
        }
    })
    preclosedAmt = ApzCOB.fn_FormatAmount(preclosedAmt);
    apz.setElmValue(screenId + "interest", (cbResponse.roi ?? 'NO DATA') + "%");
    apz.setElmValue(screenId + "sucTenure", KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.term ?? 'NO DATA');
    if (window.loanProduct === 'Emergency Loan') {
        apz.setElmValue(screenId + "sucLoanCharges", KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls
            .upfront_Fee ? ApzCOB.fn_FormatAmount(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls
                .upfront_Fee) : 'NO DATA');
    } else {
        apz.setElmValue(screenId + "sucLoanCharges", KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls
            .addInfo1 ? ApzCOB.fn_FormatAmount(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls
                .addInfo1) : 'NO DATA');
    }
    apz.setElmValue(screenId + "sucFrequency", KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.repayFrequency.idDesc ??
        'NO DATA');
    apz.setElmValue(screenId + "preclosedAmount", '₹' + preclosedAmt);
    if (KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls.member === 'N') {
        $("#" + screenId + "sc_row_809").addClass("sno");
    } else {
        $("#" + screenId + "sc_row_809").removeClass("sno");
        apz.setElmValue(screenId + "insurance", KendraApp.selectedCustomer.addLoanDetailsObj.scrDataStep1.insurDtls.insuranceProvider ??
            'NO DATA');
    }
    // apz.setElmValue(screenId + "sucRefId", custData.applicationId);
}
apz.app.AddLoanDetails.clickMoreOptionsBtn = function() {
    if ($("#" + screenId + "moreDetailsDiv").hasClass("sno")) {
        $("#" + screenId + "moreDetailsDiv").removeClass("sno");
        if (window.loanProduct === "Emergency Loan") {
            $("#" + screenId + "sc_row_801").removeClass("sno");
        } else {
            $("#" + screenId + "sc_row_801").addClass("sno");
        }
    } else {
        $("#" + screenId + "moreDetailsDiv").addClass("sno");
    }
}
apz.app.AddLoanDetails.proceedLoan = function() {
    window.cbApproveManual = '';
    var insDet = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls;
    var insurAmt = 0;
    if (insDet.member === 'Y' && insDet.Spouse === 'Y') {
        insurAmt = cbResponse.Insurance_Charge_Spouse + cbResponse.Insurance_Charge_Member;
        insDet.applicant_insurance_amt = cbResponse.Insurance_Charge_Member;
        insDet.spouse_insurance_amt = cbResponse.Insurance_Charge_Spouse;
    } else if (insDet.member === 'Y') {
        insurAmt = cbResponse.Insurance_Charge_Member;
        insDet.applicant_insurance_amt = cbResponse.Insurance_Charge_Member;
        insDet.spouse_insurance_amt = "";
    } else if (insDet.Spouse === 'Y') {
        insurAmt = cbResponse.Insurance_Charge_Spouse;
        insDet.applicant_insurance_amt = "";
        insDet.spouse_insurance_amt = cbResponse.Insurance_Charge_Spouse;
    } else {
        insurAmt = 0;
        insDet.applicant_insurance_amt = "";
        insDet.spouse_insurance_amt = "";
    }
    insDet.insurCharges = insurAmt;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.insurDtls = insDet;
    var aprxloancharges = parseInt((cbResponse.GST + cbResponse.Processing_fees_without_GST));
    var aprxloanchargeswithins = aprxloancharges + insurAmt;
    var aprxloanamount = ((parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount)) - parseInt((cbResponse.GST + cbResponse
        .Processing_fees_without_GST + insurAmt)));
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.loanAmt = cbResponse.Approved_Loan_Amount;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.GST = cbResponse.GST;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.addInfo1 = aprxloanchargeswithins;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.aprxLoanCharges = aprxloancharges;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.loanProcessingFee = cbResponse
        .Processing_fees_without_GST;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.aprxLoanAmt = aprxloanamount;
    //KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.aprxInstallmentAmt=cbResponse.approved_loan_emi;
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.iscbUpdated = true;
    if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.productType == 'EL') {
        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.interest_Fee = cbResponse.Interest_Fee ?? "0";
        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.upfront_Fee = cbResponse.Upfront_Fee ?? "0";
    } else {
        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.interest_Fee = "";
        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.chargeAndBreakupDtls.upfront_Fee = "";
    }
    if (window.isCBsuccess) {
        window.KendraApp.remarks = 'The Loan updated by ' + LoggedInUserDetails.userID + ' (' + currentUserRole + ') ~ BRE fee charges applied.';
        selectedPreclosureApplyLoan = true;
    }
    if (KendraApp.activeLoanDtls.length == 0) {
        ApzCOB.saveLoan();
        //ApzCOB.kmActionPostCBCheck();
        //apz.app.AddLoanDetails.kmAutoSubmit();
    } else {
        selectedAppObj.loanDtls.forEach(function(loan, i) {
            if ($('#' + screenId + 'el_cbx_6_' + i).prop('checked') === true) {
                window.KendraApp.remarks = 'The Loan updated by ' + LoggedInUserDetails.userID + ' (' + currentUserRole +
                    ') ~ preclosure changes applied.';
                selectedPreclosureApplyLoan = true;
                KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls.forEach(function(prod, j) {
                    if (prod.productId == loan.productId) {
                        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[j].status = 'CLOSED';
                    }
                    //if (KendraApp.currentLoanAppRequest.applicationdtls.addInfo.reIncomeAssessment) {
                    if ($('#' + screenId + 'el_cbx_6_' + i).prop('checked') === true) {
                        if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.productId ===
                            'GL.IGL.VISH.LN') {
                            if (["GL.IGL.PRAGATI", "GL.IGL.PRAGATI.PLUS", "GL.IGL.PRAGATI.RESTR", "GL.IGL.PRAGATI.PLUS.2",
                                    "GL.IGL.VISH.LN"
                                ].includes(prod.product)) {
                                KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[j].status =
                                    'CLOSED';
                            }
                        } else if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.productId ===
                            'GL.GRM.VISH.SUPPL') {
                            if (["GL.PRAGATI.SUPLMNTRY", "GL.PRAGATI.SUPL.PLUS", "GL.GRM.VISH.SUPPL"].includes(prod.product)) {
                                KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[j].status =
                                    'CLOSED';
                            }
                        }
                    }
                    //}
                });
            }
        });
        if (selectedPreclosureApplyLoan) {
            //window.KendraApp.remarks='Loan updated by '+LoggedInUserDetails.userID +' ('+currentUserRole +') ~ preclosure changes applied.';
            ApzCOB.saveLoan();
        } else {
            apz.app.AddLoanDetails.kmAutoSubmit();
            //ApzCOB.kmActionPostCBCheck();
        }
    }
    //ApzCOB.kmActionPostCBCheck();
}
apz.app.AddLoanDetails.resetLoan = function() {
    if (selLoanProdDesc === "Emergency Loan") {
        console.log(window.loanProduct);
    } else {
        $('#' + screenId + "purpAndSubpurp").val('')
        $('#' + screenId + "repayFreq").val('');
        apz.app.AddLoanDetails.loadRepaymentFrequency();
    }
    // $('#' + screenId + "repayFreq").val('');
    //$('#' + screenId + "insurProviderDpd").val('Please Select')
    // $('#' + screenId + "nomineeName").val('')
    // $('#' + screenId + "nomineeReationDpd").val('Please Select');
    // apz.app.AddLoanDetails.onClickRepayFrequency();
}
apz.app.AddLoanDetails.searchSubproduct = function(pthis) {
    var searchResult;
    var searchText = $("#" + pthis.id).val();
    if (apz.isNull(searchText)) {
        searchResult = searchData;
    } else {
        searchResult = searchData.filter(function(e, i) {
            return (e.subPurposeIdDesc.toUpperCase().indexOf(searchText.toUpperCase()) !== -1);
        });
    }
    searchResult.forEach((d, idx) => {
        $('#' + screenId + 'subPurposeCheckbox_' + idx).prop('checked', false);
    });
    if (searchResult.length === 0) {
        $("#" + screenId + 'subPurposeList').addClass('sno');
        $("#" + screenId + 'noRecDiv').removeClass('sno')
    } else {
        $("#" + screenId + 'subPurposeList').removeClass('sno');
        $("#" + screenId + 'noRecDiv').addClass('sno')
        apz.data.scrdata.NEWLOA__SubPurpose_Res.SubPurposeNode = searchResult;
        apz.data.loadData("SubPurpose", 'NEWLOA');
    }
}
apz.app.AddLoanDetails.successRejectedCheckbox = function(pthis) {
    let rowNo = $(pthis).attr("rowno");
    let checkbox = $(pthis).find(`input[type="checkbox"][rowno="${rowNo}"]`);
    if (checkbox.length) {
        checkbox.prop('checked', !checkbox.prop('checked')); // Toggle the checkbox
    }
};
apz.app.AddLoanDetails.updateIncomeDetails = function() {
    $('#NEWLOA__AddLoanDetails__conmobNo').text(KendraApp.selectedCustomer.mobileNum);
    if (upgrFlag) {
        $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
        $('#NEWLOA__AddLoanDetails__pendingRow').addClass('sno');
        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);
    } else {
        screenId = "NEWLOA__AddLoanDetails__";
        var earningArr = [];
        IncomeApp.payLoad.earnings.forEach(function(el) {
            var obj = {};
            if (el.isExisting) {
                obj = el;
            } else {
                obj = el.InputData;
                obj.customerId = el.customerId;
            }
            earningArr.push(obj);
        })
        KendraApp.selectedCustomer.earnings = earningArr;
        KendraApp.selectedCustomer.income = IncomeApp.payLoad.income;
        var memberstext = 'Earning members in the family (' + KendraApp.selectedCustomer.earnings.length + ')';
        apz.setElmValue(screenId + "memberscount", memberstext);
        var memberstext = 'Earning members in the family (' + KendraApp.selectedCustomer.earnings.length + ')';
        apz.setElmValue(screenId + "memberscount", memberstext);
        var membersname = '';
        if (KendraApp.selectedCustomer.earnings.length != 0) {
            KendraApp.selectedCustomer.earnings.forEach(function(el, i) {
                if (i == KendraApp.selectedCustomer.earnings.length - 1) {
                    membersname += KendraApp.selectedCustomer.earnings[i].name + ' (' + KendraApp.selectedCustomer.earnings[i]
                        .memRelation + ')';
                } else if (i == 0) {
                    membersname = KendraApp.selectedCustomer.earnings[i].name + ' (' + KendraApp.selectedCustomer.earnings[i]
                        .memRelation + '),';
                } else {
                    membersname += KendraApp.selectedCustomer.earnings[i].name + ' (' + KendraApp.selectedCustomer.earnings[i]
                        .memRelation + '),';
                }
            });
        }
        apz.setElmValue(screenId + "membersname", membersname);
        apz.setElmValue(screenId + "conincome", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totIncome));
        apz.setElmValue(screenId + "conexpense", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totExpense));
        apz.setElmValue(screenId + "contotalIncome", ApzCOB.fn_FormatAmount(KendraApp.selectedCustomer.income[0].totIncome - KendraApp
            .selectedCustomer.income[0].totExpense));
        apz.app.AddLoanDetails.updateIncomeDet();
        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').text('Confirm & Start CB Check');
        if (KendraApp.selectedCustomer.mobileNum) {
            apz.setElmValue(screenId + "conmobNo", KendraApp.selectedCustomer.mobileNum);
            $('#' + screenId + 'conmobNo').removeClass('sno');
            $('#' + screenId + 'el_btn_29').removeClass('sno');
            $('#' + screenId + 'ct_frm_105').removeClass('sno');
            $('#' + screenId + 'addMobile_ul').addClass('sno');
            $('#' + screenId + 'sc_row_825').addClass('sno');
        } else {
            $('#' + screenId + 'conmobNo').addClass('sno');
            $('#' + screenId + 'el_btn_29').addClass('sno');
            $('#' + screenId + 'ct_frm_105').addClass('sno');
            $('#' + screenId + 'addMobile_ul').removeClass('sno');
            $('#' + screenId + 'sc_row_825').removeClass('sno');
        }
        if (IncomeApp.status === 'APPROVED') {
            $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
            $('#NEWLOA__AddLoanDetails__pendingRow').addClass('sno');
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);
        } else if (IncomeApp.status == 'PENDING') {
            $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
            $('#NEWLOA__AddLoanDetails__pendingRow').removeClass('sno');
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
        } else if (IncomeApp.status == 'PENDINGBYRPC') {
            $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
            $('#NEWLOA__AddLoanDetails__pendingRow').addClass('sno');
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').text('Submit');
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);
        } else {
            //$('#NEWLOA__AddLoanDetails__pendingRow').removeClass('sno');
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
        }
    }
};
apz.app.AddLoanDetails.editMobile = function() {
    //ApzCOB.toggleModal(screenId + "mobConfirmModal");
    $('#APZCBO__BaseScreens__STAGE1').addClass('sno');
    let data = {
        selectedCust: KendraApp.selectedCustomer,
        childScr: 'AddLoanDetails'
    };
    ApzCOB.launchMicroApp("NEWLOA", "UpdateMobNumber", "APZCBO__BaseScreens__STAGE15", data);
}
apz.app.AddLoanDetails.onUpdateMobNum = function() {
    apz.setElmValue(screenId + "conmobNo", KendraApp.selectedCustomer.mobileNum);
    apz.setElmValue(screenId + "confirmMobileNum", KendraApp.selectedCustomer.mobileNum);
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.kycDtls.mobileNum = KendraApp.selectedCustomer.mobileNum;
    apz.app.AddLoanDetails.addMobileNum();
}
apz.app.AddLoanDetails.updateIncomeDet = function() {
    function addMonths(date, months) {
        var newDate = new Date(date);
        newDate.setMonth(newDate.getMonth() + months);
        return newDate;
    }
    if (upgrFlag) {
        $('#NEWLOA__AddLoanDetails__IncomeRow').addClass('sno');
        $('#NEWLOA__AddLoanDetails__pendingRow').addClass('sno');
        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);
    } else {
        if (apz.isNull(KendraApp.selectedCustomer.income)) {
            $("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
            $("#" + screenId + 'updateInfo').text('Member Income Details need to be added');
            $("#NEWLOA__AddLoanDetails__el_btn_75_txtcnt").text('ADD NOW');
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
        } else {
            if (KendraApp.selectedCustomer.income.length !== 0) {
                if (apz.isNull(KendraApp.selectedCustomer.income[0].assesmentDt)) {
                    $("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
                    $("#" + screenId + 'updateInfo').text('Member Income Details need to be updated.');
                    $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
                    $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
                } else {
                    $("#NEWLOA__AddLoanDetails__el_btn_75_txtcnt").text('UPDATE NOW');
                    var dateString = KendraApp.selectedCustomer.income[0].assesmentDt;
                    var year = parseInt(dateString.substring(0, 4), 10);
                    var month = parseInt(dateString.substring(4, 6), 10) - 1;
                    var day = parseInt(dateString.substring(6, 8), 10);
                    var date = new Date(year, month, day);
                    var currentDate = new Date();
                    currentDate.setHours(0, 0, 0, 0);
                    var dateInSixMonths = addMonths(currentDate, 6);
                    dateInSixMonths.setHours(0, 0, 0, 0);
                    if (date < currentDate) {
                        /*$("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
                        $("#" + screenId + 'updateInfo').text('Member Income Details need to be updated,details expired on ' + ApzCOB.plaintoDateformat(
                            KendraApp.selectedCustomer.income[0].assesmentDt, ''));
                        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
                        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);*/
                    } else if (date > currentDate) {
                        if (date <= dateInSixMonths) {
                            /*$("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
                            $("#" + screenId + 'updateInfo').text('Member Income Details need to be updated,details will expire on ' + ApzCOB
                                .plaintoDateformat(KendraApp.selectedCustomer.income[0].assesmentDt, ''));
                            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
                            $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);*/
                        } else {
                            $("#" + screenId + 'updateInfoExpiryRow').addClass('sno');
                        }
                    } else {
                        /*$("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
                        $("#" + screenId + 'updateInfo').text('Member Income Details need to be updated,details will expire on ' + ApzCOB
                            .plaintoDateformat(KendraApp.selectedCustomer.income[0].assesmentDt, ''));
                        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
                        $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);*/
                    }
                    $("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
                    $("#" + screenId + 'updateInfo').text('Member Income Details need to be updated.');
                    $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
                    $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
                }
            } else {
                $("#" + screenId + 'updateInfoExpiryRow').removeClass('sno');
                $("#" + screenId + 'updateInfo').text('Member Income Details need to be added');
                $("#NEWLOA__AddLoanDetails__el_btn_75_txtcnt").text('ADD NOW');
                $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
                $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
            }
        }
        if (!apz.isObjectEmpty(window.IncomeApp.payLoad)) {
            if (IncomeApp.status === 'APPROVED' || IncomeApp.status === 'PENDINGBYRPC') {
                $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', true);
                $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', false);
                apz.app.AddLoanDetails.saveData();
            } else {
                $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('enabled', false);
                $('#NEWLOA__AddLoanDetails__confirmCbCheckBtn').prop('disabled', true);
            }
        }
    }
}
apz.app.AddLoanDetails.loanUpgrade = function() {
    $("#" + screenId + 'gr_row_125').addClass('sno');
    $("#" + screenId + 'stage3').addClass('sno');
    $("#" + screenId + 'loanUpgradeRow').removeClass('sno');
    $("#" + screenId + 'sc_row_846').addClass('sno');
    $("#" + screenId + 'sc_row_847').addClass('sno');
    apz.setElmValue(screenId + "upgradedLnAmt", ApzCOB.fn_FormatAmount(eligibleAmt));
    apz.setElmValue(screenId + "upgradedLnPdt", KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.description.toUpperCase());
    apz.setElmValue(screenId + "upgradedInterest", selLoanProdObj.productDtls.intRate + "%");
    apz.setElmValue(screenId + "upgradedLnFees", "₹ " + ApzCOB.calProcessingFees(defAmt,window.feeCharge));
    apz.setElmValue(screenId + "upgradedTenure", term + " Weeks");
    apz.setElmValue(screenId + "upgradedWkInstlmnt", "₹ " + ApzCOB.fn_FormatAmount(ApzCOB.calApproxWeekInstallment(selLoanProdObj.productDtls
        .intRate, defAmt, (term / apz.app.AddLoanDetails.fetchFrequncyVal(apz.getElmValue(screenId + "repayFreq"))))));
    apz.setElmValue(screenId + "upgradedPurpose", purp + " : " + subPurp);
}
apz.app.AddLoanDetails.backNav = function() {
    $("#" + screenId + 'loanUpgradeRow').addClass('sno');
    $("#" + screenId + 'stage3').removeClass('sno');
}
apz.app.AddLoanDetails.upgradeBack = function() {
    upgrFlag = true;
    $('#' + screenId + 'stage1').removeClass('sno');
    $('#' + screenId + 'stage2').addClass('sno');
    $('#' + screenId + 'stage3').addClass('sno');
    $('#' + screenId + 'stage4').addClass('sno');
    apz.setElmValue(screenId + "loanAmount", ApzCOB.fn_FormatAmount(eligibleAmt - eligibleAmt % 1000));
    $("#" + screenId + 'loanAmount').blur();
    $('#NEWLOA__AddLoanDetails__loanAmount').trigger("onblur");
}
apz.app.AddLoanDetails.updateProduct = function() {
    $('#' + screenId + 'stage1').removeClass('sno');
    $('#' + screenId + 'stage2').addClass('sno');
    $('#' + screenId + 'stage3').addClass('sno');
    $('#' + screenId + 'stage4').addClass('sno');
    apz.app.AddLoanDetails.loadLoanProducts();
}
apz.app.AddLoanDetails.rejectApp = function() {
    var remarksnew = 'The Loan Rejected by ' + LoggedInUserDetails.userID + ' (' + currentUserRole + ')post CB screen ~ lesser amount cases.';
    window.CRTworkflow = {
        "currentRole": "KM",
        "action": "REJECT",
        "workflowId": "LOANINPUT",
        "stage": "USERCHECK",
        "remarks": remarksnew
    }
    window.reject = true;
    KendraApp.crtObj.applicationId = KendraApp.currentLoanAppRequest.applicationdtls.applicationId;
    KendraApp.crtObj.versionNo = KendraApp.currentLoanAppRequest.applicationdtls.versionNo;
    window.cbApproveManual = 'N';
    window.crtRejectKM = true;
    ApzCOB.kmActionPostCBCheck();
}
apz.app.AddLoanDetails.customerDtls = function(pthis) {
    scrName = {
        'screen': 'AddLoanDetails'
    }
    ApzCOB.launchMicroApp("Custom", "CustomerDetails", "APZCBO__BaseScreens__BaseDIV", scrName);
}
apz.app.AddLoanDetails.creditCheck = function() {
    var req = {
        "apiRequest": {
            "appId": gAppId,
            "interfaceName": "loanCBCheck",
            "userId": LoggedInUserDetails.userID,
            "requestObj": {
                "applicationId": KendraApp.currentLoanAppRequest.applicationdtls.applicationId,
                "versionNo": KendraApp.currentLoanAppRequest.applicationdtls.versionNo,
                "crtFlag": false,
                "schedulerEnabled": "",
                "custDtlId": KendraApp.currentLoanAppRequest.applicationdtls.customerId
            }
        }
    }
    req.apiRequest.requestObj.userRole = currentUserRole;
    req.apiRequest.requestObj.appVersion = appVersion;
    req.apiRequest.requestObj.userName = LoggedInUserDetails.loginResponse.userDet.name;
    req.apiRequest.requestObj.userId = LoggedInUserDetails.userID;
    req.apiRequest.requestObj.remarks = 'The Loan CB check without OTP';
    ApzCOB.serverBuildParam(gAppId, 'loanCBCheck', 'N', 'N', req, 'Y', apz.app.AddLoanDetails.creditCheckCB);
}
apz.app.AddLoanDetails.creditCheckCB = function(params) {
    upgrFlag = false;
    cbcheckResponse = params;
    //apz.stopLoader();
    if (ApzCOB.handleServiceCallBacks(params)) {
     try {    
        if (IncomeApp.status === 'PENDINGBYRPC') {
            cbResponse = JSON.parse(params.res.APZCBO__loanCBCheck_Res.apiResponse.ResponseBody.responseObj);
            apz.app.AddLoanDetails.appSubmit();
        } else {
            if (!apz.isNull(params.res.APZCBO__loanCBCheck_Res.apiResponse.ResponseBody.responseObj)) {
                cbResponse = JSON.parse(params.res.APZCBO__loanCBCheck_Res.apiResponse.ResponseBody.responseObj);
                var approvedAmt = 0;
                if (!apz.isNull(cbResponse.Approved_Loan_Amount)) {
                    approvedAmt = cbResponse.Approved_Loan_Amount;
                }
                eligibleAmt = approvedAmt;
                if (cbResponse.IRIS_message == 'success' || cbResponse.IRIS_message == 'SUCCESS' ||cbResponse.IRIS_message == 'bureau_data_issue_spouse_node_corrected_success') {
                    if (cbResponse.Final_Decision === 'Approved' || cbResponse.Final_Decision === 'Approved with Pre-closure') {
                        apz.stopLoader();
                        $("#NEWLOA__AddLoanDetails__el_icn_43").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_icn_45").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_btn_32").addClass("sno");
                        if (parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount) > approvedAmt) {
                            backReject = true;
                            $('#NEWLOA__AddLoanDetails__ct_nav_23').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_21').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
                            $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__rejectAppBtnRow').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__proceedAppBtn').text("Proceed with ₹" + approvedAmt);
                            $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
                            apz.app.AddLoanDetails.CBcheckold();
                            apz.app.AddLoanDetails.paintpreLoanDetails();
                        } else if (approvedAmt > parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount)) {
                            let appliedAmt = parseInt(KendraApp.currentLoanAppRequest.applicationdtls.amount);
                            backReject = false;
                            $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_22').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_21').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', true);
                            $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__proceedAppBtnRow').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__appliedAppBtn').text("Proceed with ₹" + appliedAmt);
                            $('#NEWLOA__AddLoanDetails__upgradeAppBtn').text("Upgrade & Apply with ₹" + approvedAmt);
                            $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
                            apz.app.AddLoanDetails.CBcheckold();
                            apz.app.AddLoanDetails.paintpreLoanDetails();
                        } else {
                           // $("#NEWLOA__AddLoanDetails__el_icn_43").addClass("sno");
                          //  $("#NEWLOA__AddLoanDetails__el_icn_45").addClass("sno");
                           // $("#NEWLOA__AddLoanDetails__el_btn_32").addClass("sno");
                            backReject = false;
                            $('#NEWLOA__AddLoanDetails__ct_nav_12').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_21').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__rejectAppBtnRow').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__proceedAppBtnRow').addClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').removeClass('sno');
                            $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', false);
                            $('#NEWLOA__AddLoanDetails__sc_row_866').addClass('sno');
                            apz.app.AddLoanDetails.CBcheckold();
                            window.isCBsuccess=true;
                            apz.app.AddLoanDetails.paintpreLoanDetails();
                        }
                    } else {
                        backReject = false;
                        $("#NEWLOA__AddLoanDetails__el_icn_43").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_icn_45").addClass("sno");
                        $("#NEWLOA__AddLoanDetails__el_btn_32").addClass("sno");
                        var cbRate = '';
                        if (!apz.isNull(cbResponse.Rejection_reason)) {
                            cbRate = "Loan rejection reason - " + cbResponse.Rejection_reason;
                            $('#NEWLOA__AddLoanDetails__failedmsg_txtcnt').text(cbRate);
                            $('#NEWLOA__AddLoanDetails__failedmsg').removeClass('sno');
                        } else {
                            $('#NEWLOA__AddLoanDetails__failedmsg').addClass('sno');
                        }
                        $('#NEWLOA__AddLoanDetails__failedHeader_txtcnt').text('CB Loan Rejected');
                        $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__ct_nav_21').removeClass('sno');
                        $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', 'disabled')
                        apz.app.AddLoanDetails.CBcheckold();
                        apz.app.AddLoanDetails.paintpreLoanDetails();
                        selectedAppObj.loanDtls.forEach(function(loan, i) {
                            $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                        });
                        $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__el_btn_72_ul').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__el_btn_72').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__rejectAppBtnRow').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__proceedAppBtnRow').addClass('sno');
                        $('#NEWLOA__AddLoanDetails__sc_row_866').removeClass('sno');
                    }
                    apz.setElmValue(screenId + "sucElAmt", ApzCOB.fn_FormatAmount(approvedAmt));
                     $('#NEWLOA__AddLoanDetails__sc_col_757').addClass('sno');
                } else {
                    $('#NEWLOA__AddLoanDetails__ct_nav_12').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__ct_nav_22').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__ct_nav_23').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__ct_nav_21').removeClass('sno');
                    $('#NEWLOA__AddLoanDetails__failedmsg').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__el_btn_34').attr('disabled', 'disabled');
                    $('#NEWLOA__AddLoanDetails__el_txt_468').addClass('sno');
                    selectedAppObj.loanDtls.forEach(function(loan, i) {
                        $('#' + screenId + 'el_cbx_6_' + i).prop('disabled', true);
                    });
                    apz.app.AddLoanDetails.CBcheckold();
                    apz.app.AddLoanDetails.paintpreLoanDetails();
                    $('#NEWLOA__AddLoanDetails__el_btn_34').addClass('sno');
                    $('#NEWLOA__AddLoanDetails__el_btn_72_ul').removeClass('sno');
                    $('#NEWLOA__AddLoanDetails__el_btn_72').removeClass('sno');
                    apz.setElmValue(screenId + "sucElAmt", ApzCOB.fn_FormatAmount(approvedAmt));
                     $('#NEWLOA__AddLoanDetails__sc_col_757').addClass('sno');
                }
                 if (window.loanProduct === "Emergency Loan") {
                     if ((cbResponse.IRIS_message === 'success' || cbResponse.IRIS_message === 'SUCCESS' ||cbResponse.IRIS_message == 'bureau_data_issue_spouse_node_corrected_success') && (cbResponse.Final_Decision ===
                             'Approved' || cbResponse.Final_Decision === 'Approved with Pre-closure')) {
                         console.log("CB Passed")
                     } else {
                         apz.app.AddLoanDetails.reject();
                     }
                 }
				if (KendraApp.selectedCustomer.custStatus != 'NQA') {
                    if (cbResponse.Rejection_reason === 'Reject - Eligible for NQA, Do Re-income assessment') {
                        ApzCOB.fnDisplayMsg("Customer is eligible for Grameen Vishesh loan. Do you want to do Re-Income Assessment?", "C", apz.app
                            .AddLoanDetails.reIncomeAssCB);
                    } else {
                        window.reIncomeAssessment = false;
                    }
                } else {
                    window.reIncomeAssessment = false;
                }
            } else {
                ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
            }
        }
     } catch (e) {
	   ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
	 }    
    } else {
        ApzCOB.fnDisplayMsg(ApzCOB.getDescfromLitCode("LIT_COMM_ERR_TXT_TECHNICAL"), "E");
    }
    window.isloanOTP = true;
    window.isSkipOTP = false;
    apz.stopLoader();
    // apz.app.AddLoanDetails.CBcheckold();
    //apz.app.AddLoanDetails.paintpreLoanDetails();
    $('#header').addClass('sno')
}
apz.app.AddLoanDetails.saveData = function() {
    //ApzCOB.toggleModal(screenId + "mobConfirmModal");
    //var data = [];
    screenId = "NEWLOA__AddLoanDetails__"; //draft changes
    KendraApp.currentLoanAppRequest.applicationdtls.customerName = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.customerName;
    KendraApp.currentLoanAppRequest.applicationdtls.amount = ApzCOB.fn_unFormatAmount(apz.getElmValue(screenId + "loanAmount"));
    if (!apz.isNull(KendraApp.AppCreateResObj.applicationId)) {
        KendraApp.currentLoanAppRequest.applicationdtls.versionNo = KendraApp.AppCreateResObj.versionNo;
        KendraApp.currentLoanAppRequest.applicationdtls.applicationId = KendraApp.AppCreateResObj.applicationId;
    }
    if (!apz.isNull(draftCustData)&&isDraftApplication) {
        KendraApp.currentLoanAppRequest.applicationdtls.versionNo = KendraApp.AppCreateResObj.versionNo??draftCustData.versionNo;
        KendraApp.currentLoanAppRequest.applicationdtls.applicationId = draftCustData.applicationId;
    }
    if (IncomeApp?.status === 'APPROVED' || IncomeApp?.status === 'PENDINGBYRPC') {
        if (IncomeApp?.payLoad?.earnings.length != 0) {
            var earnings = [];
            if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings.length != 0) {
                earnings.push(KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings[0])
            }
            if (IncomeApp?.status == 'APPROVED') {
                IncomeApp?.payLoad?.earnings.forEach(function(o) {
                    if (!o.isExisting && IncomeApp.flow != 'fromDraft') {
                        var docName = 'VOTER-ID';
                        if (o.InputData.legaldocName == 'PAN' || o.InputData.legaldocName == 'PANCARD' || o.InputData.legaldocName ==
                            'Pan Card') {
                            docName = 'PAN-CARD'
                        } else if (o.InputData.legaldocName == 'VOTER' || o.InputData.legaldocName == 'VOTERID' || o.InputData
                            .legaldocName == 'VOTER-ID') {
                            docName = 'VOTER-ID';
                        } else {
                            docName = 'DRIVING-LICENCE';
                        }
                        var earnMemDetails = {
                            "customerId": KendraApp.selectedCustomer.customerId,
                            "name": o.InputData.name,
                            "dob": ApzCOB.formattedtoPlain(o.InputData.dob),
                            "memRelation": o.InputData.memRelation,
                            "legaldocId": o.InputData.legaldocId,
                            "legaldocName": docName,
                        };
                        earnings.push(earnMemDetails);
                    }
                });
            }
            KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.earnings = earnings;
        }
        KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.income = KendraApp.selectedCustomer.income;
    }
    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.kycDtls.mobileNum = KendraApp.selectedCustomer.mobileNum;
    KendraApp.selectedKendra.officeData.kmName = LoggedInUserDetails.loginResponse.userDet.name;
    KendraApp.selectedKendra.officeData.groupId = KendraApp.selectedCustomer.groupId;
    KendraApp.selectedKendra.officeData.caglAmt = KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.caglAmt;
    if (!apz.isNull(IncomeApp?.applicationId)) {
        KendraApp.selectedKendra.officeData.incomeAppId = IncomeApp?.applicationId;
    }
    KendraApp.selectedKendra.officeData.isApprovedCRT=false;
    KendraApp.selectedKendra.officeData.isAmountUpdate=false;
    KendraApp.selectedKendra.officeData.isQuestionComplete='';
    KendraApp.selectedKendra.officeData.FOIR='';
    KendraApp.selectedKendra.officeData.APR='';
    KendraApp.selectedKendra.officeData.lnOutstandingAmt=lnOutstandingAmt;
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo = KendraApp.selectedKendra.officeData;
    var selectApproval=ApzCOB.fetchApprovallevel(KendraApp.currentLoanAppRequest.applicationdtls);
    var resultArr = [];
    if (selectApproval.RecommandRoleList && selectApproval.RecommandRoleList.length > 0) {
        for (var i = 0; i < selectApproval.RecommandRoleList.length; i++) {
            resultArr.push(selectApproval.RecommandRoleList[i].charAt(0));
        }
    }
    if (selectApproval.SanctionRoleList && selectApproval.SanctionRoleList.length > 0) {
        for (var j = 0; j < selectApproval.SanctionRoleList.length; j++) {
            resultArr.push(selectApproval.SanctionRoleList[j].charAt(0));
        }
    }
    var leader = 'B';
    if(resultArr.length !=0){
      leader=resultArr.join('');
    }
    KendraApp.currentLoanAppRequest.applicationdtls.leader=leader;
    KendraApp.currentLoanAppRequest.applicationdtls.currentScreenId = 'CONFIRM';
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo.otpDetails = typeof otpDetails !== 'undefined' ? otpDetails : '';
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo.reIncomeAssessment = reIncome ?? '';
    KendraApp.currentLoanAppRequest.applicationdtls.addInfo.incomeStatus=IncomeApp?.status;
};
apz.app.AddLoanDetails.loadLoanCBDetails = function() {
   if (cbResponse.flow_response === "CB PASS" || cbResponse.flow_response === "CRT PASS") {
        var cbStatus = "Approved"
        var approvedLoanAmt = "₹ " + cbResponse.Approved_Loan_Amount;
        var loanprd = window.loanProduct;
    }
    CbDetailsArr = JSON.parse('[{"ID":"Loan Product","Desc":"CASH"},{"ID":"Loan Amount","Desc":"NEFT"},{"ID":"CB Status","Desc":"NEFT"}]');
    CbDetailsArr.forEach(function(item) {
        if (item.ID === "Loan Product") {
            item.ID = "Loan Product";
            item.Desc = loanprd;
        } else if (item.ID === "Loan Amount") {
            item.ID = "Loan Amount"
            item.Desc = approvedLoanAmt;
        } else if (item.ID === "CB Status") {
            item.ID = "CB Status"
            item.Desc = cbStatus;
        }
    });
    apz.data.scrdata.NEWLOA__CbDetailsiPaint_Res = {};
    apz.data.scrdata.NEWLOA__CbDetailsiPaint_Res.cbDetailsNode = CbDetailsArr;
    apz.data.loadData("CbDetailsiPaint", 'NEWLOA');
}
apz.app.AddLoanDetails.addQuestionary = function() {
    $('#APZCBO__BaseScreens__STAGE1').addClass('sno');
    IncomeApp.flow = 'loanInput';
    IncomeApp.applicationDetails=KendraApp.currentLoanAppRequest.applicationdtls;
    ApzCOB.launchMicroApp('questi', 'AddHouseHoldDetails', 'APZCBO__BaseScreens__STAGE2', '');
}

apz.app.AddLoanDetails.kmAutoSubmit = function() {
    if (userRole === 'CRT' || userRole === 'KM' && window.crtRejectKM === true || isSelfAssigned && window.crtRejectKM) {
        workflow = window.cbApproveManual === 'N' ? window.CRTworkflow : {};
    } else if ((userRoleIfDeoAvailable.includes("DEO") || userRoleIfDeoAvailable.includes("KM") || isSelfAssigned) && window.loanProduct ===
        'Emergency Loan') {
        workflow = workflow = {
            "currentRole": "KM",
            "action": "NEXT",
            "workflowId": "SANCTION",
            "stage": "SANCTIONED",
            "remarks": ""
        };
    } else {
        workflow = {};
    }
    var applicationDetails = [];
    applicationDetails.push({
        "applicationId": KendraApp.AppCreateResObj.applicationId,
        "versionNum": KendraApp.AppCreateResObj.versionNo
    });
    var req = {
        "apiRequest": {
            "appId": gAppId,
            "interfaceName": "KMActionPostCBCheck",
            "requestObj": {
                "workflow": workflow,
                "createdBy": userRole === 'CRT' || userRole === 'RPC' ? LoggedInUserDetails.userID : KendraApp.selectedKendra.createdBy,
                // "applicationId": userRole === 'CRT' ? KendraApp.crtObj.applicationId : KendraApp.AppCreateResObj.applicationId,
                "applicationId": "",
                "applicationStatus": 'Move to BM',
                "appId": gAppId,
                "cbApproveManual": window.cbApproveManual,
                // "versionNum": userRole === 'CRT' ? KendraApp.crtObj.versionNo : KendraApp.AppCreateResObj.versionNo,
                "versionNum": "",
                "applicationDetailList": applicationDetails
            }
        }
    }
    req.apiRequest.requestObj.userRole = currentUserRole;
    req.apiRequest.requestObj.appVersion = appVersion;
    req.apiRequest.requestObj.userName = LoggedInUserDetails.loginResponse.userDet.name;
    req.apiRequest.requestObj.userId = LoggedInUserDetails.userID;
    req.apiRequest.requestObj.remarks = 'The Loan submitted by ' + LoggedInUserDetails.userID + ' (' + currentUserRole + ').';
    if (apz.deviceType !== 'WEB') {
        apz.app.BaseScreens.UEstartTimer("WorkflowUpdate", req);
        apz.app.BaseScreens.UElogevent("WorkflowUpdate", req);
    }
    ApzCOB.serverBuildParam(gAppId, 'KMActionPostCBCheck', 'N', 'N', req, 'Y', apz.app.AddLoanDetails.kmAutoSubmitCB);
}
apz.app.AddLoanDetails.kmAutoSubmitCB = function(params) {
    window.isCBsuccess = false;
    console.log(params);
}
apz.app.AddLoanDetails.AddHouseHoldDetailsCB = function() {
    screenId = "NEWLOA__AddLoanDetails__";
    if (IncomeApp.isQuestionComplete) {
        $('#NEWLOA__AddLoanDetails__Householdrow').addClass('sno');
        $('#NEWLOA__AddLoanDetails__HouseholdBtn').addClass('sno');
        if(checkCashELafterAddQuestionary){
            if(userRole === 'KM' && window.loanProduct === "Emergency Loan" && tempDisbCashMode === 'CASH'){
            //ApzCOB.fnDisplayMsg("Ensure that the cash is handed over to the customer", "I", apz.app.AddLoanDetails.appSubmit);
            apz.app.AddLoanDetails.sendSMSLink();
            ApzCOB.fnDisplayMsg("EL application created successfully.please handover cash to member", "I", apz.app.AddLoanDetails.appSubmit);
            checkCashELafterAddQuestionary = false;
         } else {
            checkCashELafterAddQuestionary = false;
         }
        }
    } else {
        $('#NEWLOA__AddLoanDetails__Householdrow').removeClass('sno');
        $('#NEWLOA__AddLoanDetails__HouseholdBtn').removeClass('sno');
    }
}
apz.app.AddLoanDetails.sendSMSLink = function() {
        let addInfo = KendraApp.currentLoanAppRequest.applicationdtls.addInfo;
        if (typeof addInfo === "string") {
            addInfo = JSON.parse(addInfo);
        }
        const newBranchId = addInfo.branchId;
        var req = {
            "apiRequest": {
                "interfaceName": "SendSMSForSanctionReportLink",
                "appId": "APZCBO",
                "requestObj": {
                    "applicationId": KendraApp.currentLoanAppRequest.applicationdtls.applicationId,
                    "actionType": "SANCTION_REPORT_LINK_SEND",
                    "type": '',
                    "branchId": newBranchId,
                    "mobileNo": KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.mobileNum,
                    "customerName": KendraApp.currentLoanAppRequest.applicationdtls.customerName,
                    "workflowId": "SendSMSForSanctionReportLink"
                },
                "workflowId": "SendSMSForSanctionReportLink"
            }
        };
        ApzCOB.serverBuildParam(gAppId, 'WorkFlowService', 'N', 'N', req, 'Y', apz.app.AddLoanDetails.sendSMSLinkCB);
}
apz.app.AddLoanDetails.sendSMSLinkCB = function(params) {
    //apz.stopLoader();
}
apz.app.AddLoanDetails.proceedLoannew = function() {
    if (KendraApp.activeLoanDtls.length == 0) {
        apz.app.AddLoanDetails.appSubmit();
    } else {
        selectedAppObj.loanDtls.forEach(function(loan, i) {
            // console.log('closed',i);
            if ($('#' + screenId + 'el_cbx_6_' + i).prop('checked') === true) {
                if (KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].status === 'DISBURSED') {
                    customselectedPreclosureApplyLoan = true;
                    console.log('closed', i);
                    KendraApp.currentLoanAppRequest.applicationdtls.customerDtls.loanDtls.activeLoanDtls[i].status = 'CLOSED';
                }
            }
        });
        if (customselectedPreclosureApplyLoan) {
            ApzCOB.saveLoan();
        } else {
            apz.app.AddLoanDetails.appSubmit();
        }
    }
}
apz.app.AddLoanDetails.askQuestionnaire = function() {
    ApzCOB.fnDisplayMsg("The CB is passed.Do you want to add questionnaire?", "C", apz.app.AddLoanDetails.proceedCB);
    $(".ajs-button.ajs-ok").text("Yes");
    $(".ajs-button.ajs-cancel").text("No");
}
apz.app.AddLoanDetails.proceedCB = function(params) {
    if (params.choice === true) {
         if(userRole === 'KM' && window.loanProduct === "Emergency Loan" && tempDisbCashMode === 'CASH'){
             checkCashELafterAddQuestionary = true;
         }
       apz.app.AddLoanDetails.addQuestionary();
    } else {
        if (userRole === 'KM' && window.loanProduct === "Emergency Loan" && tempDisbCashMode === 'CASH') {
            setTimeout(function () {
                //ApzCOB.fnDisplayMsg("Ensure that the cash is handed over to the customer", "I",apz.app.AddLoanDetails.appSubmit);
                ApzCOB.fnDisplayMsg("EL application created successfully.please handover cash to member", "I",apz.app.AddLoanDetails.appSubmit);
            }, 300); 
        }else{
            return;
        }
    }
}
apz.app.AddLoanDetails.updatecheckBox = function(ploanAmt) {
    let age = ApzCOB.ageCalculator(KendraApp.selectedCustomer.depDob);
    if (selLoanProdObj.productDtls.spouseInsurance === "YES" && selectedAppObj.maritalStatus === 'MARRIED' && (age < 65 && age > 18)) {
        $("#NEWLOA__AddLoanDetails__sc_col_676").removeClass("sno");
    } else {
        if (!apz.isNull(selLoanProdObj.productDtls.insLnamount)) {
            if ((parseInt(selLoanProdObj.productDtls.insLnamount) <= parseInt(ploanAmt)) && selectedAppObj.maritalStatus === 'MARRIED' && (age < 65 &&
                    age > 18)) {
                $("#NEWLOA__AddLoanDetails__sc_col_676").removeClass("sno");
            } else {
                $('#NEWLOA__AddLoanDetails__spouseCheckBox').prop('checked', false);
                $("#NEWLOA__AddLoanDetails__sc_col_676").addClass("sno");
            }
        } else {
            $('#NEWLOA__AddLoanDetails__spouseCheckBox').prop('checked', false);
            $("#NEWLOA__AddLoanDetails__sc_col_676").addClass("sno");
        }
    }
}
apz.app.AddLoanDetails.saveApplication = function() {
     apz.app.AddLoanDetails.saveData();
        apz.startLoader();
        ApzCOB.saveLoan()
}
